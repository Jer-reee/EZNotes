<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EzNotes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #F3F8FF;
      color: #222;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .floating-island {
      max-width: 500px;
      margin: 2.5rem auto 0 auto;
      background: #fff;
      border-radius: 2.2rem;
      box-shadow: 0 8px 32px rgba(108,99,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      padding: 2rem 1.2rem 2rem 1.2rem;
      position: relative;
      z-index: 2;
    }
    .header {
      text-align: center;
      padding: 0 0 1rem 0;
      font-family: 'Montserrat', sans-serif;
      font-size: 2rem;
      letter-spacing: 2px;
      color: #6C63FF;
    }
    .search-bar {
      display: flex;
      align-items: center;
      margin: 0 0 1rem 0;
      background: #f7f8fc;
      border-radius: 1.5rem;
      box-shadow: 0 2px 8px rgba(108,99,255,0.04);
      padding: 0.5rem 1rem;
    }
    .search-bar input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 1rem;
      background: transparent;
      padding: 0.5rem 0;
    }
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0 0 1.5rem 0;
      align-items: center;
    }
    .chip {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      background: #E1BEE7;
      color: #6C63FF;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .chip.active {
      background: #6C63FF;
      color: #fff;
    }
    .sort-btn {
      margin-left: auto;
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      background: #6C63FF;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      transition: background 0.2s;
    }
    .sort-btn:hover {
      background: #574fd6;
    }
    .sort-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border-radius: 0.8rem;
      box-shadow: 0 4px 16px rgba(108,99,255,0.15);
      padding: 0.5rem 0;
      z-index: 10;
      min-width: 150px;
      display: none;
    }
    .sort-dropdown.show {
      display: block;
    }
    .sort-option {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.9rem;
      color: #444;
      transition: background 0.2s;
    }
    .sort-option:hover {
      background: #f7f8fc;
    }
    .notes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 0 0 2rem 0;
    }
    .note-card {
      border-radius: 1.2rem;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(108,99,255,0.07);
      font-size: 1rem;
      margin-bottom: 0.5rem;
      background: #fff;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: background 0.2s;
      cursor: pointer;
      position: relative;
    }
    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(108,99,255,0.12);
    }
    .note-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }
    .note-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }
    .note-category {
      font-size: 0.85rem;
      color: #6C63FF;
      background: #F0F0FF;
      padding: 0.2rem 0.6rem;
      border-radius: 0.8rem;
      display: inline-block;
      font-weight: 500;
    }
    .note-term-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }
    .term-tag-display {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 0.6rem;
      color: #fff;
      font-weight: 600;
    }
    .term-tag-display.short {
      background: #FF4444;
    }
    .term-tag-display.medium {
      background: #FF8800;
    }
    .term-tag-display.long {
      background: #00CC44;
    }
    .due-date-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .note-importance {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.3rem;
      font-weight: 500;
    }
    .note-card[data-urgency="1"] { background: #FFE6E6; border-left: 4px solid #FF4444; }
    .note-card[data-urgency="2"] { background: #FFF2E6; border-left: 4px solid #FF8800; }
    .note-card[data-urgency="3"] { background: #FFFBE6; border-left: 4px solid #FFCC00; }
    .note-card[data-urgency="4"] { background: #E6FFE6; border-left: 4px solid #00CC44; }
    .note-card[data-urgency="5"] { background: #E6F3FF; border-left: 4px solid #0066CC; }
    .note-card.done {
      opacity: 0.7;
      background: #f0f0f0 !important;
    }
    .calendar-placeholder {
      margin: 2rem 0 1rem 0;
      padding: 1.5rem;
      background: #E1F5FE;
      border-radius: 1.2rem;
      text-align: center;
      color: #00BFAE;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .notification-placeholder {
      margin: 1rem 0 0 0;
      padding: 1rem;
      background: #FFF6B7;
      border-radius: 1.2rem;
      text-align: center;
      color: #FF8A65;
      font-size: 1rem;
    }
    .nav-island {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      width: 320px;
      max-width: 92vw;
      height: 90px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.4s;
      opacity: 1;
      pointer-events: auto;
    }
    .nav-island.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .bottom-nav {
      position: relative;
      background: linear-gradient(90deg, #c7dbff 0%, #a7c7e7 100%);
      box-shadow: 0 4px 16px rgba(108,99,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      width: 260px;
      border-radius: 28px;
      padding: 0 24px;
      z-index: 1;
    }
    .bottom-nav .nav-btn {
      background: none;
      border: none;
      font-size: 2rem;
      color: #e7a7c7;
      transition: color 0.2s;
      cursor: pointer;
      outline: none;
      padding: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bottom-nav .nav-btn.active {
      color: #6C63FF;
    }
    .bottom-nav .nav-btn.settings {
      color: #4CAF50;
    }
    .fab {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: #5d9cff;
      color: #b3f0ff;
      border: none;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 3.2rem;
      box-shadow: 0 8px 24px rgba(108,99,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      transition: background 0.2s;
      outline: none;
    }
    .fab:active {
      background: #4d7fd6;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(60, 60, 100, 0.18);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
    }
    .modal-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .modal {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(108,99,255,0.13);
      padding: 2rem 1.2rem 1.2rem 1.2rem;
      width: 95vw;
      max-width: 400px;
      position: relative;
      z-index: 201;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      animation: modalIn 0.25s cubic-bezier(.4,1.6,.6,1) 1;
    }
    @keyframes modalIn {
      from { transform: translateY(40px) scale(0.98); opacity: 0; }
      to { transform: none; opacity: 1; }
    }
    .modal h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.3rem;
      color: #6C63FF;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
    }
    .modal label {
      font-size: 1rem;
      margin-bottom: 0.3rem;
      display: block;
      color: #444;
    }
    .modal textarea, .modal input[type="text"] {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      resize: vertical;
      font-family: inherit;
      background: #f7f8fc;
    }
    .modal .voice-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    .modal .voice-btn {
      background: #A7C7E7;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal .voice-btn.recording {
      background: #FF8A65;
      color: #fff;
    }
    .modal select {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      background: #f7f8fc;
      margin-bottom: 0.5rem;
    }
    .modal input[type="date"] {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      background: #f7f8fc;
      margin-bottom: 0.5rem;
    }
    .urgency-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    .urgency-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .urgency-dot.selected {
      border: 3px solid #6C63FF;
      box-shadow: 0 2px 8px rgba(108,99,255,0.13);
    }
    .urgency-dot[data-level="1"] { background: #FF4444; }
    .urgency-dot[data-level="2"] { background: #FF8800; }
    .urgency-dot[data-level="3"] { background: #FFCC00; }
    .urgency-dot[data-level="4"] { background: #00CC44; }
    .urgency-dot[data-level="5"] { background: #0066CC; }
    .term-tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .term-tag {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    .term-tag.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    .term-tag[data-term="short"] { border-color: #FF6B6B; color: #FF6B6B; }
    .term-tag[data-term="short"].selected { background: #FF6B6B; color: #fff; }
    .term-tag[data-term="medium"] { border-color: #FFA726; color: #FFA726; }
    .term-tag[data-term="medium"].selected { background: #FFA726; color: #fff; }
    .term-tag[data-term="long"] { border-color: #4CAF50; color: #4CAF50; }
    .term-tag[data-term="long"].selected {
      background: #4CAF50;
      color: #fff;
    }
    .category-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .category-chip {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    .category-chip.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    .category-settings-btn {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 0.5rem;
      padding: 0.2rem;
      border-radius: 0.3rem;
      transition: background 0.2s;
    }
    .category-settings-btn:hover {
      background: #f0f0f0;
    }
    .modal-btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.2rem;
    }
    .modal-btn {
      padding: 0.7rem 1.5rem;
      border-radius: 1.2rem;
      border: none;
      font-size: 1rem;
      font-family: inherit;
      cursor: pointer;
      background: #6C63FF;
      color: #fff;
      transition: background 0.2s;
    }
    .modal-btn.cancel {
      background: #e0e0e0;
      color: #444;
    }
    .modal-btn.delete {
      background: #FF6B6B;
      color: #fff;
    }
    .modal-btn.delete:hover {
      background: #e55555;
    }
    .modal-btn.delete:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    .modal-btn:active {
      background: #574fd6;
    }
    /* Settings Modal Styles */
    .settings-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }
    .settings-section h3 {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 0.8rem;
      font-family: 'Montserrat', sans-serif;
    }
    .urgency-settings {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .urgency-setting {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      color: #444;
    }
    .urgency-setting select {
      width: 120px;
      padding: 0.4rem;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      background: #f7f8fc;
    }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 0.95rem;
      color: #444;
    }
    .switch {
      position: relative;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #6C63FF;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #6C63FF;
    }
    input:checked + .slider:before {
      -webkit-transform: translateX(20px);
      -ms-transform: translateX(20px);
      transform: translateX(20px);
    }
    
    /* Dark Mode Styles */
    body.dark-mode {
      background: #1a1a2e;
      color: #e0e0e0;
    }
    
    body.dark-mode .floating-island {
      background: #16213e;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 1.5px 8px rgba(0,0,0,0.2);
    }
    
    body.dark-mode .header {
      color: #64b5f6;
    }
    
    body.dark-mode .header span {
      color: #90a4ae;
    }
    
    body.dark-mode .search-bar {
      background: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    body.dark-mode .search-bar input {
      background: transparent;
      color: #000000;
    }
    
    body.dark-mode .search-bar input::placeholder {
      color: #666666;
    }
    
    body.dark-mode .chip {
      background: #37474f;
      color: #b0bec5;
      border-color: #546e7a;
    }
    
    body.dark-mode .chip.active {
      background: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .note-card {
      background: #2c3e50;
      border-color: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .note-title {
      color: #e0e0e0;
    }
    
    body.dark-mode .note-category {
      background: #37474f;
      color: #81c784;
    }
    
    body.dark-mode .term-tag-display.short {
      background: #e57373;
      color: #fff;
    }
    
    body.dark-mode .term-tag-display.medium {
      background: #ffb74d;
      color: #fff;
    }
    
    body.dark-mode .term-tag-display.long {
      background: #81c784;
      color: #fff;
    }
    
    body.dark-mode .due-date-text {
      color: #b0bec5;
    }
    
    body.dark-mode .bottom-nav {
      background: linear-gradient(90deg, #2c3e50 0%, #34495e 100%);
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    }
    
    body.dark-mode .fab {
      background: #546e7a;
      color: #e0e0e0;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    body.dark-mode .fab:active {
      background: #455a64;
    }
    
    body.dark-mode .modal {
      background: #2c3e50;
      color: #e0e0e0;
    }
    
    body.dark-mode .modal h2 {
      color: #64b5f6;
    }
    
    body.dark-mode .modal label {
      color: #b0bec5;
    }
    
    body.dark-mode .modal textarea,
    body.dark-mode .modal input[type="text"],
    body.dark-mode .modal select,
    body.dark-mode .modal input[type="date"] {
      background: #37474f;
      border-color: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .modal textarea::placeholder,
    body.dark-mode .modal input::placeholder {
      color: #90a4ae;
    }
    
    body.dark-mode .modal-btn {
      background: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .modal-btn:hover {
      background: #455a64;
    }
    
    body.dark-mode .modal-btn.cancel {
      background: #37474f;
      color: #b0bec5;
    }
    
    body.dark-mode .modal-btn.delete {
      background: #e57373;
      color: #fff;
    }
    
    body.dark-mode .modal-btn.delete:hover {
      background: #ef5350;
    }
    
    body.dark-mode .urgency-dot {
      border-color: #00ffff;
    }
    
    body.dark-mode .category-chip {
      background: #0f3460;
      color: #00ffff;
      border-color: #00ffff;
    }
    
    body.dark-mode .category-chip.selected {
      background: #00ffff;
      color: #1a1a2e;
    }
    
    body.dark-mode .term-tag {
      background: #0f3460;
      color: #00ffff;
      border-color: #00ffff;
    }
    
    body.dark-mode .term-tag.selected {
      background: #00ffff;
      color: #1a1a2e;
    }
    
    body.dark-mode .sort-btn {
      background: #0f3460;
      color: #00ffff;
      border-color: #00ffff;
    }
    
    body.dark-mode .sort-dropdown {
      background: #16213e;
      border-color: #00ffff;
    }
    
    body.dark-mode .sort-option {
      color: #fff;
    }
    
    body.dark-mode .sort-option:hover {
      background: #0f3460;
    }
    body.dark-mode .note-card[data-urgency="1"] { background: #2D1B1B; border-left: 4px solid #FF4444; color: #fff; }
    body.dark-mode .note-card[data-urgency="2"] { background: #2D241B; border-left: 4px solid #FF8800; color: #fff; }
    body.dark-mode .note-card[data-urgency="3"] { background: #2D2A1B; border-left: 4px solid #FFCC00; color: #fff; }
    body.dark-mode .note-card[data-urgency="4"] { background: #1B2D1B; border-left: 4px solid #00CC44; color: #fff; }
    body.dark-mode .note-card[data-urgency="5"] { background: #1B1B2D; border-left: 4px solid #0066CC; color: #fff; }

    /* Category Management Modal Styles */
    .category-management-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .category-management-section h3 {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 0.8rem;
      font-family: 'Montserrat', sans-serif;
    }
    
    .add-category-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .add-category-form input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }
    
    .existing-categories {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f7f8fc;
      border-radius: 0.5rem;
      border: 1px solid #e0e0e0;
    }
    
    .category-item span {
      font-size: 0.9rem;
      color: #444;
    }
    
    .delete-btn {
      background: #FF6B6B;
      color: #fff;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .delete-btn:hover {
      background: #e55555;
    }
    
    /* Dark Mode Category Management */
    body.dark-mode .category-management-section h3 {
      color: #e0e0e0;
    }
    
    body.dark-mode .add-category-form input {
      background: #37474f;
      border-color: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .category-item {
      background: #37474f;
      border-color: #546e7a;
    }
    
    body.dark-mode .category-item span {
      color: #e0e0e0;
    }
    
    /* Calendar Modal Styles */
    .calendar-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
    }
    
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    
    .calendar-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .calendar-nav {
      display: flex;
      gap: 1rem;
    }
    
    .calendar-nav-btn {
      background: #6C63FF;
      color: #fff;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    
    .calendar-nav-btn:hover {
      background: #574fd6;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #f0f0f0;
      border-radius: 0.5rem;
      overflow: hidden;
      flex: 1;
      margin: 0 2rem 2rem 2rem;
    }
    
    .calendar-day-header {
      background: #f8f9fa;
      padding: 1rem 0.5rem;
      text-align: center;
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .calendar-day {
      background: #fff;
      min-height: 80px;
      padding: 0.5rem;
      border-right: 1px solid #f0f0f0;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }
    
    .calendar-day:last-child {
      border-right: none;
    }
    
    .calendar-day-number {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }
    
    .calendar-day-content {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    
    .calendar-task {
      background: #e3f2fd;
      color: #1976d2;
      padding: 0.3rem 0.5rem;
      border-radius: 0.3rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .calendar-task:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-task.work { background: #fff3e0; color: #f57c00; }
    .calendar-task.personal { background: #e8f5e8; color: #388e3c; }
    .calendar-task.school { background: #f3e5f5; color: #7b1fa2; }
    .calendar-task.home { background: #fce4ec; color: #c2185b; }
    .calendar-task.other { background: #f5f5f5; color: #616161; }
    
    /* Dark Mode Calendar Styles */
    body.dark-mode .calendar-content {
      background: #16213e;
      color: #fff;
    }
    
    body.dark-mode .calendar-title {
      color: #fff;
    }
    
    body.dark-mode .calendar-day-header {
      background: #0f3460;
      color: #00ffff;
      border-bottom-color: #333;
    }
    
    body.dark-mode .calendar-day {
      background: #16213e;
      border-color: #333;
    }
    
    body.dark-mode .calendar-day-number {
      color: #fff;
    }
    
    body.dark-mode .calendar-task {
      background: #0f3460;
      color: #00ffff;
    }
    
    body.dark-mode .calendar-task.work { background: #2d1b0f; color: #ffaa00; }
    body.dark-mode .calendar-task.personal { background: #0f2f0f; color: #4caf50; }
    body.dark-mode .calendar-task.school { background: #2d0f2f; color: #ba68c8; }
    body.dark-mode .calendar-task.home { background: #2f0f1f; color: #f06292; }
    body.dark-mode .calendar-task.other { background: #1f1f1f; color: #9e9e9e; }
    
    /* Calendar task importance colors */
    .calendar-task[data-importance="1"] { 
      color: #4caf50 !important; 
      background: rgba(76, 175, 80, 0.1) !important;
      border-left: 3px solid #4caf50 !important;
    }
    .calendar-task[data-importance="2"] { 
      color: #ff9800 !important; 
      background: rgba(255, 152, 0, 0.1) !important;
      border-left: 3px solid #ff9800 !important;
    }
    .calendar-task[data-importance="3"] { 
      color: #ffc107 !important; 
      background: rgba(255, 193, 7, 0.1) !important;
      border-left: 3px solid #ffc107 !important;
    }
    .calendar-task[data-importance="4"] { 
      color: #f44336 !important; 
      background: rgba(244, 67, 54, 0.1) !important;
      border-left: 3px solid #f44336 !important;
    }
    .calendar-task[data-importance="5"] { 
      color: #d32f2f !important; 
      background: rgba(211, 47, 47, 0.1) !important;
      border-left: 3px solid #d32f2f !important;
    }
    
    body.dark-mode .calendar-task[data-importance="1"] { 
      color: #4caf50 !important; 
      background: rgba(76, 175, 80, 0.2) !important;
      border-left: 3px solid #4caf50 !important;
    }
    body.dark-mode .calendar-task[data-importance="2"] { 
      color: #ff9800 !important; 
      background: rgba(255, 152, 0, 0.2) !important;
      border-left: 3px solid #ff9800 !important;
    }
    body.dark-mode .calendar-task[data-importance="3"] { 
      color: #ffc107 !important; 
      background: rgba(255, 193, 7, 0.2) !important;
      border-left: 3px solid #ffc107 !important;
    }
    body.dark-mode .calendar-task[data-importance="4"] { 
      color: #f44336 !important; 
      background: rgba(244, 67, 54, 0.2) !important;
      border-left: 3px solid #f44336 !important;
    }
    body.dark-mode .calendar-task[data-importance="5"] { 
      color: #d32f2f !important; 
      background: rgba(211, 47, 47, 0.2) !important;
      border-left: 3px solid #d32f2f !important;
    }

    .note-card[data-importance="1"] { background: #E8F5E8; border-left: 4px solid #00CC44; }
    .note-card[data-importance="2"] { background: #FFF2E6; border-left: 4px solid #FF8800; }
    .note-card[data-importance="3"] { background: #FFE0B2; border-left: 4px solid #FFCC00; }
    .note-card[data-importance="4"] { background: #FFCCCC; border-left: 4px solid #FF4444; }
    .note-card[data-importance="5"] { background: #FFB3B3; border-left: 4px solid #CC0000; }
    
    /* Dark Mode Importance Note Cards */
    body.dark-mode .note-card[data-importance="1"] { background: #0f2f0f; border-left: 4px solid #4caf50; }
    body.dark-mode .note-card[data-importance="2"] { background: #2d1b0f; border-left: 4px solid #ffaa00; }
    body.dark-mode .note-card[data-importance="3"] { background: #2d2d0f; border-left: 4px solid #ffcc00; }
    body.dark-mode .note-card[data-importance="4"] { background: #2f0f0f; border-left: 4px solid #ff4444; }
    body.dark-mode .note-card[data-importance="5"] { background: #2f0000; border-left: 4px solid #cc0000; }
    
    body.dark-mode .note-importance {
      color: #ccc;
    }
    
    /* Importance Dot Styles */
    .importance-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    
    .importance-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      transition: border 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .importance-dot.selected {
      border: 3px solid #6C63FF;
      box-shadow: 0 2px 8px rgba(108,99,255,0.13);
    }
    
    .importance-dot[data-level="1"] { 
      background: #2e7d32; 
      border-color: #4caf50;
    }
    .importance-dot[data-level="2"] { 
      background: #f57c00; 
      border-color: #ff9800;
    }
    .importance-dot[data-level="3"] { 
      background: #f9a825; 
      border-color: #ffc107;
    }
    .importance-dot[data-level="4"] { 
      background: #d32f2f; 
      border-color: #f44336;
    }
    .importance-dot[data-level="5"] { 
      background: #b71c1c; 
      border-color: #d32f2f;
    }
    
    .importance-dot[data-level="1"]:after { color: #4caf50; }
    .importance-dot[data-level="2"]:after { color: #ff9800; }
    .importance-dot[data-level="3"]:after { color: #ffc107; }
    .importance-dot[data-level="4"]:after { color: #f44336; }
    .importance-dot[data-level="5"]:after { color: #d32f2f; }
    
    /* Dark Mode Importance Dots */
    body.dark-mode .importance-dot[data-level="1"] { 
      background: #0f2f0f; 
      border-color: #4caf50;
    }
    body.dark-mode .importance-dot[data-level="2"] { 
      background: #2d1b0f; 
      border-color: #ffaa00;
    }
    body.dark-mode .importance-dot[data-level="3"] { 
      background: #2d2d0f; 
      border-color: #ffcc00;
    }
    body.dark-mode .importance-dot[data-level="4"] { 
      background: #2f0f0f; 
      border-color: #ff4444;
    }
    body.dark-mode .importance-dot[data-level="5"] { 
      background: #2f0000; 
      border-color: #cc0000;
    }
    
    body.dark-mode .importance-dot[data-level="1"]:after { color: #4caf50; }
    body.dark-mode .importance-dot[data-level="2"]:after { color: #ff9800; }
    body.dark-mode .importance-dot[data-level="3"]:after { color: #ffc107; }
    body.dark-mode .importance-dot[data-level="4"]:after { color: #f44336; }
    body.dark-mode .importance-dot[data-level="5"]:after { color: #d32f2f; }
    
    /* Done Note Styles */
    .note-card.done {
      opacity: 0.6;
      background: #f8f9fa;
      border-left: 4px solid #28a745;
    }
    
    .note-card.done .note-title {
      text-decoration: line-through;
      color: #6c757d;
    }
    
    /* Dark Mode Done Notes */
    body.dark-mode .note-card.done {
      background: #1b5e20;
      opacity: 0.8;
      border-left-color: #4caf50;
    }
    
    body.dark-mode .note-card.done .note-title {
      color: #90a4ae;
    }
    
    /* Delete hint for done notes */
    .note-delete-hint {
      font-size: 0.75rem;
      color: #28a745;
      margin-top: 0.3rem;
      font-weight: 500;
      font-style: italic;
    }
    
    body.dark-mode .note-delete-hint {
      color: #4caf50;
    }
    
    /* Drag and Drop Styles for Filter Chips */
    .chip {
      transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .chip.dragging {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(108,99,255,0.3);
      z-index: 1000;
    }
    
    .chip.drop-zone {
      transform: scale(1.05);
      background-color: #e3f2fd;
      border-color: #6C63FF;
    }
    
    .chip.drop-zone.dark-mode {
      background-color: #37474f;
      border-color: #546e7a;
    }
    
    /* Drag indicator */
    #dragIndicator {
      pointer-events: none;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Prevent text selection during drag */
    .filter-chips {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Long-press hint */
    .chip::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 4px;
      height: 4px;
      background: rgba(108,99,255,0.3);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .chip:hover::after {
      opacity: 1;
    }
    
    /* Calendar Modal Styles */
  </style>
</head>
<body>
  <div class="floating-island">
    <div class="header">EZ<span style="color:#222;">Habits</span></div>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search for notes" />
    </div>
    <div class="filter-chips" id="filterChips" style="position: relative;">
      <div id="chipContainer"></div>
      <button class="sort-btn" id="sortBtn">Sort ▼</button>
      <div class="sort-dropdown" id="sortDropdown">
        <button class="sort-option" data-sort="date-asc">Due Date (Earliest First)</button>
        <button class="sort-option" data-sort="date-desc">Due Date (Latest First)</button>
        <button class="sort-option" data-sort="term-asc">Term (Short to Long)</button>
        <button class="sort-option" data-sort="term-desc">Term (Long to Short)</button>
        <button class="sort-option" data-sort="importance-asc">Importance (Low to High)</button>
        <button class="sort-option" data-sort="importance-desc">Importance (High to Low)</button>
        <button class="sort-option" data-sort="added-desc">Time Added (Newest First)</button>
        <button class="sort-option" data-sort="added-asc">Time Added (Oldest First)</button>
      </div>
    </div>
    <div class="notes-grid" id="notesGrid"></div>
  </div>
  <div class="nav-island" id="navIsland">
    <nav class="bottom-nav">
      <button class="nav-btn" title="Calendar"> <span style="color:#e7a7c7;">&#128197;</span> </button>
      <div style="width:68px;"></div>
      <button class="nav-btn settings" title="Settings"> <span style="color:#4CAF50;">&#9881;&#65039;</span> </button>
    </nav>
  </div>
  <button class="fab" id="openModalBtn" title="Add Note">+</button>
  <!-- Modal for adding a note -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <form class="modal" id="addNoteModal">
      <h2>Add Note</h2>
      <label for="noteText">Note</label>
      <div class="voice-row">
        <textarea id="noteText" rows="3" placeholder="Type your note..."></textarea>
        <button type="button" class="voice-btn" id="voiceBtn" title="Record voice note">🎤</button>
      </div>
      <label for="timeframe">Timeframe</label>
      <select id="timeframe" onchange="toggleCustomDate()">
        <option value="1">1 day</option>
        <option value="5">5 days</option>
        <option value="10">10 days</option>
        <option value="30">30 days</option>
        <option value="90">90 days</option>
        <option value="custom">Custom date</option>
      </select>
      <div id="customDateContainer" style="display: none;">
        <label for="customDate">Due Date</label>
        <input type="date" id="customDate" style="box-sizing: border-box;">
      </div>
      <label>Term Tags</label>
      <div class="term-tags-row" id="termTagsRow">
        <button type="button" class="term-tag" data-term="short">Short-term</button>
        <button type="button" class="term-tag" data-term="medium">Medium-term</button>
        <button type="button" class="term-tag" data-term="long">Long-term</button>
      </div>
      <label>Importance</label>
      <div class="importance-row" id="importanceRow">
        <div class="importance-dot" data-level="1" title="1 (Low)"></div>
        <div class="importance-dot" data-level="2" title="2"></div>
        <div class="importance-dot" data-level="3" title="3"></div>
        <div class="importance-dot" data-level="4" title="4"></div>
        <div class="importance-dot" data-level="5" title="5 (High)"></div>
      </div>
      <label>Categories <button type="button" class="category-settings-btn" id="categorySettingsBtn" title="Manage categories">⚙️</button></label>
      <div class="category-row" id="categoryRow">
        <button type="button" class="category-chip" data-category="School">School</button>
        <button type="button" class="category-chip" data-category="Home">Home</button>
        <button type="button" class="category-chip" data-category="Work">Work</button>
        <button type="button" class="category-chip" data-category="Personal">Personal</button>
        <button type="button" class="category-chip" data-category="Other">Other</button>
      </div>
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelModalBtn">Cancel</button>
        <button type="submit" class="modal-btn">Save</button>
      </div>
    </form>
  </div>
  <!-- Edit Modal -->
  <div class="modal-overlay hidden" id="editModalOverlay">
    <form class="modal" id="editNoteModal">
      <h2 id="editModalTitle">Edit Note</h2>
      <label for="editNoteText">Note</label>
      <div class="voice-row">
        <textarea id="editNoteText" rows="3" placeholder="Type your note..."></textarea>
        <button type="button" class="voice-btn" id="editVoiceBtn" title="Record voice note">🎤</button>
      </div>
      <label for="editTimeframe">Timeframe</label>
      <select id="editTimeframe" onchange="toggleEditCustomDate()">
        <option value="1">1 day</option>
        <option value="5">5 days</option>
        <option value="10">10 days</option>
        <option value="30">30 days</option>
        <option value="90">90 days</option>
        <option value="custom">Custom date</option>
      </select>
      <div id="editCustomDateContainer" style="display: none;">
        <label for="editCustomDate">Due Date</label>
        <input type="date" id="editCustomDate" style="box-sizing: border-box;">
      </div>
      <label>Term Tags</label>
      <div class="term-tags-row" id="editTermTagsRow">
        <button type="button" class="term-tag" data-term="short">Short-term</button>
        <button type="button" class="term-tag" data-term="medium">Medium-term</button>
        <button type="button" class="term-tag" data-term="long">Long-term</button>
      </div>
      <label>Importance</label>
      <div class="importance-row" id="editImportanceRow">
        <div class="importance-dot" data-level="1" title="1 (Low)"></div>
        <div class="importance-dot" data-level="2" title="2"></div>
        <div class="importance-dot" data-level="3" title="3"></div>
        <div class="importance-dot" data-level="4" title="4"></div>
        <div class="importance-dot" data-level="5" title="5 (High)"></div>
      </div>
      <label>Categories <button type="button" class="category-settings-btn" id="editCategorySettingsBtn" title="Manage categories">⚙️</button></label>
      <div class="category-row" id="editCategoryRow">
        <button type="button" class="category-chip" data-category="School">School</button>
        <button type="button" class="category-chip" data-category="Home">Home</button>
        <button type="button" class="category-chip" data-category="Work">Work</button>
        <button type="button" class="category-chip" data-category="Personal">Personal</button>
        <button type="button" class="category-chip" data-category="Other">Other</button>
      </div>
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelEditModalBtn">Cancel</button>
        <button type="button" class="modal-btn delete" id="deleteNoteBtn" style="display: none;">Delete</button>
        <button type="button" class="modal-btn" id="markDoneBtn" style="display: none;">Mark as Done</button>
        <button type="submit" class="modal-btn">Save</button>
      </div>
    </form>
  </div>
  <!-- Settings Modal -->
  <div class="modal-overlay hidden" id="settingsModalOverlay">
    <div class="modal" id="settingsModal">
      <h2>Settings</h2>
      
      <div class="settings-section">
        <h3>Notifications</h3>
        <label for="notificationSound">Notification Sound</label>
        <select id="notificationSound">
          <option value="default">Default</option>
          <option value="gentle">Gentle</option>
          <option value="urgent">Urgent</option>
          <option value="custom">Custom</option>
        </select>
        
        <label>Notification Frequency by Urgency</label>
        <div class="urgency-settings">
          <div class="urgency-setting">
            <span>High Urgency (1 day)</span>
            <select id="highUrgencyFreq">
              <option value="immediate">Immediate</option>
              <option value="hourly">Hourly</option>
              <option value="daily">Daily</option>
            </select>
          </div>
          <div class="urgency-setting">
            <span>Medium Urgency (5-10 days)</span>
            <select id="mediumUrgencyFreq">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
            </select>
          </div>
          <div class="urgency-setting">
            <span>Low Urgency (30+ days)</span>
            <select id="lowUrgencyFreq">
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="settings-section">
        <h3>Appearance</h3>
        <div class="theme-toggle">
          <span>Dark Mode</span>
          <label class="switch">
            <input type="checkbox" id="darkModeToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelSettingsBtn">Cancel</button>
        <button type="button" class="modal-btn" id="saveSettingsBtn">Save</button>
      </div>
    </div>
  </div>
  <!-- Category Management Modal -->
  <div class="modal-overlay hidden" id="categoryModalOverlay">
    <div class="modal" id="categoryModal">
      <h2>Manage Categories</h2>
      
      <div class="category-management-section">
        <h3>Add New Category</h3>
        <div class="add-category-form">
          <input type="text" id="newCategoryInput" placeholder="Enter category name" maxlength="20">
          <button type="button" class="modal-btn" id="addCategoryBtn">Add</button>
        </div>
      </div>
      
      <div class="category-management-section">
        <h3>Existing Categories</h3>
        <div class="existing-categories" id="existingCategories">
          <!-- Categories will be populated here -->
        </div>
      </div>
      
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelCategoryBtn">Close</button>
      </div>
    </div>
  </div>
  <!-- Calendar Modal -->
  <div class="modal-overlay hidden" id="calendarModalOverlay">
    <div class="calendar-modal">
      <div class="calendar-header">
        <h2 class="calendar-title" id="calendarTitle">Calendar</h2>
        <div class="calendar-nav">
          <button class="calendar-nav-btn" id="prevMonthBtn">&lt;</button>
          <button class="calendar-nav-btn" id="nextMonthBtn">&gt;</button>
          <button class="calendar-nav-btn" id="closeCalendarBtn">Close</button>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar content will be generated by JavaScript -->
      </div>
    </div>
  </div>
  <script>
    // Modal open/close logic
    const openModalBtn = document.getElementById('openModalBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const addNoteModal = document.getElementById('addNoteModal');
    const noteText = document.getElementById('noteText');
    const timeframeSelect = document.getElementById('timeframe');
    
    // Modal event handlers
    cancelModalBtn.onclick = () => { 
      console.log('Closing add modal');
      modalOverlay.classList.add('hidden'); 
    };
    
    modalOverlay.onclick = (e) => {
      if (e.target === modalOverlay) {
        console.log('Closing modal via overlay click');
        modalOverlay.classList.add('hidden');
      }
    };

    // Sort functionality
    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');
    let currentSort = localStorage.getItem('currentSort') || 'added-desc';
    
    // Set initial button text based on saved preference
    function updateSortButtonText() {
      const sortOptions = {
        'date-asc': 'Due Date',
        'date-desc': 'Due Date',
        'term-asc': 'Term',
        'term-desc': 'Term',
        'importance-asc': 'Importance',
        'importance-desc': 'Importance',
        'added-desc': 'Time Added',
        'added-asc': 'Time Added'
      };
      sortBtn.textContent = `Sort: ${sortOptions[currentSort]} ▼`;
    }
    
    // Load sort preference on startup
    updateSortButtonText();
    
    sortBtn.onclick = () => {
      sortDropdown.classList.toggle('show');
    };
    
    document.addEventListener('click', (e) => {
      if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
        sortDropdown.classList.remove('show');
      }
    });
    
    sortDropdown.onclick = (e) => {
      if (e.target.classList.contains('sort-option')) {
        currentSort = e.target.getAttribute('data-sort');
        localStorage.setItem('currentSort', currentSort);
        updateSortButtonText();
        sortDropdown.classList.remove('show');
        renderNotes();
      }
    };

    // Urgency selection (removed - now automatic)
    // Category selection (multiple selection allowed)
    const categoryRow = document.getElementById('categoryRow');
    categoryRow.onclick = (e) => {
      if (e.target.classList.contains('category-chip')) {
        e.target.classList.toggle('selected');
      }
    };

    // Term tag selection (single selection only)
    const termTagsRow = document.getElementById('termTagsRow');
    termTagsRow.onclick = (e) => {
      if (e.target.classList.contains('term-tag')) {
        [...termTagsRow.children].forEach(tag => tag.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Importance selection (single selection only)
    const importanceRow = document.getElementById('importanceRow');
    importanceRow.onclick = (e) => {
      console.log('Add importance clicked:', e.target);
      console.log('Target classList:', e.target.classList);
      if (e.target.classList.contains('importance-dot')) {
        console.log('Add importance dot clicked, level:', e.target.getAttribute('data-level'));
        [...importanceRow.children].forEach(dot => dot.classList.remove('selected'));
        e.target.classList.add('selected');
        console.log('Importance dot selected:', e.target.classList.contains('selected'));
      }
    };

    // Voice input (Web Speech API)
    const voiceBtn = document.getElementById('voiceBtn');
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = function(event) {
        noteText.value += (noteText.value ? ' ' : '') + event.results[0][0].transcript;
        voiceBtn.classList.remove('recording');
      };
      recognition.onend = function() {
        voiceBtn.classList.remove('recording');
      };
    }
    voiceBtn.onclick = function(e) {
      e.preventDefault();
      if (recognition) {
        if (voiceBtn.classList.contains('recording')) {
          recognition.stop();
          voiceBtn.classList.remove('recording');
        } else {
          recognition.start();
          voiceBtn.classList.add('recording');
        }
      } else {
        alert('Voice input not supported in this browser.');
      }
    };

    // Notes state and rendering
    let notes = [];
    let categories = new Set();
    let activeCategory = 'All';
    const notesGrid = document.getElementById('notesGrid');
    const filterChips = document.getElementById('filterChips');
    const searchInput = document.getElementById('searchInput');

    // Load notes from localStorage on page load
    function loadNotes() {
      const savedNotes = localStorage.getItem('eznotes_notes');
      if (savedNotes) {
        notes = JSON.parse(savedNotes);
        // Comprehensive data migration for all notes
        notes.forEach(note => {
          // Ensure all required fields exist
          if (!note.id) {
            note.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
          }
          if (!note.createdAt) {
            note.createdAt = new Date().toISOString();
          }
          if (note.done === undefined) {
            note.done = false;
          }
          if (!note.termTags) {
            note.termTags = [];
          }
          if (!note.importance) {
            note.importance = '3';
          }
          if (!note.text) {
            note.text = note.content || note.note || 'Untitled Note'; // Handle old field names
          }
          if (!note.title) {
            note.title = aiGenerateTitle(note.text);
          }
          if (!note.category) {
            note.category = 'Other';
          }
          if (!note.urgency) {
            note.urgency = 3; // Default to medium urgency
          }
          if (!note.timeframe) {
            note.timeframe = '5 days'; // Default timeframe
          }
          
          // Ensure customDate field exists and is properly handled
          if (!note.hasOwnProperty('customDate')) {
            note.customDate = null;
          }
          
          // Ensure all fields are of correct type
          note.id = String(note.id);
          note.text = String(note.text);
          note.title = String(note.title);
          note.category = String(note.category);
          note.urgency = parseInt(note.urgency) || 3;
          note.timeframe = String(note.timeframe);
          note.termTags = Array.isArray(note.termTags) ? note.termTags : [];
          note.done = Boolean(note.done);
          
          // Validate urgency range
          if (note.urgency < 1 || note.urgency > 5) {
            note.urgency = 3;
          }
        });
        
        // Rebuild categories set
        categories.clear();
        notes.forEach(note => {
          if (note.category && note.category !== '') {
            categories.add(note.category);
          }
        });
        
        // Save migrated data
        saveNotes();
      }
    }

    // Save notes to localStorage
    function saveNotes() {
      localStorage.setItem('eznotes_notes', JSON.stringify(notes));
      localStorage.setItem('eznotes_version', '1.2'); // Track current data version
    }
    
    // Check and migrate data version
    function checkDataVersion() {
      const currentVersion = '1.2';
      const savedVersion = localStorage.getItem('eznotes_version');
      
      if (savedVersion !== currentVersion) {
        console.log(`Migrating data from version ${savedVersion} to ${currentVersion}`);
        // Future migrations can be added here
        localStorage.setItem('eznotes_version', currentVersion);
      }
    }

    function toggleCustomDate() {
      console.log('toggleCustomDate called');
      const timeframe = document.getElementById('timeframe');
      const customDateContainer = document.getElementById('customDateContainer');
      console.log('Timeframe value:', timeframe.value);
      if (timeframe.value === 'custom') {
        console.log('Showing custom date container');
        customDateContainer.style.display = 'block';
      } else {
        console.log('Hiding custom date container');
        customDateContainer.style.display = 'none';
      }
    }

    function toggleEditCustomDate() {
      console.log('toggleEditCustomDate called');
      const timeframe = document.getElementById('editTimeframe');
      const customDateContainer = document.getElementById('editCustomDateContainer');
      console.log('Edit timeframe value:', timeframe.value);
      if (timeframe.value === 'custom') {
        console.log('Showing edit custom date container');
        customDateContainer.style.display = 'block';
      } else {
        console.log('Hiding edit custom date container');
        customDateContainer.style.display = 'none';
      }
    }

    function formatTimeframe(note) {
      // Handle custom dates
      if (note.timeframe === 'custom' && note.customDate) {
        const dueDate = new Date(note.customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (days === 1) return 'Due tomorrow';
        if (days === 0) return 'Due today';
        if (days < 0) return 'Overdue';
        return `Due in ${days} days`;
      }
      
      // Handle regular timeframes
      const timeframe = note.timeframe;
      if (timeframe.includes('Due ')) {
        const dateStr = timeframe.match(/Due (.+?) \(/)[1];
        const daysStr = timeframe.match(/\((\d+) days?\)/)[1];
        const days = parseInt(daysStr);
        
        if (days === 1) return 'Due tomorrow';
        if (days === 0) return 'Due today';
        if (days < 0) return 'Overdue';
        return `Due in ${days} days`;
      }
      
      const days = parseInt(timeframe);
      if (days === 1) return 'Due tomorrow';
      if (days === 0) return 'Due today';
      return `Due in ${days} days`;
    }

    function aiGenerateTitle(text) {
      // Simple AI-like title: first 5 words or up to 30 chars, capitalized
      if (!text) return 'Untitled Note';
      let words = text.trim().split(/\s+/).slice(0, 5).join(' ');
      if (words.length > 30) words = words.slice(0, 30) + '...';
      return words.charAt(0).toUpperCase() + words.slice(1);
    }

    function sortNotes(notesToSort) {
      switch (currentSort) {
        case 'date-asc':
          return notesToSort.sort((a, b) => {
            let aDays, bDays;
            
            // Handle custom dates
            if (a.timeframe === 'custom' && a.customDate) {
              const dueDate = new Date(a.customDate);
              const today = new Date();
              aDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (a.timeframe.includes('Due ')) {
              aDays = parseInt(a.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              aDays = parseInt(a.timeframe);
            }
            
            if (b.timeframe === 'custom' && b.customDate) {
              const dueDate = new Date(b.customDate);
              const today = new Date();
              bDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (b.timeframe.includes('Due ')) {
              bDays = parseInt(b.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              bDays = parseInt(b.timeframe);
            }
            
            return aDays - bDays;
          });
        case 'date-desc':
          return notesToSort.sort((a, b) => {
            let aDays, bDays;
            
            // Handle custom dates
            if (a.timeframe === 'custom' && a.customDate) {
              const dueDate = new Date(a.customDate);
              const today = new Date();
              aDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (a.timeframe.includes('Due ')) {
              aDays = parseInt(a.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              aDays = parseInt(a.timeframe);
            }
            
            if (b.timeframe === 'custom' && b.customDate) {
              const dueDate = new Date(b.customDate);
              const today = new Date();
              bDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (b.timeframe.includes('Due ')) {
              bDays = parseInt(b.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              bDays = parseInt(b.timeframe);
            }
            
            return bDays - aDays;
          });
        case 'term-asc':
          return notesToSort.sort((a, b) => {
            const termA = a.termTag || (a.termTags && a.termTags[0]) || 'medium';
            const termB = b.termTag || (b.termTags && b.termTags[0]) || 'medium';
            const termOrder = { 'short': 1, 'medium': 2, 'long': 3 };
            return (termOrder[termA] || 2) - (termOrder[termB] || 2);
          });
        case 'term-desc':
          return notesToSort.sort((a, b) => {
            const termA = a.termTag || (a.termTags && a.termTags[0]) || 'medium';
            const termB = b.termTag || (b.termTags && b.termTags[0]) || 'medium';
            const termOrder = { 'short': 1, 'medium': 2, 'long': 3 };
            return (termOrder[termB] || 2) - (termOrder[termA] || 2);
          });
        case 'importance-asc':
          return notesToSort.sort((a, b) => a.importance - b.importance);
        case 'importance-desc':
          return notesToSort.sort((a, b) => b.importance - a.importance);
        case 'added-desc':
          return notesToSort.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        case 'added-asc':
          return notesToSort.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        case 'urgency':
        default:
          return notesToSort.sort((a, b) => b.urgency - a.urgency);
      }
    }

    function renderNotes() {
      let filtered = notes;
      if (activeCategory === 'All') {
        filtered = filtered.filter(n => !n.done);
      } else if (activeCategory === 'Done') {
        filtered = filtered.filter(n => n.done);
      } else {
        filtered = filtered.filter(n => n.category === activeCategory && !n.done);
      }
      
      if (searchInput.value.trim()) {
        const q = searchInput.value.trim().toLowerCase();
        filtered = filtered.filter(n => n.text.toLowerCase().includes(q) || n.title.toLowerCase().includes(q));
      }
      
      filtered = sortNotes(filtered);
      
      notesGrid.innerHTML = filtered.map(note => `
        <div class="note-card ${note.done ? 'done' : ''}" data-importance="${note.importance || '3'}" data-urgency="${note.urgency}" data-id="${note.id}">
          <div class="note-title">${note.title}</div>
          <div class="note-categories">
            ${(note.categories || [note.category || 'Other']).map(cat => `<span class="note-category">${cat}</span>`).join('')}
          </div>
          <div class="note-term-tags">
            <span class="term-tag-display ${note.termTag || (note.termTags && note.termTags[0]) || 'medium'}">${note.termTag || (note.termTags && note.termTags[0]) || 'medium'}</span>
          </div>
          <div class="note-importance">Importance: ${note.importance || '3'}</div>
          <div class="due-date-text">${formatTimeframe(note)}</div>
          ${note.done ? '<div class="note-delete-hint">✓ Can be deleted</div>' : ''}
        </div>
      `).join('');
    }

    function renderChips() {
      // Get custom category order from localStorage
      let categoryOrder = JSON.parse(localStorage.getItem('categoryOrder')) || ['All', 'Done'];
      
      // Add any new categories that aren't in the order yet
      categories.forEach(cat => {
        if (!categoryOrder.includes(cat)) {
          categoryOrder.push(cat);
        }
      });
      
      // Filter to only show categories that exist
      const validCategories = categoryOrder.filter(cat => 
        cat === 'All' || cat === 'Done' || categories.has(cat)
      );
      
      const chipContainer = document.getElementById('chipContainer');
      chipContainer.innerHTML = validCategories.map(cat => 
        `<button class="chip${activeCategory === cat ? ' active' : ''}" data-cat="${cat}">${cat}</button>`
      ).join('');
    }

    // Initialize app
    loadNotes();
    renderNotes();
    renderChips();
    updateSortButtonText();
    checkDataVersion();
    
    // Set default selections immediately and after DOM is fully loaded
    function setDefaultSelections() {
      console.log('Setting default selections...');
      
      // Set default selections for add modal
      const termTagMedium = document.querySelector('#termTagsRow .term-tag[data-term="medium"]');
      const importanceLevel3 = document.querySelector('#importanceRow .importance-dot[data-level="3"]');
      const categoryOther = document.querySelector('#categoryRow .category-chip[data-category="Other"]');
      
      console.log('Found elements:', {
        termTagMedium: !!termTagMedium,
        importanceLevel3: !!importanceLevel3,
        categoryOther: !!categoryOther
      });
      
      if (termTagMedium) termTagMedium.classList.add('selected');
      if (importanceLevel3) importanceLevel3.classList.add('selected');
      if (categoryOther) categoryOther.classList.add('selected');
    }
    
    // Set defaults immediately
    setDefaultSelections();
    
    // Also set after a short delay to ensure DOM is ready
    setTimeout(setDefaultSelections, 100);
    
    // Add modal open handler to ensure defaults are set
    openModalBtn.onclick = () => { 
      console.log('Opening add modal');
      modalOverlay.classList.remove('hidden');
      // Ensure defaults are set when modal opens
      setTimeout(setDefaultSelections, 50);
    };
    
    // Filter chip click handler
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('chip')) {
        const category = e.target.getAttribute('data-cat');
        if (category) {
          activeCategory = category;
          renderChips();
          renderNotes();
          console.log('Active category changed to:', category);
        }
      }
    });
    
    // Long-press drag functionality for filter chips
    let isDragging = false;
    let draggedElement = null;
    let originalPosition = null;
    let dragStartTime = 0;
    let dragTimeout = null;
    
    // Mouse events for desktop
    document.addEventListener('mousedown', (e) => {
      if (e.target.classList.contains('chip')) {
        dragStartTime = Date.now();
        dragTimeout = setTimeout(() => {
          startDrag(e.target, e.clientX, e.clientY);
        }, 500); // 500ms long press
      }
    });
    
    document.addEventListener('mouseup', () => {
      if (dragTimeout) {
        clearTimeout(dragTimeout);
        dragTimeout = null;
      }
      if (isDragging) {
        stopDrag();
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging && draggedElement) {
        updateDragPosition(e.clientX, e.clientY);
      }
    });
    
    // Touch events for mobile
    document.addEventListener('touchstart', (e) => {
      if (e.target.classList.contains('chip')) {
        dragStartTime = Date.now();
        dragTimeout = setTimeout(() => {
          startDrag(e.target, e.touches[0].clientX, e.touches[0].clientY);
        }, 500); // 500ms long press
      }
    });
    
    document.addEventListener('touchend', () => {
      if (dragTimeout) {
        clearTimeout(dragTimeout);
        dragTimeout = null;
      }
      if (isDragging) {
        stopDrag();
      }
    });
    
    document.addEventListener('touchmove', (e) => {
      if (isDragging && draggedElement) {
        e.preventDefault(); // Prevent scrolling while dragging
        updateDragPosition(e.touches[0].clientX, e.touches[0].clientY);
      }
    });
    
    function startDrag(element, startX, startY) {
      console.log('Starting drag for:', element.textContent);
      isDragging = true;
      draggedElement = element;
      originalPosition = {
        x: element.offsetLeft,
        y: element.offsetTop
      };
      
      // Add dragging styles
      element.style.position = 'fixed';
      element.style.zIndex = '1000';
      element.style.pointerEvents = 'none';
      element.style.transform = 'scale(1.1)';
      element.style.boxShadow = '0 8px 24px rgba(108,99,255,0.3)';
      
      // Create drag indicator
      const indicator = document.createElement('div');
      indicator.id = 'dragIndicator';
      indicator.style.position = 'fixed';
      indicator.style.width = '2px';
      indicator.style.height = '20px';
      indicator.style.backgroundColor = '#6C63FF';
      indicator.style.zIndex = '999';
      document.body.appendChild(indicator);
      
      updateDragPosition(startX, startY);
    }
    
    function updateDragPosition(clientX, clientY) {
      if (!draggedElement) return;
      
      const rect = draggedElement.getBoundingClientRect();
      const x = clientX - rect.width / 2;
      const y = clientY - rect.height / 2;
      
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
      
      // Update drag indicator position
      const indicator = document.getElementById('dragIndicator');
      if (indicator) {
        indicator.style.left = (clientX - 1) + 'px';
        indicator.style.top = (clientY - 10) + 'px';
      }
      
      // Check for drop zones (other chips)
      const chips = document.querySelectorAll('.chip');
      chips.forEach(chip => {
        if (chip !== draggedElement) {
          const chipRect = chip.getBoundingClientRect();
          const isOverlapping = clientX >= chipRect.left && 
                               clientX <= chipRect.right && 
                               clientY >= chipRect.top && 
                               clientY <= chipRect.bottom;
          
          if (isOverlapping) {
            chip.style.transform = 'scale(1.05)';
            chip.style.backgroundColor = '#e3f2fd';
          } else {
            chip.style.transform = '';
            chip.style.backgroundColor = '';
          }
        }
      });
    }
    
    function stopDrag() {
      if (!draggedElement) return;
      
      console.log('Stopping drag');
      
      // Find drop target
      const chips = document.querySelectorAll('.chip');
      let dropTarget = null;
      
      chips.forEach(chip => {
        if (chip !== draggedElement) {
          const chipRect = chip.getBoundingClientRect();
          const draggedRect = draggedElement.getBoundingClientRect();
          
          const isOverlapping = draggedRect.left < chipRect.right && 
                               draggedRect.right > chipRect.left && 
                               draggedRect.top < chipRect.bottom && 
                               draggedRect.bottom > chipRect.top;
          
          if (isOverlapping) {
            dropTarget = chip;
          }
          
          // Reset chip styles
          chip.style.transform = '';
          chip.style.backgroundColor = '';
        }
      });
      
      // Reorder if drop target found
      if (dropTarget) {
        const draggedCategory = draggedElement.getAttribute('data-cat');
        const targetCategory = dropTarget.getAttribute('data-cat');
        
        console.log('Reordering:', draggedCategory, 'to position of', targetCategory);
        reorderCategories(draggedCategory, targetCategory);
      }
      
      // Reset dragged element
      draggedElement.style.position = '';
      draggedElement.style.zIndex = '';
      draggedElement.style.pointerEvents = '';
      draggedElement.style.transform = '';
      draggedElement.style.boxShadow = '';
      draggedElement.style.left = '';
      draggedElement.style.top = '';
      
      // Remove drag indicator
      const indicator = document.getElementById('dragIndicator');
      if (indicator) {
        indicator.remove();
      }
      
      isDragging = false;
      draggedElement = null;
      originalPosition = null;
    }
    
    function reorderCategories(draggedCategory, targetCategory) {
      // Get current category order from localStorage or use default
      let categoryOrder = JSON.parse(localStorage.getItem('categoryOrder')) || ['All', 'Done'];
      
      // Add all categories to the order if they're not already there
      categories.forEach(cat => {
        if (!categoryOrder.includes(cat)) {
          categoryOrder.push(cat);
        }
      });
      
      // Remove dragged category from its current position
      const draggedIndex = categoryOrder.indexOf(draggedCategory);
      if (draggedIndex > -1) {
        categoryOrder.splice(draggedIndex, 1);
      }
      
      // Insert dragged category at target position
      const targetIndex = categoryOrder.indexOf(targetCategory);
      if (targetIndex > -1) {
        categoryOrder.splice(targetIndex, 0, draggedCategory);
      }
      
      // Save new order
      localStorage.setItem('categoryOrder', JSON.stringify(categoryOrder));
      
      // Re-render chips with new order
      renderChips();
      console.log('Category order updated:', categoryOrder);
    }
    
    // Note click handler for editing
    notesGrid.addEventListener('click', (e) => {
      const noteCard = e.target.closest('.note-card');
      if (noteCard) {
        const noteId = noteCard.dataset.id;
        const note = notes.find(n => n.id === noteId);
        if (note) {
          openEditModal(note);
        }
      }
    });
    
    // Open edit modal function
    function openEditModal(note) {
      console.log('openEditModal called with note:', note);
      const editModal = document.getElementById('editModalOverlay');
      const editNoteText = document.getElementById('editNoteText');
      const editTimeframe = document.getElementById('editTimeframe');
      const editCustomDate = document.getElementById('editCustomDate');
      const editCustomDateContainer = document.getElementById('editCustomDateContainer');
      
      console.log('Edit modal elements found:');
      console.log('editModal:', !!editModal);
      console.log('editNoteText:', !!editNoteText);
      console.log('editTimeframe:', !!editTimeframe);
      console.log('editCustomDate:', !!editCustomDate);
      console.log('editCustomDateContainer:', !!editCustomDateContainer);
      
      // Set note data
      editNoteText.value = note.text;
      
      // Handle timeframe and custom date
      console.log('Note timeframe:', note.timeframe);
      console.log('Note customDate:', note.customDate);
      console.log('Note has customDate field:', 'customDate' in note);
      if (note.customDate) {
        // If note has customDate, it was a custom date
        console.log('Setting custom date:', note.customDate);
        editTimeframe.value = 'custom';
        editCustomDate.value = note.customDate;
        editCustomDateContainer.style.display = 'block';
        console.log('Custom date container display set to:', editCustomDateContainer.style.display);
      } else {
        // Regular timeframe
        console.log('Setting regular timeframe:', note.timeframe);
        editTimeframe.value = note.timeframe || '1';
        editCustomDate.value = '';
        editCustomDateContainer.style.display = 'none';
        console.log('Custom date container display set to:', editCustomDateContainer.style.display);
      }
      
      // Set term tag with fallback (single selection)
      [...document.getElementById('editTermTagsRow').children].forEach(tag => tag.classList.remove('selected'));
      const termTag = note.termTag || (note.termTags && note.termTags[0]) || 'medium';
      const selectedTag = document.querySelector(`#editTermTagsRow .term-tag[data-term="${termTag}"]`);
      if (selectedTag) selectedTag.classList.add('selected');
      
      // Set importance with fallback (single selection)
      [...document.getElementById('editImportanceRow').children].forEach(dot => dot.classList.remove('selected'));
      const importance = note.importance || '3';
      console.log('Setting importance to:', importance);
      console.log('Importance dots found:', document.getElementById('editImportanceRow').children.length);
      const selectedImportanceBtn = document.querySelector(`#editImportanceRow .importance-dot[data-level="${importance}"]`);
      console.log('Found importance button:', selectedImportanceBtn);
      if (selectedImportanceBtn) selectedImportanceBtn.classList.add('selected');
      
      // Set categories (multiple selection)
      [...document.getElementById('editCategoryRow').children].forEach(chip => chip.classList.remove('selected'));
      const categories = note.categories || [note.category || 'Other'];
      categories.forEach(cat => {
        const chip = document.querySelector(`#editCategoryRow .category-chip[data-category="${cat}"]`);
        if (chip) chip.classList.add('selected');
      });
      
      // Store note ID for form submission
      document.getElementById('editNoteModal').dataset.id = note.id;
      
      // Show/hide action buttons based on note state
      const markDoneBtn = document.getElementById('markDoneBtn');
      const deleteBtn = document.getElementById('deleteNoteBtn');
      
      markDoneBtn.style.display = 'inline-block';
      
      // Only show delete button if note is done
      if (note.done) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = 'Delete Note';
        deleteBtn.style.background = '#FF6B6B';
      } else {
        deleteBtn.style.display = 'none';
      }
      
      // Update button text based on current state
      markDoneBtn.textContent = note.done ? 'Mark as Undone' : 'Mark as Done';
      
      editModal.classList.remove('hidden');
    }
    
    // Add note form submission
    addNoteModal.onsubmit = (e) => {
      e.preventDefault();
      
      const text = noteText.value.trim();
      const timeframe = document.getElementById('timeframe').value;
      const customDate = document.getElementById('customDate').value;
      
      // Get selected term tag (single selection)
      const selectedTermTag = document.querySelector('#termTagsRow .term-tag.selected');
      const termTag = selectedTermTag ? selectedTermTag.getAttribute('data-term') : 'medium';
      
      // Get selected importance (single selection)
      const selectedImportanceBtn = document.querySelector('#importanceRow .importance-dot.selected');
      const importance = selectedImportanceBtn ? selectedImportanceBtn.getAttribute('data-level') : '3';
      
      // Get selected categories (multiple selection)
      const selectedCategories = Array.from(document.getElementById('categoryRow').children)
        .filter(chip => chip.classList.contains('selected'))
        .map(chip => chip.getAttribute('data-category'));
      
      if (!text) {
        alert('Please enter a note.');
        return;
      }
      
      // Calculate urgency based on timeframe
      let calculatedUrgency;
      if (timeframe === 'custom' && customDate) {
        const dueDate = new Date(customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      } else {
        const days = parseInt(timeframe);
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      }
      
      const title = aiGenerateTitle(text);
      
      const newNote = { 
        id: Date.now().toString(),
        text, 
        timeframe, 
        customDate: timeframe === 'custom' ? customDate : null,
        urgency: calculatedUrgency, 
        importance: importance,
        categories: selectedCategories.length > 0 ? selectedCategories : ['Other'], 
        title,
        done: false,
        createdAt: new Date().toISOString(),
        termTag: termTag
      };
      
      notes.push(newNote);
      saveNotes();
      renderNotes();
      
      // Reset modal
      noteText.value = '';
      document.getElementById('timeframe').value = '1';
      document.getElementById('customDate').value = '';
      document.getElementById('customDateContainer').style.display = 'none';
      [...categoryRow.children].forEach(chip => chip.classList.remove('selected'));
      [...document.getElementById('termTagsRow').children].forEach(tag => tag.classList.remove('selected'));
      [...document.getElementById('importanceRow').children].forEach(dot => dot.classList.remove('selected'));
      
      // Reset to defaults using the function
      setTimeout(setDefaultSelections, 50);
      
      modalOverlay.classList.add('hidden');
    };
    
    // Edit note form submission
    const editNoteModal = document.getElementById('editNoteModal');
    editNoteModal.onsubmit = (e) => {
      e.preventDefault();
      
      const text = document.getElementById('editNoteText').value.trim();
      const timeframe = document.getElementById('editTimeframe').value;
      const customDate = document.getElementById('editCustomDate').value;
      
      // Get selected term tag (single selection)
      const selectedTermTag = document.querySelector('#editTermTagsRow .term-tag.selected');
      const termTag = selectedTermTag ? selectedTermTag.getAttribute('data-term') : 'medium';
      
      // Get selected importance (single selection)
      const selectedImportanceBtn = document.querySelector('#editImportanceRow .importance-dot.selected');
      const importance = selectedImportanceBtn ? selectedImportanceBtn.getAttribute('data-level') : '3';
      
      // Get selected categories (multiple selection)
      const selectedCategories = Array.from(document.getElementById('editCategoryRow').children)
        .filter(chip => chip.classList.contains('selected'))
        .map(chip => chip.getAttribute('data-category'));
      
      if (!text) {
        alert('Please enter a note.');
        return;
      }
      
      // Calculate urgency based on timeframe
      let calculatedUrgency;
      if (timeframe === 'custom' && customDate) {
        const dueDate = new Date(customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      } else {
        const days = parseInt(timeframe);
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      }
      
      const title = aiGenerateTitle(text);
      
      // Update note
      const note = notes.find(n => n.id === document.getElementById('editNoteModal').dataset.id);
      if (note) {
        note.text = text;
        note.timeframe = timeframe;
        note.customDate = timeframe === 'custom' ? customDate : null;
        note.urgency = calculatedUrgency;
        note.importance = importance;
        note.category = selectedCategories[0]; // Keep only the first selected category
        note.categories = selectedCategories.length > 0 ? selectedCategories : ['Other']; // Update categories array
        note.title = title;
        note.termTag = termTag; // Update single term tag
        note.termTags = [termTag]; // Update term tags array
      }
      
      saveNotes();
      renderNotes();
      document.getElementById('editModalOverlay').classList.add('hidden');
    };

    // Edit importance selection (single selection only)
    document.getElementById('editImportanceRow').onclick = (e) => {
      console.log('Edit importance clicked:', e.target);
      if (e.target.classList.contains('importance-dot')) {
        console.log('Importance dot clicked, level:', e.target.getAttribute('data-level'));
        [...document.getElementById('editImportanceRow').children].forEach(dot => dot.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Edit term tag selection (single selection only)
    document.getElementById('editTermTagsRow').onclick = (e) => {
      if (e.target.classList.contains('term-tag')) {
        [...document.getElementById('editTermTagsRow').children].forEach(tag => tag.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Edit category selection (multiple selection allowed)
    document.getElementById('editCategoryRow').onclick = (e) => {
      if (e.target.classList.contains('category-chip')) {
        e.target.classList.toggle('selected');
      }
    };
    
    // Edit modal cancel button
    document.getElementById('cancelEditModalBtn').onclick = () => {
      document.getElementById('editModalOverlay').classList.add('hidden');
    };
    
    // Edit modal overlay click to close
    document.getElementById('editModalOverlay').onclick = (e) => {
      if (e.target === document.getElementById('editModalOverlay')) {
        document.getElementById('editModalOverlay').classList.add('hidden');
      }
    };
    
    // Calendar functionality
    const calendarBtn = document.querySelector('.nav-btn[title="Calendar"]');
    const calendarModalOverlay = document.getElementById('calendarModalOverlay');
    let currentCalendarDate = new Date();
    
    console.log('Calendar initialization:');
    console.log('Calendar button found:', !!calendarBtn);
    console.log('Calendar modal overlay found:', !!calendarModalOverlay);
    console.log('Calendar modal overlay classes:', calendarModalOverlay?.className);
    
    // Settings functionality
    const settingsBtn = document.querySelector('.nav-btn.settings');
    const settingsModalOverlay = document.getElementById('settingsModalOverlay');
    
    console.log('Settings initialization:');
    console.log('Settings button found:', !!settingsBtn);
    console.log('Settings modal overlay found:', !!settingsModalOverlay);
    
    // Settings button click handler
    settingsBtn.onclick = () => {
      console.log('Settings button clicked');
      settingsModalOverlay.classList.remove('hidden');
    };
    
    // Settings modal close handlers
    document.getElementById('cancelSettingsBtn').onclick = () => {
      settingsModalOverlay.classList.add('hidden');
    };
    
    document.getElementById('saveSettingsBtn').onclick = () => {
      // Save settings logic here
      settingsModalOverlay.classList.add('hidden');
    };
    
    // Category management functionality
    const categorySettingsBtn = document.getElementById('categorySettingsBtn');
    const editCategorySettingsBtn = document.getElementById('editCategorySettingsBtn');
    const categoryModalOverlay = document.getElementById('categoryModalOverlay');
    
    console.log('Category management initialization:');
    console.log('Category settings button found:', !!categorySettingsBtn);
    console.log('Edit category settings button found:', !!editCategorySettingsBtn);
    console.log('Category modal overlay found:', !!categoryModalOverlay);
    
    // Category settings button handlers
    categorySettingsBtn.onclick = () => {
      console.log('Category settings button clicked');
      categoryModalOverlay.classList.remove('hidden');
      renderExistingCategories();
    };
    
    editCategorySettingsBtn.onclick = () => {
      console.log('Edit category settings button clicked');
      categoryModalOverlay.classList.remove('hidden');
      renderExistingCategories();
    };
    
    // Category modal close handler
    document.getElementById('cancelCategoryBtn').onclick = () => {
      categoryModalOverlay.classList.add('hidden');
    };
    
    // Add category functionality
    document.getElementById('addCategoryBtn').onclick = () => {
      const newCategoryInput = document.getElementById('newCategoryInput');
      const newCategory = newCategoryInput.value.trim();
      
      if (newCategory && !categories.has(newCategory)) {
        categories.add(newCategory);
        saveNotes(); // This also saves categories
        renderChips();
        renderExistingCategories();
        newCategoryInput.value = '';
        console.log('Category added:', newCategory);
      }
    };
    
    // Render existing categories for management modal
    function renderExistingCategories() {
      const existingCategoriesContainer = document.getElementById('existingCategories');
      const categoriesArray = Array.from(categories);
      
      existingCategoriesContainer.innerHTML = categoriesArray.map(cat => `
        <div class="category-item">
          <span>${cat}</span>
          <button type="button" class="delete-btn" data-category="${cat}">Delete</button>
        </div>
      `).join('');
      
      // Add delete handlers
      existingCategoriesContainer.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => {
          const categoryToDelete = e.target.getAttribute('data-category');
          if (categoryToDelete && categoryToDelete !== 'Other') {
            categories.delete(categoryToDelete);
            saveNotes();
            renderChips();
            renderExistingCategories();
            console.log('Category deleted:', categoryToDelete);
          }
        };
      });
    }
    
    // Done functionality
    document.getElementById('markDoneBtn').onclick = () => {
      const noteId = document.getElementById('editNoteModal').dataset.id;
      const note = notes.find(n => n.id === noteId);
      
      if (note) {
        note.done = !note.done;
        saveNotes();
        renderNotes();
        document.getElementById('editModalOverlay').classList.add('hidden');
        console.log('Note marked as done:', note.done);
      }
    };
    
    // Delete functionality
    document.getElementById('deleteNoteBtn').onclick = () => {
      const noteId = document.getElementById('editNoteModal').dataset.id;
      const note = notes.find(n => n.id === noteId);
      
      if (note) {
        if (note.done) {
          // Only allow deletion if note is done
          const confirmed = confirm(`Are you sure you want to delete "${note.title}"? This action cannot be undone.`);
          
          if (confirmed) {
            const noteIndex = notes.findIndex(n => n.id === noteId);
            if (noteIndex !== -1) {
              notes.splice(noteIndex, 1);
              saveNotes();
              renderNotes();
              document.getElementById('editModalOverlay').classList.add('hidden');
              console.log('Note deleted (was marked as done)');
            }
          }
        } else {
          // Show warning if trying to delete non-done note
          alert('You can only delete notes that are marked as done. Please mark this note as done first.');
          console.log('Delete blocked - note not marked as done');
        }
      }
    };
    
    // Open calendar modal
    calendarBtn.onclick = () => {
      console.log('Calendar button clicked');
      console.log('Calendar button found:', !!calendarBtn);
      console.log('Calendar modal overlay found:', !!calendarModalOverlay);
      calendarModalOverlay.classList.remove('hidden');
      console.log('Calendar modal hidden class removed');
      
      // Test if modal is visible
      setTimeout(() => {
        const isVisible = !calendarModalOverlay.classList.contains('hidden');
        const computedStyle = window.getComputedStyle(calendarModalOverlay);
        console.log('Calendar modal visibility test:');
        console.log('- Hidden class removed:', isVisible);
        console.log('- Display style:', computedStyle.display);
        console.log('- Opacity:', computedStyle.opacity);
        console.log('- Z-index:', computedStyle.zIndex);
      }, 100);
      
      renderCalendar();
      console.log('Calendar rendered');
    };
    
    // Calendar navigation
    document.getElementById('prevMonthBtn').onclick = () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
    };
    
    document.getElementById('nextMonthBtn').onclick = () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
    };
    
    document.getElementById('closeCalendarBtn').onclick = () => {
      calendarModalOverlay.classList.add('hidden');
    };
    
    // Render calendar
    function renderCalendar() {
      console.log('Rendering calendar...');
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      console.log('Calendar date:', year, month);
      
      // Update title
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      const calendarTitle = document.getElementById('calendarTitle');
      console.log('Calendar title element found:', !!calendarTitle);
      if (calendarTitle) {
        calendarTitle.textContent = `${monthNames[month]} ${year}`;
        console.log('Calendar title set to:', calendarTitle.textContent);
      }
      
      const calendarGrid = document.getElementById('calendarGrid');
      console.log('Calendar grid element found:', !!calendarGrid);
      if (!calendarGrid) {
        console.error('Calendar grid not found!');
        return;
      }
      
      calendarGrid.innerHTML = '';
      console.log('Calendar grid cleared');
      
      // Add day headers
      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
      });
      console.log('Day headers added');
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      console.log('Calendar start date:', startDate);
      
      // Generate calendar days
      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Add day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = currentDate.getDate();
        dayElement.appendChild(dayNumber);
        
        // Add day content container
        const dayContent = document.createElement('div');
        dayContent.className = 'calendar-day-content';
        dayElement.appendChild(dayContent);
        
        // Check if this day has tasks
        const tasksForDay = getDueDatesForDate(currentDate);
        if (tasksForDay.length > 0) {
          console.log(`Day ${currentDate.getDate()} has ${tasksForDay.length} tasks`);
          tasksForDay.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = `calendar-task ${task.categories[0]?.toLowerCase() || 'other'}`;
            taskElement.textContent = task.title || task.text;
            
            // Add importance color
            const importance = task.importance || '3';
            taskElement.setAttribute('data-importance', importance);
            
            // Make task clickable to open edit modal
            taskElement.style.cursor = 'pointer';
            taskElement.onclick = () => {
              console.log('Calendar task clicked:', task);
              console.log('Task ID:', task.id);
              console.log('Task text:', task.text);
              console.log('Task importance:', task.importance);
              openEditModal(task);
            };
            
            dayContent.appendChild(taskElement);
          });
        }
        
        // Style based on whether it's current month
        if (currentDate.getMonth() !== month) {
          dayElement.style.opacity = '0.5';
        }
        
        calendarGrid.appendChild(dayElement);
      }
      console.log('Calendar days generated');
    }
    
    // Get due dates for a specific date
    function getDueDatesForDate(date) {
      const dateStr = date.toISOString().split('T')[0];
      console.log('Checking tasks for date:', dateStr);
      console.log('Total notes:', notes.length);
      
      const tasksForDate = notes.filter(note => {
        if (note.timeframe === 'custom' && note.customDate) {
          const matches = note.customDate === dateStr;
          if (matches) console.log('Found custom date task:', note.title || note.text);
          return matches;
        }
        // For other timeframes, calculate due date
        const days = parseInt(note.timeframe);
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + days);
        const calculatedDateStr = dueDate.toISOString().split('T')[0];
        const matches = calculatedDateStr === dateStr;
        if (matches) console.log('Found regular timeframe task:', note.title || note.text);
        return matches;
      });
      
      console.log(`Found ${tasksForDate.length} tasks for ${dateStr}`);
      return tasksForDate;
    }

    // Comprehensive functionality test
    function runComprehensiveTest() {
      console.log('=== COMPREHENSIVE FUNCTIONALITY TEST ===');
      
      // Test 1: Check if all required elements exist
      const requiredElements = [
        'openModalBtn', 'modalOverlay', 'addNoteModal', 'noteText',
        'timeframe', 'customDate', 'termTagsRow', 'importanceRow', 'categoryRow',
        'editModalOverlay', 'editNoteModal', 'editNoteText', 'editTimeframe',
        'editCustomDate', 'editTermTagsRow', 'editImportanceRow', 'editCategoryRow',
        'calendarModalOverlay', 'calendarGrid', 'calendarTitle',
        'notesGrid', 'searchInput', 'sortBtn', 'sortDropdown'
      ];
      
      const missingElements = [];
      requiredElements.forEach(id => {
        const element = document.getElementById(id);
        if (!element) {
          missingElements.push(id);
        }
      });
      
      if (missingElements.length > 0) {
        console.error('Missing elements:', missingElements);
      } else {
        console.log('✅ All required elements found');
      }
      
      // Test 2: Check if functions are defined
      const requiredFunctions = [
        'loadNotes', 'saveNotes', 'renderNotes', 'renderChips',
        'setDefaultSelections', 'openEditModal', 'renderCalendar',
        'getDueDatesForDate', 'formatTimeframe', 'toggleCustomDate',
        'toggleEditCustomDate', 'aiGenerateTitle', 'sortNotes'
      ];
      
      const missingFunctions = [];
      requiredFunctions.forEach(funcName => {
        if (typeof window[funcName] !== 'function') {
          missingFunctions.push(funcName);
        }
      });
      
      if (missingFunctions.length > 0) {
        console.error('Missing functions:', missingFunctions);
      } else {
        console.log('✅ All required functions defined');
      }
      
      // Test 3: Check data state
      console.log('Notes count:', notes.length);
      console.log('Categories:', Array.from(categories));
      console.log('Current sort:', currentSort);
      console.log('Active category:', activeCategory);
      
      // Test 4: Check localStorage
      const savedNotes = localStorage.getItem('eznotes_notes');
      const savedSort = localStorage.getItem('currentSort');
      console.log('Saved notes:', savedNotes ? JSON.parse(savedNotes).length : 0);
      console.log('Saved sort:', savedSort);
      
      console.log('=== TEST COMPLETE ===');
    }
    
    // Run comprehensive test after initialization
    setTimeout(runComprehensiveTest, 500);
    
    // Show reorder hint tooltip on first visit
    if (!localStorage.getItem('reorderHintShown')) {
      setTimeout(() => {
        const tooltip = document.createElement('div');
        tooltip.style.position = 'fixed';
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        tooltip.style.background = '#6C63FF';
        tooltip.style.color = 'white';
        tooltip.style.padding = '1rem';
        tooltip.style.borderRadius = '0.5rem';
        tooltip.style.zIndex = '10000';
        tooltip.style.boxShadow = '0 4px 16px rgba(108,99,255,0.3)';
        tooltip.style.fontSize = '0.9rem';
        tooltip.style.textAlign = 'center';
        tooltip.style.maxWidth = '300px';
        tooltip.innerHTML = `
          <div style="margin-bottom: 0.5rem;">💡 <strong>Pro Tip:</strong></div>
          <div>Long-press any filter chip to reorder them!</div>
          <button onclick="this.parentElement.remove()" style="margin-top: 0.5rem; padding: 0.3rem 0.8rem; background: white; color: #6C63FF; border: none; border-radius: 0.3rem; cursor: pointer;">Got it!</button>
        `;
        document.body.appendChild(tooltip);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          if (tooltip.parentElement) {
            tooltip.remove();
          }
        }, 5000);
        
        localStorage.setItem('reorderHintShown', 'true');
      }, 1000);
    }
    
    // Dark mode functionality
    const darkModeToggle = document.getElementById('darkModeToggle');
    
    // Load saved dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) {
      document.body.classList.add('dark-mode');
      darkModeToggle.checked = true;
    }
    
    // Dark mode toggle handler
    darkModeToggle.onchange = () => {
      const isDarkMode = darkModeToggle.checked;
      localStorage.setItem('darkMode', isDarkMode);
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
        console.log('Dark mode enabled');
      } else {
        document.body.classList.remove('dark-mode');
        console.log('Dark mode disabled');
      }
    };
    
    // Save settings functionality
    document.getElementById('saveSettingsBtn').onclick = () => {
      // Save notification settings
      const notificationSound = document.getElementById('notificationSound').value;
      const highUrgencyFreq = document.getElementById('highUrgencyFreq').value;
      const mediumUrgencyFreq = document.getElementById('mediumUrgencyFreq').value;
      const lowUrgencyFreq = document.getElementById('lowUrgencyFreq').value;
      
      localStorage.setItem('notificationSound', notificationSound);
      localStorage.setItem('highUrgencyFreq', highUrgencyFreq);
      localStorage.setItem('mediumUrgencyFreq', mediumUrgencyFreq);
      localStorage.setItem('lowUrgencyFreq', lowUrgencyFreq);
      
      console.log('Settings saved');
      settingsModalOverlay.classList.add('hidden');
    };
    
    // Load saved settings
    function loadSettings() {
      const notificationSound = localStorage.getItem('notificationSound') || 'default';
      const highUrgencyFreq = localStorage.getItem('highUrgencyFreq') || 'immediate';
      const mediumUrgencyFreq = localStorage.getItem('mediumUrgencyFreq') || 'daily';
      const lowUrgencyFreq = localStorage.getItem('lowUrgencyFreq') || 'weekly';
      
      document.getElementById('notificationSound').value = notificationSound;
      document.getElementById('highUrgencyFreq').value = highUrgencyFreq;
      document.getElementById('mediumUrgencyFreq').value = mediumUrgencyFreq;
      document.getElementById('lowUrgencyFreq').value = lowUrgencyFreq;
    }
    
    // Load settings on startup
    loadSettings();
  </script>
</body>
</html>