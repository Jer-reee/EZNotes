<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>EZ Habits</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* Mobile-first CSS fixes */
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      touch-action: manipulation;
    }
    
    /* Allow text selection in inputs and textareas */
    input, textarea, [contenteditable] {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
      touch-action: auto;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      background: #F3F8FF;
      color: #222;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    .floating-island {
      max-width: 500px;
      margin: 2.5rem auto 0 auto;
      background: #fff;
      border-radius: 2.2rem;
      box-shadow: 0 8px 32px rgba(108,99,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      padding: 2rem 1.2rem 2rem 1.2rem;
      position: relative;
      z-index: 2;
    }
    .header {
      padding: 0 0 1rem 0;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 2rem;
      letter-spacing: 2px;
      color: #6C63FF;
    }
    
    .header-ai-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #ffffff;
      border: none;
      border-radius: 0.8rem;
      padding: 0.5rem 1rem;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .header-ai-btn:hover {
      background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    /* This Week Calendar Styles */
    .this-week-calendar {
      margin: 1rem 0 1.5rem 0;
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 16px rgba(108,99,255,0.08);
      overflow: hidden;
    }
    
    .this-week-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    
    .this-week-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .this-week-title:hover {
      opacity: 0.8;
    }
    
    .this-week-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .week-nav-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .week-nav-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .this-week-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #f0f0f0;
      padding: 0.5rem;
    }
    
    .week-day {
      background: #fff;
      min-height: 80px;
      padding: 0.5rem;
      border-radius: 0.5rem;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .week-day:hover {
      box-shadow: 0 4px 12px rgba(108,99,255,0.15);
    }
    
    .week-day.selected {
      background: #e3f2fd;
      border: 2px solid #6C63FF;
    }
    
    .week-day.today .week-day-number {
      background: linear-gradient(135deg, #6C63FF, #8B7CF6);
      color: white;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(108, 99, 255, 0.3);
    }
    
    .week-day-number {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    
    .week-day-name {
      font-size: 0.7rem;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 0.5rem;
    }
    
    .week-day-content {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      gap: 0.1rem;
      align-items: center;
      justify-content: center;
      min-height: 14px;
      max-width: 100%;
      padding: 0.1rem;
      overflow: hidden;
      width: 100%;
    }
    
    .week-task {
      background: #e3f2fd;
      color: #1976d2;
      padding: 0.2rem 0.4rem;
      border-radius: 0.3rem;
      font-size: 0.65rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 2px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .week-task:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .week-task.work { background: #fff3e0; color: #f57c00; }
    .week-task.personal { background: #e8f5e8; color: #388e3c; }
    .week-task.school { background: #f3e5f5; color: #7b1fa2; }
    .week-task.home { background: #fce4ec; color: #c2185b; }
    .week-task.other { background: #f5f5f5; color: #616161; }
    
    .this-week-notes {
      padding: 1rem;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .this-week-notes.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .week-note-item {
      background: #fff;
      padding: 0.8rem;
      margin: 0.5rem 0;
      border-radius: 0.5rem;
      border-left: 3px solid #6C63FF;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .week-note-item:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* Weekly Calendar Category Tags */
    .week-categories-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      max-width: 100%;
      overflow: hidden;
    }
    
    .week-category-tag {
      background: rgba(108, 99, 255, 0.1);
      color: #6C63FF;
      padding: 0.2rem 0.5rem;
      border-radius: 0.8rem;
      font-size: 0.7rem;
      font-weight: 500;
      white-space: nowrap;
      border: 1px solid rgba(108, 99, 255, 0.2);
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.2s ease;
    }
    
    .week-category-tag:hover {
      background: rgba(108, 99, 255, 0.2);
      transform: scale(1.05);
    }
    

    
    /* Search Icon Styles */
    .search-icon-container {
      position: relative;
      margin: 0 0 1rem 0;
    }
    
    .search-icon-btn {
      background: #f7f8fc;
      border: none;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(108,99,255,0.04);
    }
    
    .search-icon-btn:hover {
      background: #f0f0ff;
      box-shadow: 0 4px 12px rgba(108,99,255,0.12);
    }
    
    .search-expanded {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #f7f8fc;
      border-radius: 1.5rem;
      box-shadow: 0 2px 8px rgba(108,99,255,0.04);
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 10;
      animation: expandSearch 0.3s ease-out;
    }
    
    @keyframes expandSearch {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .search-expanded input {
      border: none;
      outline: none;
      flex: 1;
      font-size: 1rem;
      background: transparent;
      padding: 0.5rem 0;
    }
    
    .search-expanded.has-content {
      background: #f0f0ff;
      border: 1px solid #6C63FF;
    }
    
    .clear-search-btn {
      background: none;
      border: none;
      color: #6C63FF;
      cursor: pointer;
      padding: 0.5rem;
      font-size: 1.2rem;
      border-radius: 50%;
      transition: background 0.2s;
    }
    
    .clear-search-btn:hover {
      background: rgba(108, 99, 255, 0.1);
    }
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 0 0 1.5rem 0;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    .chip {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      background: #E1BEE7;
      color: #6C63FF;
      font-size: 0.95rem;
      border: none;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .chip.active {
      background: #6C63FF;
      color: #fff;
    }
    
    #chipContainer {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .sort-btn {
      margin-left: auto;
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      background: #6C63FF;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(108,99,255,0.15);
      font-weight: 500;
      white-space: nowrap;
    }
    .sort-btn:hover {
      background: #574fd6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108,99,255,0.25);
    }
    .sort-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: #fff;
      border-radius: 0.8rem;
      box-shadow: 0 4px 16px rgba(108,99,255,0.15);
      padding: 0.5rem 0;
      z-index: 10;
      min-width: 150px;
      display: none;
    }
    .sort-dropdown.show {
      display: block;
    }
    .sort-direction h4,
    .sort-criteria h4 {
      margin: 0 0 0.5rem 0;
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }
    
    .direction-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .direction-btn,
    .criteria-btn {
      flex: 1;
      padding: 0.5rem;
      border: 2px solid #e0e0e0;
      border-radius: 0.5rem;
      background: #fff;
      color: #333;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .direction-btn:hover,
    .criteria-btn:hover {
      border-color: #6C63FF;
      background: #f0f0f0;
    }
    
    .direction-btn.selected,
    .criteria-btn.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    
    .sort-criteria {
      border-top: 1px solid #e0e0e0;
      padding-top: 1rem;
    }
    .notes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 0 0 2rem 0;
    }
    .note-card {
      border-radius: 1.2rem;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(108,99,255,0.07);
      font-size: 1rem;
      margin-bottom: 0.5rem;
      background: #fff;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      transition: background 0.2s;
      cursor: pointer;
      position: relative;
    }
    .note-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(108,99,255,0.12);
    }
    .note-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }
    .note-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }
    .note-category {
      font-size: 0.85rem;
      color: #6C63FF;
      background: #F0F0FF;
      padding: 0.2rem 0.6rem;
      border-radius: 0.8rem;
      display: inline-block;
      font-weight: 500;
    }
    .note-term-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.3rem;
    }
    .term-tag-display {
      font-size: 0.75rem;
      padding: 0.2rem 0.5rem;
      border-radius: 0.6rem;
      color: #fff;
      font-weight: 600;
    }
    .term-tag-display.short {
      background: #FF4444;
    }
    .term-tag-display.medium {
      background: #FF8800;
    }
    .term-tag-display.long {
      background: #00CC44;
    }
    .due-date-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
    }
    .note-importance {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.3rem;
      font-weight: 500;
    }
    .note-duration {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.3rem;
      font-weight: 500;
    }
    /* Importance-based color coding */
    .note-card[data-importance="slightly"] { 
      background: #e8f5e8; 
      border-left: 4px solid #4caf50; 
    }
    .note-card[data-importance="moderately"] { 
      background: #fff3e0; 
      border-left: 4px solid #ff9800; 
    }
    .note-card[data-importance="very"] { 
      background: #ffebee; 
      border-left: 4px solid #f44336; 
    }
    

    .note-card.done {
      opacity: 0.7;
      background: #f0f0f0 !important;
    }
    .calendar-placeholder {
      margin: 2rem 0 1rem 0;
      padding: 1.5rem;
      background: #E1F5FE;
      border-radius: 1.2rem;
      text-align: center;
      color: #00BFAE;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .notification-placeholder {
      margin: 1rem 0 0 0;
      padding: 1rem;
      background: #FFF6B7;
      border-radius: 1.2rem;
      text-align: center;
      color: #FF8A65;
      font-size: 1rem;
    }
    .nav-island {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      width: 320px;
      max-width: 92vw;
      height: 90px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
      opacity: 1;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nav-island.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateX(-50%) translateY(100px);
    }
    .bottom-nav {
      position: relative;
      background: linear-gradient(90deg, #c7dbff 0%, #a7c7e7 100%);
      box-shadow: 0 4px 16px rgba(108,99,255,0.10), 0 1.5px 8px rgba(0,0,0,0.04);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      width: 260px;
      border-radius: 28px;
      padding: 0 24px;
      z-index: 1;
    }
    .bottom-nav .nav-btn {
      background: none;
      border: none;
      font-size: 2rem;
      color: #e7a7c7;
      cursor: pointer;
      outline: none;
      padding: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .bottom-nav .nav-btn.active {
      color: #6C63FF;
    }
    .bottom-nav .nav-btn.settings {
      color: #4CAF50;
    }

    .fab {
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: #5d9cff;
      color: #b3f0ff;
      border: none;
      border-radius: 50%;
      width: 80px;
      height: 80px;
      font-size: 3.2rem;
      box-shadow: 0 8px 24px rgba(108,99,255,0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
      outline: none;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .fab.hidden {
      transform: translateX(-50%) translateY(100px);
    }
    .fab:active {
      background: #4d7fd6;
    }
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(60, 60, 100, 0.18);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s;
    }
    
    /* Category modal should appear above other modals */
    #categoryModalOverlay {
      z-index: 300;
    }
    .modal-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .modal {
      background: #fff;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px rgba(108,99,255,0.13);
      padding: 2rem 1.2rem 1.2rem 1.2rem;
      width: 95vw;
      max-width: 400px;
      position: relative;
      z-index: 201;
      display: flex;
      flex-direction: column;
      gap: 1.1rem;
      animation: modalIn 0.25s cubic-bezier(.4,1.6,.6,1) 1;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    @media (max-width: 768px) {
      .modal {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        padding: 1rem;
        margin: 0;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .modal-overlay {
        align-items: stretch;
        justify-content: stretch;
      }
      
      .modal-btn-row {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: 1rem 0;
        margin-top: auto;
        border-top: 1px solid #e0e0e0;
      }
      
      .floating-island {
        margin: 1rem auto 0 auto;
        padding: 1rem 0.8rem 1rem 0.8rem;
        border-radius: 1.5rem;
        overflow-x: hidden;
      }
      
      .notes-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      
      .note-card {
        min-height: 100px;
        padding: 0.8rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .nav-island {
        width: 280px;
        height: 80px;
        bottom: 15px;
        touch-action: manipulation;
      }
      
      .fab {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        touch-action: manipulation;
      }
      
      .this-week-calendar {
        margin: 0.8rem 0 1rem 0;
        overflow-x: hidden;
      }
      
      .this-week-header {
        padding: 0.8rem 1rem;
      }
      
      .this-week-title {
        font-size: 1rem;
      }
      
      .week-nav-btn {
        width: 28px;
        height: 28px;
        font-size: 1rem;
        touch-action: manipulation;
        min-height: 44px;
        min-width: 44px;
      }
      
      .this-week-grid {
        padding: 0.3rem;
        overflow-x: hidden;
      }
      
      .week-day {
        min-height: 60px;
        padding: 0.3rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .week-day.today .week-day-number {
        width: 28px;
        height: 28px;
        font-size: 0.7rem;
      }
      
      .week-day-number {
        font-size: 0.8rem;
        margin-bottom: 0.2rem;
      }
      
      .week-day-name {
        font-size: 0.6rem;
        margin-bottom: 0.3rem;
      }
      
      .week-task {
        font-size: 0.6rem;
        padding: 0.1rem 0.3rem;
        touch-action: manipulation;
      }
      
      .search-icon-btn {
        width: 44px;
        height: 44px;
        font-size: 1rem;
        touch-action: manipulation;
        min-height: 44px;
        min-width: 44px;
      }
      
      .search-expanded {
        padding: 0.4rem 0.8rem;
      }
      
      .search-expanded input {
        font-size: 0.9rem;
        touch-action: auto;
      }
      
      .filter-chips {
        gap: 0.4rem;
        margin: 0 0 1rem 0;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding: 0.5rem 0;
      }
      
      .chip {
        padding: 0.3rem 0.8rem;
        font-size: 0.9rem;
        min-height: 44px; /* iOS minimum touch target */
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
        cursor: pointer;
        flex-shrink: 0;
      }
      
      #chipContainer {
        flex: 1;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .calendar-window {
        flex-direction: column;
        overflow-x: hidden;
      }
      
      /* Mobile button improvements */
      .modal-btn, .modal-btn.cancel {
        min-height: 48px; /* Android minimum touch target */
        min-width: 48px;
        font-size: 1rem;
        padding: 0.8rem 1.2rem;
        margin: 0.3rem;
        border-radius: 0.8rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .sort-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .header-ai-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .ai-action-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        margin: 0.3rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .ai-send-btn {
        min-height: 48px;
        min-width: 48px;
        font-size: 1.2rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .ai-home-btn {
        min-height: 48px;
        min-width: 48px;
        font-size: 1.2rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .calendar-nav-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 0.8rem;
        font-size: 1rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .selector-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .close-selector-btn {
        min-height: 44px;
        min-width: 44px;
        font-size: 1.2rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .urgency-dot, .importance-dot {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .term-tag {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .category-chip {
        min-height: 44px;
        min-width: 44px;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      .voice-btn {
        min-height: 48px;
        min-width: 48px;
        font-size: 1.2rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      /* Settings buttons */
      #testNotificationBtn, #testSoundBtn {
        min-height: 48px;
        min-width: 48px;
        padding: 0.8rem 1.2rem;
        font-size: 0.9rem;
        margin: 0.3rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      /* Clear search button */
      #clearSearchBtn {
        min-height: 44px;
        min-width: 44px;
        font-size: 1.2rem;
        padding: 0.5rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      /* Bottom nav buttons */
      .bottom-nav .nav-btn {
        min-height: 48px;
        min-width: 48px;
        font-size: 1.5rem;
        padding: 0.5rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      /* Ensure all buttons are clickable */
      button, [role="button"] {
        cursor: pointer;
        touch-action: manipulation;
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        user-select: none;
      }
      
      /* Prevent text selection on buttons */
      button, [role="button"], .chip, .note-card {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      /* Improve touch feedback */
      button:active, [role="button"]:active, .chip:active, .note-card:active {
        transform: scale(0.98);
        transition: transform 0.1s;
      }
      
      /* Ensure proper spacing for touch targets */
      .modal-btn-row {
        gap: 0.5rem;
        padding: 1rem;
      }
      
      .filter-chips {
        padding: 0.5rem 0;
      }
      
      /* Improve modal scrolling */
      .modal {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      /* Ensure settings buttons are properly spaced */
      .setting-group {
        margin-bottom: 1rem;
      }
      
      .setting-group button {
        display: block;
        width: 100%;
        margin: 0.5rem 0;
      }
      
      /* Improve mobile scrolling */
      .modal, .ai-content, .calendar-bottom-section {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      
      /* Better touch targets for calendar */
      .calendar-day {
        min-height: 60px;
        cursor: pointer;
        touch-action: manipulation;
      }
      
      .calendar-task {
        min-height: 24px;
        padding: 0.4rem 0.6rem;
        font-size: 0.7rem;
        touch-action: manipulation;
        cursor: pointer;
      }
      
      /* Improve AI chat interaction */
      .ai-message {
        margin-bottom: 1rem;
        padding: 0.8rem;
      }
      
      .ai-quick-actions {
        gap: 0.5rem;
        margin-top: 0.8rem;
      }
      
      /* Better spacing for mobile */
      .modal h2 {
        margin-bottom: 1rem;
        font-size: 1.4rem;
      }
      
      .modal label {
        margin-bottom: 0.5rem;
        font-size: 1rem;
      }
      
      /* Ensure proper z-index for mobile */
      .modal-overlay {
        z-index: 1000;
      }
      
      .nav-island {
        z-index: 1000;
      }
      
      .fab {
        z-index: 1001;
      }
      
      /* Fix horizontal scrolling issues */
      .floating-island, .modal, .calendar-window, .ai-window {
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      /* Ensure proper touch scrolling */
      .notes-grid, .filter-chips, .modal, .calendar-window, .ai-window {
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      
      /* Fix calendar grid overflow */
      .calendar-grid {
        overflow-x: hidden;
        max-width: 100%;
      }
      
      /* Ensure week calendar doesn't overflow */
      .this-week-grid {
        max-width: 100%;
        overflow-x: hidden;
      }
      
      /* Fix search expansion */
      .search-expanded {
        max-width: 100%;
        overflow-x: hidden;
      }
      
      /* Ensure all interactive elements have proper touch targets */
      .week-day, .calendar-day, .note-card, .chip, button, [role="button"] {
        position: relative;
        z-index: 1;
      }
      
      /* Prevent buttons from being hidden behind other elements */
      .modal-overlay {
        z-index: 1000;
      }
      
      .nav-island {
        z-index: 999;
      }
      
      .fab {
        z-index: 998;
      }
      
      /* Ensure buttons are always clickable */
      button:not([disabled]), [role="button"]:not([disabled]) {
        pointer-events: auto;
        cursor: pointer;
      }
      
      /* High contrast for better accessibility */
      button:focus, [role="button"]:focus {
        outline: 2px solid #6C63FF;
        outline-offset: 2px;
      }
      
      /* Ensure proper contrast ratios */
      .modal-btn, .sort-btn, .header-ai-btn {
        color: white;
        background: #6C63FF;
      }
      
      .modal-btn.cancel {
        color: #666;
        background: #f0f0f0;
        border: 1px solid #ddd;
      }
    }
    
    /* Extra small screens (phones) */
    @media (max-width: 480px) {
      .floating-island {
        margin: 0.5rem auto 0 auto;
        padding: 0.8rem 0.6rem 0.8rem 0.6rem;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      .header-title {
        font-size: 1.6rem;
      }
      
      .header-ai-btn {
        padding: 0.5rem 0.8rem;
        font-size: 0.8rem;
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
      }
      
      .search-bar {
        padding: 0.3rem 0.6rem;
      }
      
      .search-bar input {
        font-size: 0.85rem;
      }
      
      .chip {
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        min-height: 40px;
        min-width: 40px;
        touch-action: manipulation;
      }
      
      .note-card {
        padding: 0.6rem;
        min-height: 80px;
        touch-action: manipulation;
      }
      
      .note-title {
        font-size: 1rem;
      }
      
      .nav-island {
        width: 260px;
        height: 70px;
        bottom: 10px;
        touch-action: manipulation;
      }
      
      .bottom-nav {
        width: 240px;
        height: 50px;
        padding: 0 20px;
      }
      
      .bottom-nav .nav-btn {
        font-size: 1.3rem;
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
      }
      
      .fab {
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
        bottom: 15px;
        touch-action: manipulation;
      }
      
      .modal {
        padding: 0.8rem;
        max-width: 100vw;
        overflow-x: hidden;
      }
      
      .modal h2 {
        font-size: 1.3rem;
      }
      
      .modal-btn {
        padding: 0.7rem 1rem;
        font-size: 0.9rem;
        min-height: 44px;
        touch-action: manipulation;
      }
      
      /* Ensure buttons don't overlap */
      .modal-btn-row {
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .modal-btn-row .modal-btn {
        width: 100%;
        margin: 0.2rem 0;
      }
    }
    
    /* Tall narrow displays (like 1264x2780) */
    @media (min-height: 2000px) and (max-width: 1400px) {
      .floating-island {
        margin: 3rem auto 0 auto;
        max-width: 600px;
        padding: 2.5rem 1.5rem 2.5rem 1.5rem;
      }
      
      .header-title {
        font-size: 2.2rem;
        margin-bottom: 1rem;
      }
      
      .header-ai-btn {
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
      }
      
      .search-bar {
        margin: 0 0 1.5rem 0;
        padding: 0.8rem 1.2rem;
      }
      
      .search-bar input {
        font-size: 1.1rem;
      }
      
      .filter-chips {
        margin: 0 0 1.5rem 0;
        gap: 0.8rem;
      }
      
      .chip {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        min-height: 48px;
        min-width: 48px;
      }
      
      .notes-grid {
        gap: 1.2rem;
        margin: 0 0 3rem 0;
      }
      
      .note-card {
        padding: 1.2rem;
        min-height: 140px;
        border-radius: 1.5rem;
      }
      
      .note-title {
        font-size: 1.2rem;
        margin-bottom: 0.8rem;
      }
      
      .note-categories {
        margin-top: 0.5rem;
        gap: 0.4rem;
      }
      
      .note-category {
        font-size: 0.9rem;
        padding: 0.3rem 0.8rem;
      }
      
      .note-term-tags {
        margin-top: 0.5rem;
        gap: 0.4rem;
      }
      
      .term-tag-display {
        font-size: 0.8rem;
        padding: 0.3rem 0.7rem;
      }
      
      .note-importance {
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      
      .due-date-text {
        font-size: 0.9rem;
        margin-top: 0.8rem;
      }
      
      .note-duration {
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      
      .nav-island {
        width: 360px;
        height: 100px;
        bottom: 30px;
      }
      
      .bottom-nav {
        width: 320px;
        height: 70px;
        padding: 0 30px;
        border-radius: 35px;
      }
      
      .bottom-nav .nav-btn {
        font-size: 1.8rem;
        min-height: 50px;
        min-width: 50px;
      }
      
      .fab {
        width: 80px;
        height: 80px;
        font-size: 2rem;
        bottom: 25px;
      }
      
      .modal {
        max-width: 500px;
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        border-radius: 2rem;
      }
      
      .modal h2 {
        font-size: 1.6rem;
        margin-bottom: 1.5rem;
      }
      
      .modal label {
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
      }
      
      .modal textarea, .modal input[type="text"], .modal select, .modal input[type="date"] {
        padding: 1rem;
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
        border-radius: 1rem;
      }
      
      .modal-btn {
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        min-height: 52px;
        border-radius: 1rem;
      }
      
      .urgency-dot, .importance-dot {
        min-height: 48px;
        min-width: 48px;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
      }
      
      .term-tag, .category-chip {
        min-height: 48px;
        min-width: 48px;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
      }
      
      .voice-btn {
        min-height: 52px;
        min-width: 52px;
        font-size: 1.4rem;
      }
      
      /* Settings buttons for tall displays */
      #testNotificationBtn, #testSoundBtn {
        min-height: 52px;
        min-width: 52px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        margin: 0.5rem;
      }
      
      /* Clear search button */
      #clearSearchBtn {
        min-height: 48px;
        min-width: 48px;
        font-size: 1.3rem;
        padding: 0.6rem;
      }
      
      /* AI window optimizations */
      .ai-header {
        padding: 1.5rem;
      }
      
      .ai-title {
        font-size: 1.8rem;
      }
      
      .ai-subtitle {
        font-size: 1rem;
      }
      
      .ai-home-btn {
        width: 55px;
        height: 55px;
        font-size: 1.4rem;
      }
      
      .ai-content {
        padding: 1rem;
      }
      
      .ai-message {
        margin-bottom: 1.5rem;
        padding: 1rem;
      }
      
      .ai-text {
        font-size: 1rem;
        line-height: 1.6;
      }
      
      .ai-quick-actions {
        gap: 0.8rem;
        margin-top: 1rem;
      }
      
      .ai-action-btn {
        min-height: 48px;
        min-width: 48px;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
        margin: 0.4rem;
      }
      
      .ai-input-wrapper {
        gap: 0.5rem;
        padding: 1rem;
      }
      
      .ai-input-wrapper textarea {
        font-size: 1rem;
        padding: 1rem;
        border-radius: 1rem;
      }
      
      .ai-send-btn {
        min-height: 52px;
        min-width: 52px;
        font-size: 1.4rem;
      }
      
      /* Calendar optimizations for tall displays */
      .calendar-header {
        margin: 2rem;
        padding-bottom: 1rem;
      }
      
      .calendar-title {
        font-size: 1.8rem;
      }
      
      .calendar-nav-btn {
        min-height: 48px;
        min-width: 48px;
        padding: 0.8rem 1rem;
        font-size: 1.2rem;
      }
      
      .calendar-grid {
        margin: 0 2rem 2rem 2rem;
        gap: 1px;
      }
      
      .calendar-day {
        min-height: 80px;
        padding: 0.6rem;
      }
      
      .calendar-day-number {
        font-size: 1rem;
        top: 0.6rem;
        left: 0.6rem;
      }
      
      .calendar-day-content {
        margin-top: 2rem;
        gap: 0.4rem;
      }
      
      .calendar-task {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
        min-height: 28px;
      }
      
      /* Ensure proper spacing for tall displays */
      .modal-btn-row {
        gap: 0.8rem;
        padding: 1.5rem 0;
      }
      
      .filter-chips {
        padding: 0.8rem 0;
      }
      
      /* Improve scrolling for tall displays */
      .modal, .ai-content, .calendar-bottom-section {
        max-height: 80vh;
        overflow-y: auto;
      }
      
      /* Ensure all buttons are accessible on all devices */
      button, [role="button"], .chip, .note-card {
        position: relative;
        z-index: 1;
      }
      
      /* Prevent buttons from being hidden behind other elements */
      .modal-overlay {
        z-index: 1000;
      }
      
      .nav-island {
        z-index: 999;
      }
      
      .fab {
        z-index: 998;
      }
      
      /* Ensure buttons are always clickable */
      button:not([disabled]), [role="button"]:not([disabled]) {
        pointer-events: auto;
        cursor: pointer;
      }
      
      /* High contrast for better accessibility */
      button:focus, [role="button"]:focus {
        outline: 2px solid #6C63FF;
        outline-offset: 2px;
      }
      
      /* Ensure proper contrast ratios */
      .modal-btn, .sort-btn, .header-ai-btn {
        color: white;
        background: #6C63FF;
      }
      
      .modal-btn.cancel {
        color: #666;
        background: #f0f0f0;
        border: 1px solid #ddd;
      }
    }
    @keyframes modalIn {
      from { transform: translateY(40px) scale(0.98); opacity: 0; }
      to { transform: none; opacity: 1; }
    }
    .modal h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.3rem;
      color: #6C63FF;
      text-align: center;
      font-family: 'Montserrat', sans-serif;
    }
    .modal label {
      font-size: 1rem;
      margin-bottom: 0.3rem;
      display: block;
      color: #444;
    }
    .modal textarea, .modal input[type="text"] {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      resize: vertical;
      font-family: inherit;
      background: #f7f8fc;
    }
    .modal .voice-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    .modal .voice-btn {
      background: #A7C7E7;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    .modal .voice-btn.recording {
      background: #FF8A65;
      color: #fff;
    }
    .modal select {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      background: #f7f8fc;
      margin-bottom: 0.5rem;
    }
    .modal input[type="date"] {
      width: 100%;
      border-radius: 0.8rem;
      border: 1px solid #e0e0e0;
      padding: 0.7rem;
      font-size: 1rem;
      background: #f7f8fc;
      margin-bottom: 0.5rem;
    }
    .urgency-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    .urgency-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .urgency-dot.selected {
      border: 3px solid #6C63FF;
      box-shadow: 0 2px 8px rgba(108,99,255,0.13);
    }
    .urgency-dot[data-level="1"] { background: #FF4444; }
    .urgency-dot[data-level="2"] { background: #FF8800; }
    .urgency-dot[data-level="3"] { background: #FFCC00; }
    .urgency-dot[data-level="4"] { background: #00CC44; }
    .urgency-dot[data-level="5"] { background: #0066CC; }
    .term-tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .term-tag {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    .term-tag.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    .term-tag[data-term="short"] { border-color: #FF6B6B; color: #FF6B6B; }
    .term-tag[data-term="short"].selected { background: #FF6B6B; color: #fff; }
    .term-tag[data-term="medium"] { border-color: #FFA726; color: #FFA726; }
    .term-tag[data-term="medium"].selected { background: #FFA726; color: #fff; }
    .term-tag[data-term="long"] { border-color: #4CAF50; color: #4CAF50; }
    .term-tag[data-term="long"].selected {
      background: #4CAF50;
      color: #fff;
    }
    .category-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .category-chip {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    .category-chip.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    .category-settings-btn {
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      margin-left: 0.5rem;
      padding: 0.2rem;
      border-radius: 0.3rem;
      transition: background 0.2s;
    }
    .category-settings-btn:hover {
      background: #f0f0f0;
    }
    .modal-btn-row {
      display: flex;
      justify-content: space-between;
      gap: 0.8rem;
      margin-top: 1.2rem;
      flex-wrap: wrap;
    }
    .modal-btn {
      padding: 0.7rem 1.2rem;
      border-radius: 1.2rem;
      border: none;
      font-size: 0.9rem;
      font-family: inherit;
      cursor: pointer;
      background: #6C63FF;
      color: #fff;
      transition: background 0.2s;
      white-space: nowrap;
      min-width: fit-content;
      flex: 1;
      text-align: center;
    }
    .modal-btn.cancel {
      background: #e0e0e0;
      color: #444;
    }
    .modal-btn.delete {
      background: #FF6B6B;
      color: #fff;
    }
    .modal-btn.delete:hover {
      background: #e55555;
    }
    .modal-btn.delete:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    .modal-btn:active {
      background: #574fd6;
    }
    
    /* Responsive modal button layout */
    @media (max-width: 480px) {
      .modal-btn-row {
        flex-direction: column;
        gap: 0.6rem;
      }
      
      .modal-btn {
        width: 100%;
        padding: 0.8rem 1rem;
        font-size: 1rem;
      }
    }
    /* Settings Modal Styles */
    .settings-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }
    .settings-section h3 {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 0.8rem;
      font-family: 'Montserrat', sans-serif;
    }
    .urgency-settings {
      display: flex;
      flex-direction: column;
      gap: 0.7rem;
    }
    .urgency-setting {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      color: #444;
    }
    .urgency-setting select {
      width: 120px;
      padding: 0.4rem;
      border-radius: 0.6rem;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      background: #f7f8fc;
    }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-size: 0.95rem;
      color: #444;
    }
    .switch {
      position: relative;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      -webkit-transition: .4s;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #6C63FF;
    }
    input:focus + .slider {
      box-shadow: 0 0 1px #6C63FF;
    }
    input:checked + .slider:before {
      -webkit-transform: translateX(20px);
      -ms-transform: translateX(20px);
      transform: translateX(20px);
    }
    
    /* Category Management Modal Styles */
    .category-management-section {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .category-management-section h3 {
      font-size: 1.1rem;
      color: #555;
      margin-bottom: 0.8rem;
      font-family: 'Montserrat', sans-serif;
    }
    
    .add-category-form {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .add-category-form input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }
    
    .existing-categories {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f7f8fc;
      border-radius: 0.5rem;
      border: 1px solid #e0e0e0;
    }
    
    .category-item span {
      font-size: 0.9rem;
      color: #444;
    }
    
    .delete-btn {
      background: #FF6B6B;
      color: #fff;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .delete-btn:hover {
      background: #e55555;
    }
    
    /* Calendar Modal Styles */
    .calendar-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
    }
    
    /* Calendar as separate window */
    .calendar-window {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
      z-index: 1000;
      display: none;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .calendar-top-section {
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 16px rgba(108,99,255,0.08);
      overflow: hidden;
      margin: 1rem;
    }
    
    /* Ensure nav island stays visible in calendar view */
    .calendar-window.active .nav-island {
      display: flex !important;
      z-index: 1001;
      position: fixed !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    
    /* Ensure FAB (+ button) stays visible in calendar view */
    .calendar-window.active .fab {
      display: flex !important;
      z-index: 1001;
      position: fixed !important;
      bottom: 20px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
    }
    
    .calendar-window.active {
      display: flex;
    }
    
    /* Calendar window uses the same nav island as main dashboard */
    
    /* Month/Year Selector Styles */
    .month-year-selector {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border-radius: 1.2rem;
      box-shadow: 0 4px 16px rgba(108,99,255,0.08);
      padding: 1.5rem;
      z-index: 2000;
      min-width: 300px;
      max-width: 90vw;
    }
    
    .month-year-selector.hidden {
      display: none;
    }
    
    .selector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      margin: -1.5rem -1.5rem 1rem -1.5rem;
      border-radius: 1.2rem 1.2rem 0 0;
    }
    
    .selector-header h3 {
      margin: 0;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .close-selector-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-selector-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .selector-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .year-selector, .month-selector {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .year-selector label, .month-selector label {
      font-weight: 500;
      color: #333;
    }
    
    .year-selector select, .month-selector select {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
      background: #f8f9fa;
    }
    
    .selector-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .selector-btn {
      flex: 1;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    .selector-btn:not(.cancel) {
      background: #6C63FF;
      color: #fff;
      box-shadow: 0 2px 8px rgba(108,99,255,0.13);
    }
    
    .selector-btn.cancel {
      background: #f0f0f0;
      color: #666;
    }
    
    .selector-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(108,99,255,0.25);
    }
    
    /* Dark mode for selector */
    body.dark-mode .month-year-selector {
      background: #2c3e50;
      color: #e0e0e0;
    }
    
    body.dark-mode .selector-header h3 {
      color: #64b5f6;
    }
    
    body.dark-mode .year-selector select, 
    body.dark-mode .month-selector select {
      background: #37474f;
      border-color: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .selector-btn.cancel {
      background: #37474f;
      color: #b0bec5;
    }
    
    /* Mobile-specific calendar layout */
    @media (max-width: 768px) {
      .calendar-modal {
        flex-direction: column;
      }
      
      /* Mobile improvements for weekly category tags */
      .week-category-tag {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        max-width: 60px;
      }
      
      .week-categories-container {
        gap: 0.2rem;
      }
      
      .week-note-item .week-categories-container {
        max-width: 120px;
      }
      
      .calendar-top-section {
        height: 50vh; /* Reduced from 60vh to make calendar smaller */
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .calendar-top-section.compact {
        height: 30vh; /* Even smaller when date is selected */
      }
      
      .calendar-bottom-section {
        height: 50vh; /* Increased from 40vh to give more space for notes */
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        overflow-y: auto;
        padding: 1rem;
        transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .calendar-bottom-section.expanded {
        height: 70vh; /* Much larger when date is selected */
        animation: expandSection 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .calendar-bottom-section.hidden {
        display: none;
      }
    }
      
      .calendar-day {
        min-height: 50px;
        padding: 0.25rem;
      }
      
      .calendar-day-number {
        font-size: 0.8rem;
        top: 0.25rem;
        left: 0.25rem;
      }
      
      .calendar-day-content {
        margin-top: 1.2rem;
        gap: 0.2rem;
      }
      
      .calendar-task {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }
      
      .calendar-header {
        margin: 1rem;
        padding-bottom: 0.5rem;
      }
      
      .calendar-title {
        font-size: 1.2rem;
      }
      
      .calendar-nav-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
      
      .calendar-grid {
        margin: 0 1rem 1rem 1rem;
        gap: 0.5px;
      }
      
      .calendar-day-header {
        padding: 0.5rem 0.2rem;
        font-size: 0.8rem;
      }
      
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #fff;
        margin: 0;
        border-radius: 1.2rem 1.2rem 0 0;
      }
      
      .calendar-nav {
        display: flex;
        gap: 0.5rem;
      }
      
      .calendar-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 0;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      
      .calendar-title:hover {
        opacity: 0.8;
      }
      
      .calendar-nav-btn {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .calendar-nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #f0f0f0;
      padding: 0.5rem;
      flex: 1;
      margin: 0;
    }
    
    .calendar-day-header {
      background: #f8f9fa;
      padding: 1rem 0.5rem;
      text-align: center;
      font-weight: 600;
      color: #666;
      font-size: 0.9rem;
      border-radius: 0.5rem;
    }
    
    .calendar-day {
      background: #fff;
      min-height: 65px;
      padding: 0.4rem;
      border-radius: 0.5rem;
      position: relative;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .calendar-day:hover {
      box-shadow: 0 4px 12px rgba(108,99,255,0.15);
    }
    
    .calendar-day:last-child {
      border-right: none;
    }
    
    .calendar-day-number {
      position: absolute;
      top: 0.4rem;
      left: 0.4rem;
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }
    
    .calendar-day-content {
      margin-top: 1.6rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    
    .calendar-task {
      background: #e3f2fd;
      color: #1976d2;
      padding: 0.3rem 0.5rem;
      border-radius: 0.3rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid transparent;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .calendar-task:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .calendar-task.work { background: #fff3e0; color: #f57c00; }
    .calendar-task.personal { background: #e8f5e8; color: #388e3c; }
    .calendar-task.school { background: #f3e5f5; color: #7b1fa2; }
    .calendar-task.home { background: #fce4ec; color: #c2185b; }
    .calendar-task.other { background: #f5f5f5; color: #616161; }
    
    /* Dark Mode Calendar Styles */
    body.dark-mode .calendar-content {
      background: #16213e;
      color: #fff;
    }
    
    body.dark-mode .calendar-title {
      color: #fff;
    }
    
    body.dark-mode .calendar-day-header {
      background: #0f3460;
      color: #00ffff;
      border-bottom-color: #333;
    }
    
    body.dark-mode .calendar-day {
      background: #16213e;
      border-color: #333;
    }
    
    body.dark-mode .calendar-day-number {
      color: #fff;
    }
    
    body.dark-mode .calendar-task {
      background: #0f3460;
      color: #00ffff;
    }
    
    body.dark-mode .calendar-task.work { background: #2d1b0f; color: #ffaa00; }
    body.dark-mode .calendar-task.personal { background: #0f2f0f; color: #4caf50; }
    body.dark-mode .calendar-task.school { background: #2d0f2f; color: #ba68c8; }
    body.dark-mode .calendar-task.home { background: #2f0f1f; color: #f06292; }
    body.dark-mode .calendar-task.other { background: #1f1f1f; color: #9e9e9e; }
    
    /* Dark mode for calendar window */
    body.dark-mode .calendar-window {
      background: #16213e;
      color: #fff;
    }
    
    body.dark-mode .calendar-window .calendar-bottom-section {
      background: #0f3460;
      border-top-color: #333;
    }
    
    /* Calendar window uses the same nav island styling as main dashboard */
    
    /* AI Window Styles */
    .ai-window {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff;
      z-index: 1000;
      display: none;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .ai-window.active {
      display: flex;
    }
    
    .ai-header {
      padding: 2rem;
      border-bottom: 1px solid #eee;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    
    .ai-header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .ai-header-left {
      text-align: left;
    }
    
    .ai-home-btn {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .ai-home-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .ai-title {
      font-size: 2rem;
      font-weight: 700;
      margin: 0 0 0.5rem 0;
      font-family: 'Montserrat', sans-serif;
    }
    
    .ai-subtitle {
      font-size: 1rem;
      opacity: 0.9;
    }
    
    .ai-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    
    .ai-chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }
    
    .ai-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .ai-message {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
    }
    
    .ai-message.ai-assistant {
      flex-direction: row;
    }
    
    .ai-message.ai-user {
      flex-direction: row-reverse;
    }
    
    .ai-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      flex-shrink: 0;
    }
    
    .ai-message.ai-assistant .ai-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    
    .ai-message.ai-user .ai-avatar {
      background: #6C63FF;
      color: #fff;
    }
    
    .ai-text {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 1rem;
      max-width: 70%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .ai-message.ai-user .ai-text {
      background: #6C63FF;
      color: #fff;
    }
    
    .ai-text p {
      margin: 0 0 0.5rem 0;
      line-height: 1.5;
    }
    
    .ai-text p:last-child {
      margin-bottom: 0;
    }
    
    /* Markdown formatting for AI responses */
    .ai-text h3 {
      color: #6C63FF;
      margin: 1rem 0 0.5rem 0;
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .ai-text h3:first-child {
      margin-top: 0;
    }
    
    .ai-text strong {
      color: #6C63FF;
      font-weight: 600;
    }
    
    .ai-text ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    
    .ai-text li {
      margin-bottom: 0.3rem;
      line-height: 1.4;
    }
    
    .ai-text ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
    }
    
    .ai-text li {
      margin-bottom: 0.3rem;
    }
    
    .ai-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .ai-action-btn {
      background: rgba(108, 99, 255, 0.1);
      color: #6C63FF;
      border: 1px solid #6C63FF;
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .ai-action-btn:hover {
      background: #6C63FF;
      color: #fff;
      transform: translateY(-1px);
    }
    
    .ai-input-container {
      padding: 1rem 0;
      border-top: 1px solid #eee;
    }
    
    .ai-input-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }
    
    .ai-input-wrapper textarea {
      flex: 1;
      border: 2px solid #e0e0e0;
      border-radius: 1rem;
      padding: 0.8rem;
      font-size: 1rem;
      resize: none;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .ai-input-wrapper textarea:focus {
      outline: none;
      border-color: #6C63FF;
    }
    
    .ai-send-btn {
      background: #6C63FF;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 1.5rem;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    
    .ai-send-btn:hover {
      background: #574fd6;
    }
    
    /* Dark Mode AI Styles */
    body.dark-mode .ai-window {
      background: #16213e;
      color: #e0e0e0;
    }
    
    body.dark-mode .ai-header {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }
    
    body.dark-mode .ai-home-btn {
      background: rgba(255, 255, 255, 0.1);
    }
    
    body.dark-mode .ai-home-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    body.dark-mode .ai-text {
      background: #37474f;
      color: #e0e0e0;
    }
    
    body.dark-mode .ai-message.ai-user .ai-text {
      background: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .ai-input-wrapper textarea {
      background: #37474f;
      border-color: #546e7a;
      color: #e0e0e0;
    }
    
    body.dark-mode .ai-input-wrapper textarea:focus {
      border-color: #64b5f6;
    }
    
    body.dark-mode .ai-send-btn {
      background: #546e7a;
    }
    
    body.dark-mode .ai-send-btn:hover {
      background: #455a64;
    }
    
    /* Mobile AI Styles */
    @media (max-width: 768px) {
      .ai-header {
        padding: 1rem;
      }
      
      .ai-header-content {
        gap: 1rem;
      }
      
      .ai-title {
        font-size: 1.5rem;
      }
      
      .ai-home-btn {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
      }
      
      .ai-content {
        padding: 0.5rem;
      }
      
      .ai-text {
        max-width: 85%;
      }
      
      .ai-input-wrapper {
        gap: 0.3rem;
      }
      
      .ai-send-btn {
        width: 45px;
        height: 45px;
        font-size: 1.2rem;
      }
    }
    
    /* Calendar task importance colors */
    .calendar-task[data-importance="1"] { 
      color: #4caf50 !important; 
      background: rgba(76, 175, 80, 0.1) !important;
      border-left: 3px solid #4caf50 !important;
    }
    .calendar-task[data-importance="2"] { 
      color: #ff9800 !important; 
      background: rgba(255, 152, 0, 0.1) !important;
      border-left: 3px solid #ff9800 !important;
    }
    .calendar-task[data-importance="3"] { 
      color: #ffc107 !important; 
      background: rgba(255, 193, 7, 0.1) !important;
      border-left: 3px solid #ffc107 !important;
    }
    .calendar-task[data-importance="4"] { 
      color: #f44336 !important; 
      background: rgba(244, 67, 54, 0.1) !important;
      border-left: 3px solid #f44336 !important;
    }
    .calendar-task[data-importance="5"] { 
      color: #d32f2f !important; 
      background: rgba(211, 47, 47, 0.1) !important;
      border-left: 3px solid #d32f2f !important;
    }
    
    body.dark-mode .calendar-task[data-importance="1"] { 
      color: #4caf50 !important; 
      background: rgba(76, 175, 80, 0.2) !important;
      border-left: 3px solid #4caf50 !important;
    }
    body.dark-mode .calendar-task[data-importance="2"] { 
      color: #ff9800 !important; 
      background: rgba(255, 152, 0, 0.2) !important;
      border-left: 3px solid #ff9800 !important;
    }
    body.dark-mode .calendar-task[data-importance="3"] { 
      color: #ffc107 !important; 
      background: rgba(255, 193, 7, 0.2) !important;
      border-left: 3px solid #ffc107 !important;
    }
    body.dark-mode .calendar-task[data-importance="4"] { 
      color: #f44336 !important; 
      background: rgba(244, 67, 54, 0.2) !important;
      border-left: 3px solid #f44336 !important;
    }
    body.dark-mode .calendar-task[data-importance="5"] { 
      color: #d32f2f !important; 
      background: rgba(211, 47, 47, 0.2) !important;
      border-left: 3px solid #d32f2f !important;
    }
    
    /* Animated task items */
    .detail-task-item {
      transform: translateY(20px);
      opacity: 0;
      animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .detail-task-item:nth-child(1) { animation-delay: 0.1s; }
    .detail-task-item:nth-child(2) { animation-delay: 0.2s; }
    .detail-task-item:nth-child(3) { animation-delay: 0.3s; }
    .detail-task-item:nth-child(4) { animation-delay: 0.4s; }
    .detail-task-item:nth-child(5) { animation-delay: 0.5s; }
    
    @keyframes slideInUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes expandSection {
      from {
        height: 0;
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        height: 70vh;
        opacity: 1;
        transform: translateY(0);
      }
    }

    .note-card[data-importance="1"] { background: #E8F5E8; border-left: 4px solid #00CC44; }
    .note-card[data-importance="2"] { background: #FFF2E6; border-left: 4px solid #FF8800; }
    .note-card[data-importance="3"] { background: #FFE0B2; border-left: 4px solid #FFCC00; }
    .note-card[data-importance="4"] { background: #FFCCCC; border-left: 4px solid #FF4444; }
    .note-card[data-importance="5"] { background: #FFB3B3; border-left: 4px solid #CC0000; }
    
    /* Dark Mode Importance Note Cards */
    body.dark-mode .note-card[data-importance="1"] { background: #0f2f0f; border-left: 4px solid #4caf50; }
    body.dark-mode .note-card[data-importance="2"] { background: #2d1b0f; border-left: 4px solid #ffaa00; }
    body.dark-mode .note-card[data-importance="3"] { background: #2d2d0f; border-left: 4px solid #ffcc00; }
    body.dark-mode .note-card[data-importance="4"] { background: #2f0f0f; border-left: 4px solid #ff4444; }
    body.dark-mode .note-card[data-importance="5"] { background: #2f0000; border-left: 4px solid #cc0000; }
    
    body.dark-mode .note-importance {
      color: #ccc;
    }
    
    /* Importance Dot Styles */
    .importance-row {
      display: flex;
      align-items: center;
      gap: 0.7rem;
      margin-bottom: 0.5rem;
    }
    
    .importance-dot {
      padding: 0.4rem 1rem;
      border-radius: 1rem;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #666;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    
    .importance-dot.selected {
      border-color: #6C63FF;
      background: #6C63FF;
      color: #fff;
    }
    
    .importance-dot[data-level="slightly"] { 
      border-color: #4caf50; 
      color: #4caf50; 
    }
    .importance-dot[data-level="slightly"].selected { 
      background: #4caf50; 
      color: #fff; 
    }
    .importance-dot[data-level="moderately"] { 
      border-color: #ff9800; 
      color: #ff9800; 
    }
    .importance-dot[data-level="moderately"].selected { 
      background: #ff9800; 
      color: #fff; 
    }
    .importance-dot[data-level="very"] { 
      border-color: #f44336; 
      color: #f44336; 
    }
    .importance-dot[data-level="very"].selected { 
      background: #f44336; 
      color: #fff; 
    }
    

    

    
    /* Done Note Styles */
    .note-card.done {
      opacity: 0.6;
      background: #f8f9fa;
      border-left: 4px solid #28a745;
    }
    
    .note-card.done .note-title {
      text-decoration: line-through;
      color: #6c757d;
    }
    
    /* Dark Mode Done Notes */
    body.dark-mode .note-card.done {
      background: #1b5e20;
      opacity: 0.8;
      border-left-color: #4caf50;
    }
    
    body.dark-mode .note-card.done .note-title {
      color: #90a4ae;
    }
    
    /* Delete hint for done notes */
    .note-delete-hint {
      font-size: 0.75rem;
      color: #28a745;
      margin-top: 0.3rem;
      font-weight: 500;
      font-style: italic;
    }
    
    body.dark-mode .note-delete-hint {
      color: #4caf50;
    }
    
    /* Drag and Drop Styles for Filter Chips */
    .chip {
      transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    .chip.dragging {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(108,99,255,0.3);
      z-index: 1000;
    }
    
    .chip.drop-zone {
      transform: scale(1.05);
      background-color: #e3f2fd;
      border-color: #6C63FF;
    }
    
    .chip.drop-zone.dark-mode {
      background-color: #37474f;
      border-color: #546e7a;
    }
    
    /* Drag indicator */
    #dragIndicator {
      pointer-events: none;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Prevent text selection during drag */
    .filter-chips {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* Long-press hint */
    .chip::after {
      content: '';
      position: absolute;
      top: 2px;
      right: 2px;
      width: 4px;
      height: 4px;
      background: rgba(108,99,255,0.3);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .chip:hover::after {
      opacity: 1;
    }
    
    /* Done Notes Section Styles */
    .done-notes-section {
      padding: 1rem;
      background: #fff;
      border-radius: 1rem;
      margin: 1rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .multi-select-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin: 1rem 0;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }
    
    body.dark-mode .multi-select-actions {
      background: #37474f;
    }
    
    .select-all-btn, .delete-selected-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
      display: none; /* Hidden by default */
    }
    
    .select-all-btn {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .select-all-btn:hover {
      background: #bbdefb;
    }
    
    .delete-selected-btn {
      background: #ffebee;
      color: #d32f2f;
    }
    
    .delete-selected-btn:hover {
      background: #ffcdd2;
    }
    
    /* Multi-select styles for done notes */
    .note-card.done {
      position: relative;
    }
    
    .note-card.done .checkbox {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 20px;
      height: 20px;
      border: 2px solid #28a745;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .note-card.done.selected .checkbox {
      background: #28a745;
      border-color: #28a745;
    }
    
    .note-card.done.selected .checkbox::after {
      content: '';
      color: #fff;
      font-size: 12px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    
    .note-card.done.selected {
      background: #e8f5e8;
      border-color: #4caf50;
      box-shadow: 0 0 0 2px #4caf50;
    }
    
    /* Dark Mode Done Notes */
    body.dark-mode .done-notes-section {
      background: #2d3748;
    }
    
    body.dark-mode .done-notes-header h3 {
      color: #4caf50;
    }
    
    body.dark-mode .note-card.done.selected {
      background: #1b5e20;
      border-color: #4caf50;
    }
    
    /* Calendar Modal Styles */
    
    /* Tutorial Styles - Updated */
    .tutorial-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: none;
      pointer-events: none;
    }
    
    .tutorial-overlay.active {
      display: block;
    }
    
    .tutorial-highlight {
      position: absolute;
      border-radius: 8px;
      background: rgba(108, 99, 255, 0.1);
      border: 2px solid #6C63FF;
      z-index: 10001;
      transition: all 0.3s ease;
      pointer-events: none;
    }
    

    
    .tutorial-tooltip {
      position: absolute;
      background: #2d2d2d;
      color: white;
      padding: 1.2rem;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      max-width: 280px;
      z-index: 10002;
      animation: tutorialFadeIn 0.3s ease;
      pointer-events: auto;
    }
    
    .tutorial-tooltip::before {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      border: 8px solid transparent;
    }
    
    .tutorial-tooltip.top::before {
      border-top-color: #2d2d2d;
      bottom: -16px;
      left: var(--arrow-offset, 50%);
      transform: none;
    }
    
    .tutorial-tooltip.bottom::before {
      border-bottom-color: #2d2d2d;
      top: -16px;
      left: var(--arrow-offset, 50%);
      transform: none;
    }
    
    .tutorial-tooltip.left::before {
      border-left-color: #2d2d2d;
      right: -16px;
      top: var(--arrow-offset, 50%);
      transform: none;
    }
    
    .tutorial-tooltip.right::before {
      border-right-color: #2d2d2d;
      left: -16px;
      top: var(--arrow-offset, 50%);
      transform: none;
    }
    
    .tutorial-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.4rem;
      color: white;
    }
    
    .tutorial-description {
      font-size: 0.85rem;
      line-height: 1.4;
      margin-bottom: 1rem;
      color: #e0e0e0;
    }
    
    .tutorial-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
    }
    
    .tutorial-checkbox {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      color: #b0b0b0;
    }
    
    .tutorial-checkbox input {
      width: 14px;
      height: 14px;
      accent-color: #6C63FF;
    }
    
    .tutorial-nav {
      display: flex;
      gap: 0.5rem;
    }
    
    .tutorial-btn {
      background: #404040;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .tutorial-btn:hover {
      background: #505050;
    }
    
    .tutorial-btn.primary {
      background: #6C63FF;
      color: white;
      font-weight: 500;
    }
    
    .tutorial-btn.primary:hover {
      background: #5a52d5;
    }
    
    .tutorial-progress {
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
      background: rgba(255, 255, 255, 0.1);
      color: #b0b0b0;
      padding: 0.3rem 0.6rem;
      border-radius: 12px;
      font-size: 0.7rem;
    }
    
    .tutorial-close {
      position: absolute;
      top: 0.8rem;
      right: 0.8rem;
      background: none;
      border: none;
      color: #b0b0b0;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .tutorial-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    @keyframes tutorialFadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Additional mobile fixes */
    /* Fix for iOS Safari 100vh issue */
    @supports (-webkit-touch-callout: none) {
      .modal, .ai-window, .calendar-window {
        height: -webkit-fill-available;
      }
    }
    
    /* Ensure proper touch targets on all devices */
    button, [role="button"], .chip, .note-card, .week-day, .calendar-day {
      min-height: 44px;
      min-width: 44px;
      touch-action: manipulation;
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    }
    
    /* Fix for Android Chrome touch issues */
    @media (hover: none) and (pointer: coarse) {
      button:hover, [role="button"]:hover, .chip:hover, .note-card:hover {
        transform: none;
      }
      
      button:active, [role="button"]:active, .chip:active, .note-card:active {
        transform: scale(0.98);
      }
    }
    
    /* Ensure proper scrolling on all mobile devices */
    .modal, .ai-content, .calendar-bottom-section, .notes-grid, .filter-chips {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      overflow-x: hidden;
    }
    
    /* Fix for horizontal scrolling issues */
    .floating-island, .modal, .calendar-window, .ai-window, .notes-grid, .filter-chips {
      max-width: 100vw;
      overflow-x: hidden;
    }
    
          /* Ensure proper z-index stacking */
      .modal-overlay {
        z-index: 1000;
      }
      
      .nav-island {
        z-index: 1000;
      }
      
      .fab {
        z-index: 1001;
      }
    
    /* Fix for iOS Safari momentum scrolling */
    .modal, .ai-content, .calendar-bottom-section {
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body>
  <div class="floating-island">
    <div class="header">
      <div class="header-content">
        <div class="header-title">EZ<span style="color:#222;">Habits</span></div>
        <button class="header-ai-btn" id="headerAiBtn" title="AI Assistant" aria-label="Open AI Assistant">AI</button>
      </div>
    </div>
    
    <!-- This Week Calendar Section -->
    <div class="this-week-calendar" id="thisWeekCalendar">
      <div class="this-week-header">
        <h3 class="this-week-title" id="thisWeekTitle">This Week</h3>
        <div class="this-week-nav">
          <button class="week-nav-btn" id="prevWeekBtn"></button>
          <button class="week-nav-btn" id="nextWeekBtn"></button>
        </div>
      </div>
      <div class="this-week-grid" id="thisWeekGrid">
        <!-- Week calendar will be generated by JavaScript -->
      </div>
      <div class="this-week-notes" id="thisWeekNotes">
        <!-- Week's notes will be shown here -->
      </div>
    </div>
    
    <!-- Search Icon (replaces search bar) -->
    <div class="search-icon-container">
      <button class="search-icon-btn" id="searchIconBtn" title="Search notes" aria-label="Search notes">
        <span class="search-icon"></span>
      </button>
      <div class="search-expanded hidden" id="searchExpanded">
      <input type="text" id="searchInput" placeholder="Search for notes" />
        <button id="clearSearchBtn" class="clear-search-btn" style="display: none;" aria-label="Clear search" title="Clear search"></button>
    </div>
    </div>
    
    <div id="searchResultsCount" style="display: none; text-align: center; color: #666; font-size: 0.9rem; margin: 0.5rem 0;"></div>
    
    <div class="filter-chips" id="filterChips" style="position: relative;">
      <div id="chipContainer"></div>
      <button class="sort-btn" id="sortBtn">Sort </button>
      <div class="sort-dropdown" id="sortDropdown">
        <div class="sort-direction">
          <h4>Sort Direction</h4>
          <div class="direction-buttons">
            <button class="direction-btn" data-direction="asc">Ascending</button>
            <button class="direction-btn" data-direction="desc">Descending</button>
          </div>
        </div>
        <div class="sort-criteria hidden" id="sortCriteria">
          <h4>Sort By</h4>
          <button class="criteria-btn" data-criteria="date">Due Date</button>
          <button class="criteria-btn" data-criteria="added">Date Added</button>
          <button class="criteria-btn" data-criteria="importance">Importance</button>
          <button class="criteria-btn" data-criteria="duration">Duration</button>
        </div>
      </div>
    </div>
    <div class="notes-grid" id="notesGrid"></div>
    
    <!-- Multi-select action buttons (hidden by default) -->
    <div class="multi-select-actions hidden" id="multiSelectActions">
      <button class="select-all-btn" id="selectAllDoneBtn">Select All</button>
      <button class="delete-selected-btn hidden" id="deleteSelectedDoneBtn">Delete Selected</button>
    </div>
    

  </div>
  <div class="nav-island" id="navIsland">
    <nav class="bottom-nav">
      <button class="nav-btn" title="Calendar"> <span style="color:#e7a7c7;">&#128197;</span> </button>
      <button class="nav-btn" title="Done" id="doneTabBtn"> <span style="color:#28a745;">&#9989;</span> </button>
      <button class="nav-btn settings" title="Settings"> <span style="color:#4CAF50;">&#9881;&#65039;</span> </button>
    </nav>
  </div>
      <button class="fab" id="openModalBtn" title="Add Note" aria-label="Add new note">+</button>
  <!-- Modal for adding a note -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <form class="modal" id="addNoteModal">
      <h2>Add Note</h2>
      <label for="noteTitle">Title</label>
      <div class="voice-row">
        <input type="text" id="noteTitle" placeholder="Enter title..." style="width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box;">
        <button type="button" class="voice-btn" id="voiceBtn" title="Record voice note"></button>
      </div>
      <label for="noteDescription">Description (Optional)</label>
      <div class="voice-row">
        <textarea id="noteDescription" rows="3" placeholder="Add description..."></textarea>
        <button type="button" class="voice-btn" id="voiceDescBtn" title="Record voice description"></button>
      </div>
      <label for="customDate">Date</label>
      <input type="date" id="customDate" style="box-sizing: border-box;">
      <label>Categories <button type="button" class="category-settings-btn" id="categorySettingsBtn" title="Manage categories"></button></label>
      <div class="category-row" id="categoryRow">
        <!-- Categories will be dynamically loaded -->
      </div>
      <label>Importance Level</label>
      <div class="importance-row" id="importanceRow">
        <div class="importance-dot" data-level="very" title="Very Important">Very</div>
        <div class="importance-dot" data-level="moderately" title="Moderately Important">Moderately</div>
        <div class="importance-dot" data-level="slightly" title="Slightly Important">Slightly</div>
      </div>
      <label>Term Tags (Optional)</label>
      <div class="term-tags-row" id="termTagsRow">
        <button type="button" class="term-tag" data-term="short">Short-term</button>
        <button type="button" class="term-tag" data-term="medium">Medium-term</button>
        <button type="button" class="term-tag" data-term="long">Long-term</button>
      </div>
      <label for="duration">Duration (optional)</label>
      <div class="duration-inputs">
        <input type="number" id="durationHours" placeholder="Hours" min="0" step="1" style="width: 45%; margin-right: 5%;">
        <input type="number" id="durationMinutes" placeholder="Minutes" min="0" max="59" step="1" style="width: 45%;">
      </div>
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelModalBtn">Cancel</button>
        <button type="submit" class="modal-btn">Save</button>
      </div>
    </form>
  </div>
  <!-- Edit Modal -->
  <div class="modal-overlay hidden" id="editModalOverlay">
    <form class="modal" id="editNoteModal">
      <h2 id="editModalTitle">Edit Note</h2>
      <label for="editNoteTitle">Title</label>
      <div class="voice-row">
        <input type="text" id="editNoteTitle" placeholder="Enter title..." style="width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 0.5rem; font-size: 1rem; box-sizing: border-box;">
        <button type="button" class="voice-btn" id="editVoiceBtn" title="Record voice note"></button>
      </div>
      <label for="editNoteDescription">Description (Optional)</label>
      <div class="voice-row">
        <textarea id="editNoteDescription" rows="3" placeholder="Add description..."></textarea>
        <button type="button" class="voice-btn" id="editVoiceDescBtn" title="Record voice description"></button>
      </div>
      <label for="editCustomDate">Date</label>
      <input type="date" id="editCustomDate" style="box-sizing: border-box;">
      <label>Categories <button type="button" class="category-settings-btn" id="editCategorySettingsBtn" title="Manage categories"></button></label>
      <div class="category-row" id="editCategoryRow">
        <!-- Categories will be dynamically loaded -->
      </div>
      <label>Importance Level</label>
      <div class="importance-row" id="editImportanceRow">
        <div class="importance-dot" data-level="very" title="Very Important">Very</div>
        <div class="importance-dot" data-level="moderately" title="Moderately Important">Moderately</div>
        <div class="importance-dot" data-level="slightly" title="Slightly Important">Slightly</div>
      </div>
      <label>Term Tags (Optional)</label>
      <div class="term-tags-row" id="editTermTagsRow">
        <button type="button" class="term-tag" data-term="short">Short-term</button>
        <button type="button" class="term-tag" data-term="medium">Medium-term</button>
        <button type="button" class="term-tag" data-term="long">Long-term</button>
      </div>
      <label for="editDuration">Duration (optional)</label>
      <div class="duration-inputs">
        <input type="number" id="editDurationHours" placeholder="Hours" min="0" step="1" style="width: 45%; margin-right: 5%;">
        <input type="number" id="editDurationMinutes" placeholder="Minutes" min="0" max="59" step="1" style="width: 45%;">
      </div>
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelEditModalBtn">Cancel</button>
        <button type="button" class="modal-btn delete" id="deleteNoteBtn" style="display: none;">Delete</button>
        <button type="button" class="modal-btn" id="markDoneBtn" style="display: none;">Mark as Done</button>
        <button type="submit" class="modal-btn">Save</button>
      </div>
    </form>
  </div>
  <!-- Settings Modal -->
  <div class="modal-overlay hidden" id="settingsModalOverlay">
    <div class="modal" id="settingsModal">
      <h2>Settings</h2>
      

      
      <div class="settings-section">
        <h3>Appearance</h3>

      </div>
      
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelSettingsBtn">Cancel</button>
        <button type="button" class="modal-btn" id="saveSettingsBtn">Save</button>
      </div>
    </div>
  </div>
  <!-- Category Management Modal -->
  <div class="modal-overlay hidden" id="categoryModalOverlay">
    <div class="modal" id="categoryModal">
      <h2>Manage Categories</h2>
      
      <div class="category-management-section">
        <h3>Add New Category</h3>
        <div class="add-category-form">
          <input type="text" id="newCategoryInput" placeholder="Enter category name" maxlength="20">
          <button type="button" class="modal-btn" id="addCategoryBtn">Add</button>
        </div>
      </div>
      
      <div class="category-management-section">
        <h3>Existing Categories</h3>
        <div class="existing-categories" id="existingCategories">
          <!-- Categories will be populated here -->
        </div>
      </div>
      
      <div class="modal-btn-row">
        <button type="button" class="modal-btn cancel" id="cancelCategoryBtn">Close</button>
      </div>
    </div>
  </div>
  <!-- Calendar Window -->
  <div class="calendar-window" id="calendarWindow">
    <div class="calendar-top-section">
      <div class="calendar-header">
        <h2 class="calendar-title" id="calendarTitle">Calendar</h2>
        <div class="calendar-nav">
          <button class="calendar-nav-btn" id="prevMonthBtn"></button>
          <button class="calendar-nav-btn" id="nextMonthBtn"></button>
        </div>
      </div>
      
      <!-- Month/Year Selector -->
      <div class="month-year-selector hidden" id="monthYearSelector">
        <div class="selector-header">
          <h3>Select Month & Year</h3>
          <button class="close-selector-btn" id="closeSelectorBtn">&times;</button>
        </div>
        <div class="selector-content">
          <div class="year-selector">
            <label>Year:</label>
            <select id="yearSelect"></select>
          </div>
          <div class="month-selector">
            <label>Month:</label>
            <select id="monthSelect"></select>
          </div>
          <div class="selector-buttons">
            <button class="selector-btn" id="applyDateBtn">Apply</button>
            <button class="selector-btn cancel" id="cancelDateBtn">Cancel</button>
          </div>
        </div>
      </div>
      <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar content will be generated by JavaScript -->
      </div>
    </div>
    <div class="calendar-bottom-section hidden" id="calendarBottomSection">
      <div class="selected-date-info">
        <h3 id="selectedDateTitle">Selected Date</h3>
        <div id="selectedDateTasks">
          <!-- Tasks for selected date will be shown here -->
        </div>
      </div>
    </div>
    
    <!-- Calendar uses the same nav island as main dashboard -->
  </div>
  <!-- AI Assistant Window -->
  <div class="ai-window" id="aiWindow">
    <div class="ai-header">
      <div class="ai-header-content">
        <div class="ai-header-left">
          <h2 class="ai-title">AI Assistant</h2>
          <div class="ai-subtitle">Your intelligent habit companion</div>
        </div>
        <button class="ai-home-btn" id="aiHomeBtn" title="Go Home"></button>
      </div>
    </div>
    
    <div class="ai-content">
      <div class="ai-chat-container">
        <div class="ai-messages" id="aiMessages">
          <div class="ai-message ai-assistant">
            <div class="ai-avatar"></div>
            <div class="ai-text">
              <p>Hello! I'm your AI assistant with access to all your notes data. I can help you with:</p>
              <ul>
                <li> Analyzing your progress and completion rates</li>
                <li> Building better habits based on your patterns</li>
                <li> Providing personalized recommendations</li>
                <li> Smart planning using your actual tasks and deadlines</li>
                <li> Identifying areas for improvement</li>
              </ul>
              <p>I have access to your tasks, importance levels, due dates, and categories to provide personalized insights!</p>
              <div class="ai-quick-actions">
                <button class="ai-action-btn" onclick="handleQuickAction('analyze')"> Analyze Progress</button>
                <button class="ai-action-btn" onclick="handleQuickAction('suggest')"> Get Suggestions</button>
                <button class="ai-action-btn" onclick="handleQuickAction('habits')"> Build Habits</button>
                <button class="ai-action-btn" onclick="handleQuickAction('planning')"> Smart Planning</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="ai-input-container">
          <div class="ai-input-wrapper">
            <textarea id="aiInput" placeholder="Ask me anything about habits, productivity, or your goals..." rows="3"></textarea>
            <button class="ai-send-btn" id="aiSendBtn" title="Send message"></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Tutorial Overlay -->
  <div class="tutorial-overlay" id="tutorialOverlay">
    <div class="tutorial-highlight" id="tutorialHighlight"></div>
    <div class="tutorial-tooltip" id="tutorialTooltip">
      <button class="tutorial-close" id="tutorialClose"></button>
      <div class="tutorial-title" id="tutorialTitle">Welcome to EZ Habits!</div>
      <div class="tutorial-description" id="tutorialDescription">
        Let's take a quick tour of the app to help you get started.
      </div>
      <div class="tutorial-actions">
        <div class="tutorial-checkbox">
          <input type="checkbox" id="dontShowAgain">
          <label for="dontShowAgain">Don't show again</label>
        </div>
        <div class="tutorial-nav">
          <button type="button" class="tutorial-btn" id="tutorialSkip">Skip</button>
          <button type="button" class="tutorial-btn primary" id="tutorialNext">Next Step</button>
        </div>
      </div>
    </div>
    <div class="tutorial-progress" id="tutorialProgress">1/8</div>
  </div>
  
  <script>
    // Navigation bar hide/show functions
    const navIsland = document.getElementById('navIsland');
    const fab = document.querySelector('.fab');
    
    function hideNavBar() {
      if (navIsland) {
        navIsland.classList.add('hidden');
      }
      if (fab) {
        fab.classList.add('hidden');
      }
    }
    
    function showNavBar() {
      if (navIsland) {
        navIsland.classList.remove('hidden');
      }
      if (fab) {
        fab.classList.remove('hidden');
      }
    }
    
    // Modal open/close logic
    const openModalBtn = document.getElementById('openModalBtn');
    const modalOverlay = document.getElementById('modalOverlay');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const addNoteModal = document.getElementById('addNoteModal');
    const noteText = document.getElementById('noteText');
    const timeframeSelect = document.getElementById('timeframe');
    
    // Modal event handlers
    cancelModalBtn.onclick = () => { 
      console.log('Closing add modal');
      modalOverlay.classList.add('hidden');
      showNavBar(); // Show nav bar when modal closes
    };
    
    // Ensure modals work properly in calendar view
    const editModalOverlay = document.getElementById('editModalOverlay');
    
    // Update modal z-index when opening from calendar
    function updateModalZIndex() {
      if (calendarWindow.classList.contains('active')) {
        modalOverlay.style.zIndex = '2000';
        editModalOverlay.style.zIndex = '2000';
      } else {
        modalOverlay.style.zIndex = '200';
        editModalOverlay.style.zIndex = '200';
      }
    }
    
    modalOverlay.onclick = (e) => {
      if (e.target === modalOverlay) {
        console.log('Closing modal via overlay click');
        modalOverlay.classList.add('hidden');
        showNavBar(); // Show nav bar when modal closes
      }
    };

    // Sort functionality
    const sortBtn = document.getElementById('sortBtn');
    const sortDropdown = document.getElementById('sortDropdown');
    let currentSort = localStorage.getItem('currentSort') || 'added-desc';
    
    // Set initial button text based on saved preference
    function updateSortButtonText() {
      const sortOptions = {
        'date-asc': 'Due Date',
        'date-desc': 'Due Date',
        'importance-asc': 'Importance',
        'importance-desc': 'Importance',
        'added-desc': 'Date Added',
        'added-asc': 'Date Added',
        'duration-asc': 'Duration',
        'duration-desc': 'Duration'
      };
      sortBtn.textContent = `Sort: ${sortOptions[currentSort] || 'Due Date'} `;
    }
    
    // Load sort preference on startup
    updateSortButtonText();
    
    sortBtn.onclick = () => {
      sortDropdown.classList.toggle('show');
    };
    
    document.addEventListener('click', (e) => {
      if (!sortBtn.contains(e.target) && !sortDropdown.contains(e.target)) {
        sortDropdown.classList.remove('show');
      }
    });
    
    // Sort functionality variables
    let selectedDirection = null;
    let selectedCriteria = null;
    
    // Direction button click handler
    sortDropdown.addEventListener('click', (e) => {
      if (e.target.classList.contains('direction-btn')) {
        // Remove selected class from all direction buttons
        document.querySelectorAll('.direction-btn').forEach(btn => btn.classList.remove('selected'));
        // Add selected class to clicked button
        e.target.classList.add('selected');
        selectedDirection = e.target.getAttribute('data-direction');
        
        // Show criteria selection
        document.getElementById('sortCriteria').classList.remove('hidden');
      }
      
      if (e.target.classList.contains('criteria-btn')) {
        // Remove selected class from all criteria buttons
        document.querySelectorAll('.criteria-btn').forEach(btn => btn.classList.remove('selected'));
        // Add selected class to clicked button
        e.target.classList.add('selected');
        selectedCriteria = e.target.getAttribute('data-criteria');
        
        // Apply sort
        if (selectedDirection && selectedCriteria) {
          currentSort = `${selectedCriteria}-${selectedDirection}`;
          localStorage.setItem('currentSort', currentSort);
          updateSortButtonText();
          sortDropdown.classList.remove('show');
          renderNotes();
          
          // Reset selections
          selectedDirection = null;
          selectedCriteria = null;
          document.querySelectorAll('.direction-btn, .criteria-btn').forEach(btn => btn.classList.remove('selected'));
          document.getElementById('sortCriteria').classList.add('hidden');
        }
      }
    });

    // Urgency selection (removed - now automatic)
    // Category selection (single selection only)
    const categoryRow = document.getElementById('categoryRow');
    categoryRow.onclick = (e) => {
      if (e.target.classList.contains('category-chip')) {
        [...categoryRow.children].forEach(chip => chip.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Term tag selection (single selection only)
    const termTagsRow = document.getElementById('termTagsRow');
    termTagsRow.onclick = (e) => {
      if (e.target.classList.contains('term-tag')) {
        [...termTagsRow.children].forEach(tag => tag.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Importance selection (single selection only)
    const importanceRow = document.getElementById('importanceRow');
    importanceRow.onclick = (e) => {
      console.log('Add importance clicked:', e.target);
      console.log('Target classList:', e.target.classList);
      if (e.target.classList.contains('importance-dot')) {
        console.log('Add importance dot clicked, level:', e.target.getAttribute('data-level'));
        [...importanceRow.children].forEach(dot => dot.classList.remove('selected'));
        e.target.classList.add('selected');
        console.log('Importance dot selected:', e.target.classList.contains('selected'));
      }
    };

    // Voice input (Web Speech API)
    const voiceBtn = document.getElementById('voiceBtn');
    let recognition;
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = function(event) {
        noteText.value += (noteText.value ? ' ' : '') + event.results[0][0].transcript;
        voiceBtn.classList.remove('recording');
      };
      recognition.onend = function() {
        voiceBtn.classList.remove('recording');
      };
    }
    voiceBtn.onclick = function(e) {
      e.preventDefault();
      if (recognition) {
        if (voiceBtn.classList.contains('recording')) {
          recognition.stop();
          voiceBtn.classList.remove('recording');
        } else {
          recognition.start();
          voiceBtn.classList.add('recording');
        }
      } else {
        alert('Voice input not supported in this browser.');
      }
    };

    // Notes state and rendering
    let notes = [];
    let categories = new Set();
    let activeCategory = 'All';
    const notesGrid = document.getElementById('notesGrid');
    const filterChips = document.getElementById('filterChips');
    const searchInput = document.getElementById('searchInput');

    // Load notes from localStorage on page load
    function loadNotes() {
      const savedNotes = localStorage.getItem('eznotes_notes');
      if (savedNotes) {
        try {
          notes = JSON.parse(savedNotes);
          // Comprehensive data migration for all notes
          notes.forEach(note => {
            // Ensure all required fields exist
            if (!note.id) {
              note.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }
            if (!note.createdAt) {
              note.createdAt = new Date().toISOString();
            }
            if (note.done === undefined) {
              note.done = false;
            }
            if (!note.termTags) {
              note.termTags = [];
            }
            if (!note.importance) {
              note.importance = 'moderately';
            }
            if (!note.text) {
              note.text = note.content || note.note || 'Untitled Note'; // Handle old field names
            }
            if (!note.title) {
              note.title = note.text || 'Untitled Note';
            }
            if (!note.category) {
              note.category = 'Other';
            }
            if (!note.urgency) {
              note.urgency = 3; // Default to medium urgency
            }
            if (!note.timeframe) {
              note.timeframe = 'custom'; // Default timeframe
            }
            
            // Ensure customDate field exists and is properly handled
            if (!note.hasOwnProperty('customDate')) {
              note.customDate = null;
            }
            
            // Ensure all fields are of correct type
            note.id = String(note.id);
            note.text = String(note.text);
            note.title = String(note.title);
            note.category = String(note.category);
            note.urgency = parseInt(note.urgency) || 3;
            note.timeframe = String(note.timeframe);
            note.termTags = Array.isArray(note.termTags) ? note.termTags : [];
            note.done = Boolean(note.done);
            
            // Validate urgency range
            if (note.urgency < 1 || note.urgency > 5) {
              note.urgency = 3;
            }
          });
          
          // Load manually added categories
          const savedCategories = localStorage.getItem('eznotes_categories');
          if (savedCategories) {
            try {
              const categoriesArray = JSON.parse(savedCategories);
              categoriesArray.forEach(cat => categories.add(cat));
            } catch (e) {
              console.log('Error loading categories:', e);
            }
          }
          
          // Rebuild categories set from notes (for backward compatibility)
          notes.forEach(note => {
            if (note.category && note.category !== '') {
              categories.add(note.category);
            }
          });
          
          // Save migrated data
          saveNotes();
          console.log('Notes loaded successfully:', notes.length, 'notes found');
        } catch (error) {
          console.error('Error loading notes:', error);
          notes = [];
        }
      }
    }

    // Save notes to localStorage
    function saveNotes() {
      try {
        // Ensure notes is an array
        if (!Array.isArray(notes)) {
          notes = [];
        }
        
        // Ensure categories is a Set
        if (!(categories instanceof Set)) {
          categories = new Set();
        }
        
        localStorage.setItem('eznotes_notes', JSON.stringify(notes));
        localStorage.setItem('eznotes_categories', JSON.stringify(Array.from(categories)));
        localStorage.setItem('eznotes_version', '1.3'); // Updated version
      } catch (error) {
        console.error('Error saving notes:', error);
      }
    }
    
    // Check and migrate data version
    function checkDataVersion() {
      const currentVersion = '1.3';
      const savedVersion = localStorage.getItem('eznotes_version');
      
      if (savedVersion !== currentVersion) {
        console.log(`Migrating data from version ${savedVersion} to ${currentVersion}`);
        // Update version without clearing data
        localStorage.setItem('eznotes_version', currentVersion);
      }
    }



    function getImportanceText(importance) {
      switch(importance) {
        case 'slightly':
          return 'Slightly Important';
        case 'moderately':
          return 'Moderately Important';
        case 'very':
          return 'Very Important';
        default:
          return 'Moderately Important';
      }
    }
    
    function formatDuration(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      
      if (hours > 0 && mins > 0) {
        return `${hours}h ${mins}m`;
      } else if (hours > 0) {
        return `${hours}h`;
      } else {
        return `${mins}m`;
      }
    }
    
    function formatTimeframe(note) {
      // Handle custom dates
      if (note.customDate) {
        const dueDate = new Date(note.customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        
        if (days === 1) return 'Due tomorrow';
        if (days === 0) return 'Due today';
        if (days < 0) return 'Overdue';
        return `Due in ${days} days`;
      }
      
      return 'No due date';
    }

    function aiGenerateTitle(text) {
      // Simple AI-like title: first 5 words or up to 30 chars, capitalized
      if (!text) return 'Untitled Note';
      let words = text.trim().split(/\s+/).slice(0, 5).join(' ');
      if (words.length > 30) words = words.slice(0, 30) + '...';
      return words.charAt(0).toUpperCase() + words.slice(1);
    }

    function sortNotes(notesToSort) {
      switch (currentSort) {
        case 'date-asc':
          return notesToSort.sort((a, b) => {
            let aDays, bDays;
            
            // Handle custom dates
            if (a.timeframe === 'custom' && a.customDate) {
              const dueDate = new Date(a.customDate);
              const today = new Date();
              aDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (a.timeframe.includes('Due ')) {
              aDays = parseInt(a.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              aDays = parseInt(a.timeframe);
            }
            
            if (b.timeframe === 'custom' && b.customDate) {
              const dueDate = new Date(b.customDate);
              const today = new Date();
              bDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (b.timeframe.includes('Due ')) {
              bDays = parseInt(b.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              bDays = parseInt(b.timeframe);
            }
            
            return aDays - bDays;
          });
        case 'date-desc':
          return notesToSort.sort((a, b) => {
            let aDays, bDays;
            
            // Handle custom dates
            if (a.timeframe === 'custom' && a.customDate) {
              const dueDate = new Date(a.customDate);
              const today = new Date();
              aDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (a.timeframe.includes('Due ')) {
              aDays = parseInt(a.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              aDays = parseInt(a.timeframe);
            }
            
            if (b.timeframe === 'custom' && b.customDate) {
              const dueDate = new Date(b.customDate);
              const today = new Date();
              bDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            } else if (b.timeframe.includes('Due ')) {
              bDays = parseInt(b.timeframe.match(/\((\d+) days?\)/)[1]);
            } else {
              bDays = parseInt(b.timeframe);
            }
            
            return bDays - aDays;
          });
        case 'term-asc':
          return notesToSort.sort((a, b) => {
            const termA = a.termTag || (a.termTags && a.termTags[0]) || 'medium';
            const termB = b.termTag || (b.termTags && b.termTags[0]) || 'medium';
            const termOrder = { 'short': 1, 'medium': 2, 'long': 3 };
            return (termOrder[termA] || 2) - (termOrder[termB] || 2);
          });
        case 'term-desc':
          return notesToSort.sort((a, b) => {
            const termA = a.termTag || (a.termTags && a.termTags[0]) || 'medium';
            const termB = b.termTag || (b.termTags && b.termTags[0]) || 'medium';
            const termOrder = { 'short': 1, 'medium': 2, 'long': 3 };
            return (termOrder[termB] || 2) - (termOrder[termA] || 2);
          });
        case 'importance-asc':
          return notesToSort.sort((a, b) => {
            const importanceOrder = { 'slightly': 1, 'moderately': 2, 'very': 3 };
            const aImportance = a.importance || 'moderately';
            const bImportance = b.importance || 'moderately';
            return (importanceOrder[aImportance] || 2) - (importanceOrder[bImportance] || 2);
          });
        case 'importance-desc':
          return notesToSort.sort((a, b) => {
            const importanceOrder = { 'slightly': 1, 'moderately': 2, 'very': 3 };
            const aImportance = a.importance || 'moderately';
            const bImportance = b.importance || 'moderately';
            return (importanceOrder[bImportance] || 2) - (importanceOrder[aImportance] || 2);
          });
        case 'added-desc':
          return notesToSort.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        case 'added-asc':
          return notesToSort.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
        case 'duration-asc':
          return notesToSort.sort((a, b) => {
            const aDuration = a.duration || 0;
            const bDuration = b.duration || 0;
            return aDuration - bDuration;
          });
        case 'duration-desc':
          return notesToSort.sort((a, b) => {
            const aDuration = a.duration || 0;
            const bDuration = b.duration || 0;
            return bDuration - aDuration;
          });
        case 'urgency':
        default:
          return notesToSort.sort((a, b) => b.urgency - a.urgency);
      }
    }

    function renderNotes() {
      let filtered = notes;
      if (activeCategory === 'All') {
        filtered = filtered.filter(n => !n.done);
      } else if (activeCategory === 'Done') {
        filtered = filtered.filter(n => n.done);
      } else {
        filtered = filtered.filter(n => n.category === activeCategory && !n.done);
      }
      
      if (searchInput.value.trim()) {
        const q = searchInput.value.trim().toLowerCase();
        filtered = filtered.filter(n => n.text.toLowerCase().includes(q) || n.title.toLowerCase().includes(q));
      }
      
      filtered = sortNotes(filtered);
      
      // Show search results count
      const searchResultsCount = document.getElementById('searchResultsCount');
      if (searchInput.value.trim() && searchResultsCount) {
        const totalNotes = notes.filter(n => !n.done).length;
        searchResultsCount.textContent = `Found ${filtered.length} of ${totalNotes} notes`;
        searchResultsCount.style.display = 'block';
      } else if (searchResultsCount) {
        searchResultsCount.style.display = 'none';
      }
      
      notesGrid.innerHTML = filtered.map(note => `
        <div class="note-card ${note.done ? 'done' : ''}" data-importance="${note.importance || 'moderately'}" data-urgency="${note.urgency}" data-id="${note.id}">
          <div class="note-title">${note.title}</div>
          <div class="note-categories">
            ${(note.categories || [note.category || 'Other']).map(cat => `<span class="note-category">${cat}</span>`).join('')}
          </div>
          <div class="note-term-tags">
            <span class="term-tag-display ${note.termTag || (note.termTags && note.termTags[0]) || 'medium'}">${note.termTag || (note.termTags && note.termTags[0]) || 'medium'}</span>
          </div>
          <div class="note-importance">${getImportanceText(note.importance || 'moderately')}</div>
          <div class="due-date-text">${formatTimeframe(note)}</div>
          ${note.duration ? `<div class="note-duration"> ${formatDuration(note.duration)}</div>` : ''}
          ${note.done ? '<div class="note-delete-hint"> Can be deleted</div>' : ''}
        </div>
      `).join('');
      
      // Ensure no checkboxes are shown in main view
      hideMultiSelectElements();
    }

    function renderChips() {
      // Get custom category order from localStorage
      let categoryOrder = JSON.parse(localStorage.getItem('categoryOrder')) || ['All', 'Done'];
      
      // Add any new categories that aren't in the order yet
      categories.forEach(cat => {
        if (!categoryOrder.includes(cat)) {
          categoryOrder.push(cat);
        }
      });
      
      // Filter to only show categories that exist
      const validCategories = categoryOrder.filter(cat => 
        cat === 'All' || cat === 'Done' || categories.has(cat)
      );
      
      const chipContainer = document.getElementById('chipContainer');
      chipContainer.innerHTML = validCategories.map(cat => 
        `<button class="chip${activeCategory === cat ? ' active' : ''}" data-cat="${cat}">${cat}</button>`
      ).join('');
    }

    // Initialize app
    console.log('Initializing EzNotes app...');
    loadNotes();
    checkDataVersion();
    
    // Ensure clean initialization
    if (!Array.isArray(notes)) {
      notes = [];
    }
    if (!(categories instanceof Set)) {
      categories = new Set(['Other']);
    }
    
    renderNotes();
    renderChips();
    updateSortButtonText();
    console.log('App initialized successfully with clean data.');
    
    // Initialize This Week Calendar
    let currentWeekStart = getWeekStart(new Date());
    renderThisWeekCalendar();
    
    // Initialize search icon functionality
    initializeSearchIcon();
    
    // Initialize category rendering
    renderCategories();
    
    // Add search functionality
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    
    searchInput.addEventListener('input', () => {
      renderNotes();
      
      // Add visual indicator for search and show/hide clear button
      const searchBar = searchInput.parentElement;
      if (searchInput.value.trim()) {
        searchBar.classList.add('has-content');
        clearSearchBtn.style.display = 'block';
      } else {
        searchBar.classList.remove('has-content');
        clearSearchBtn.style.display = 'none';
      }
    });
    
    // Clear search functionality
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchInput.focus();
      renderNotes();
      searchInput.parentElement.classList.remove('has-content');
      clearSearchBtn.style.display = 'none';
    });
    
    // Add search input focus/blur effects
    searchInput.addEventListener('focus', () => {
      searchInput.parentElement.style.boxShadow = '0 2px 12px rgba(108,99,255,0.15)';
    });
    
    searchInput.addEventListener('blur', () => {
      searchInput.parentElement.style.boxShadow = '0 2px 8px rgba(108,99,255,0.04)';
    });
    
    // Set default selections immediately and after DOM is fully loaded
    function setDefaultSelections() {
      console.log('Setting default selections...');
      
      // Set default selections for add modal
      const importanceLevelModerately = document.querySelector('#importanceRow .importance-dot[data-level="moderately"]');
      const categoryOther = document.querySelector('#categoryRow .category-chip[data-category="Other"]');
      
      console.log('Found elements:', {
        importanceLevelModerately: !!importanceLevelModerately,
        categoryOther: !!categoryOther
      });
      
      if (importanceLevelModerately) importanceLevelModerately.classList.add('selected');
      if (categoryOther) categoryOther.classList.add('selected');
    }
    
    // Set defaults immediately
    setDefaultSelections();
    
    // Also set after a short delay to ensure DOM is ready
    setTimeout(setDefaultSelections, 100);
    
    // Add modal open handler to ensure defaults are set
    openModalBtn.onclick = () => { 
      console.log('Opening add modal');
      updateModalZIndex(); // Update z-index for calendar view
      hideNavBar(); // Hide nav bar when modal opens
      console.log('Nav bar hidden for modal');
      modalOverlay.classList.remove('hidden');
      // Ensure defaults are set when modal opens
      setTimeout(setDefaultSelections, 50);
    };
    
    // Filter chip click handler
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('chip')) {
        const category = e.target.getAttribute('data-cat');
        if (category) {
          activeCategory = category;
          renderChips();
          renderNotes();
          console.log('Active category changed to:', category);
        }
      }
    });
    
    // Long-press drag functionality for filter chips
    let isDragging = false;
    let draggedElement = null;
    let originalPosition = null;
    let dragStartTime = 0;
    let dragTimeout = null;
    
    // Mouse events for desktop
    document.addEventListener('mousedown', (e) => {
      if (e.target.classList.contains('chip')) {
        dragStartTime = Date.now();
        dragTimeout = setTimeout(() => {
          startDrag(e.target, e.clientX, e.clientY);
        }, 500); // 500ms long press
      }
    });
    
    document.addEventListener('mouseup', () => {
      if (dragTimeout) {
        clearTimeout(dragTimeout);
        dragTimeout = null;
      }
      if (isDragging) {
        stopDrag();
      }
    });
    
    document.addEventListener('mousemove', (e) => {
      if (isDragging && draggedElement) {
        updateDragPosition(e.clientX, e.clientY);
      }
    });
    
    // Touch events for mobile
    document.addEventListener('touchstart', (e) => {
      if (e.target.classList.contains('chip')) {
        dragStartTime = Date.now();
        dragTimeout = setTimeout(() => {
          startDrag(e.target, e.touches[0].clientX, e.touches[0].clientY);
        }, 500); // 500ms long press
      }
    });
    
    document.addEventListener('touchend', () => {
      if (dragTimeout) {
        clearTimeout(dragTimeout);
        dragTimeout = null;
      }
      if (isDragging) {
        stopDrag();
      }
    });
    
    document.addEventListener('touchmove', (e) => {
      if (isDragging && draggedElement) {
        e.preventDefault(); // Prevent scrolling while dragging
        updateDragPosition(e.touches[0].clientX, e.touches[0].clientY);
      }
    });
    
    function startDrag(element, startX, startY) {
      console.log('Starting drag for:', element.textContent);
      isDragging = true;
      draggedElement = element;
      originalPosition = {
        x: element.offsetLeft,
        y: element.offsetTop
      };
      
      // Add dragging styles
      element.style.position = 'fixed';
      element.style.zIndex = '1000';
      element.style.pointerEvents = 'none';
      element.style.transform = 'scale(1.1)';
      element.style.boxShadow = '0 8px 24px rgba(108,99,255,0.3)';
      
      // Create drag indicator
      const indicator = document.createElement('div');
      indicator.id = 'dragIndicator';
      indicator.style.position = 'fixed';
      indicator.style.width = '2px';
      indicator.style.height = '20px';
      indicator.style.backgroundColor = '#6C63FF';
      indicator.style.zIndex = '999';
      document.body.appendChild(indicator);
      
      updateDragPosition(startX, startY);
    }
    
    function updateDragPosition(clientX, clientY) {
      if (!draggedElement) return;
      
      const rect = draggedElement.getBoundingClientRect();
      const x = clientX - rect.width / 2;
      const y = clientY - rect.height / 2;
      
      draggedElement.style.left = x + 'px';
      draggedElement.style.top = y + 'px';
      
      // Update drag indicator position
      const indicator = document.getElementById('dragIndicator');
      if (indicator) {
        indicator.style.left = (clientX - 1) + 'px';
        indicator.style.top = (clientY - 10) + 'px';
      }
      
      // Check for drop zones (other chips)
      const chips = document.querySelectorAll('.chip');
      chips.forEach(chip => {
        if (chip !== draggedElement) {
          const chipRect = chip.getBoundingClientRect();
          const isOverlapping = clientX >= chipRect.left && 
                               clientX <= chipRect.right && 
                               clientY >= chipRect.top && 
                               clientY <= chipRect.bottom;
          
          if (isOverlapping) {
            chip.style.transform = 'scale(1.05)';
            chip.style.backgroundColor = '#e3f2fd';
          } else {
            chip.style.transform = '';
            chip.style.backgroundColor = '';
          }
        }
      });
    }
    
    function stopDrag() {
      if (!draggedElement) return;
      
      console.log('Stopping drag');
      
      // Find drop target
      const chips = document.querySelectorAll('.chip');
      let dropTarget = null;
      
      chips.forEach(chip => {
        if (chip !== draggedElement) {
          const chipRect = chip.getBoundingClientRect();
          const draggedRect = draggedElement.getBoundingClientRect();
          
          const isOverlapping = draggedRect.left < chipRect.right && 
                               draggedRect.right > chipRect.left && 
                               draggedRect.top < chipRect.bottom && 
                               draggedRect.bottom > chipRect.top;
          
          if (isOverlapping) {
            dropTarget = chip;
          }
          
          // Reset chip styles
          chip.style.transform = '';
          chip.style.backgroundColor = '';
        }
      });
      
      // Reorder if drop target found
      if (dropTarget) {
        const draggedCategory = draggedElement.getAttribute('data-cat');
        const targetCategory = dropTarget.getAttribute('data-cat');
        
        console.log('Reordering:', draggedCategory, 'to position of', targetCategory);
        reorderCategories(draggedCategory, targetCategory);
      }
      
      // Reset dragged element
      draggedElement.style.position = '';
      draggedElement.style.zIndex = '';
      draggedElement.style.pointerEvents = '';
      draggedElement.style.transform = '';
      draggedElement.style.boxShadow = '';
      draggedElement.style.left = '';
      draggedElement.style.top = '';
      
      // Remove drag indicator
      const indicator = document.getElementById('dragIndicator');
      if (indicator) {
        indicator.remove();
      }
      
      isDragging = false;
      draggedElement = null;
      originalPosition = null;
    }
    
    function reorderCategories(draggedCategory, targetCategory) {
      // Get current category order from localStorage or use default
      let categoryOrder = JSON.parse(localStorage.getItem('categoryOrder')) || ['All', 'Done'];
      
      // Add all categories to the order if they're not already there
      categories.forEach(cat => {
        if (!categoryOrder.includes(cat)) {
          categoryOrder.push(cat);
        }
      });
      
      // Remove dragged category from its current position
      const draggedIndex = categoryOrder.indexOf(draggedCategory);
      if (draggedIndex > -1) {
        categoryOrder.splice(draggedIndex, 1);
      }
      
      // Insert dragged category at target position
      const targetIndex = categoryOrder.indexOf(targetCategory);
      if (targetIndex > -1) {
        categoryOrder.splice(targetIndex, 0, draggedCategory);
      }
      
      // Save new order
      localStorage.setItem('categoryOrder', JSON.stringify(categoryOrder));
      
      // Re-render chips with new order
      renderChips();
      console.log('Category order updated:', categoryOrder);
    }
    
    // Note click handler for editing
    notesGrid.addEventListener('click', (e) => {
      const noteCard = e.target.closest('.note-card');
      if (noteCard) {
        const noteId = noteCard.dataset.id;
        const note = notes.find(n => n.id === noteId);
        if (note) {
          openEditModal(note);
        }
      }
    });
    
    // Open edit modal function
    function openEditModal(note) {
      console.log('openEditModal called with note:', note);
      const editModal = document.getElementById('editModalOverlay');
      const editNoteText = document.getElementById('editNoteText');
      const editTimeframe = document.getElementById('editTimeframe');
      const editCustomDate = document.getElementById('editCustomDate');
      const editCustomDateContainer = document.getElementById('editCustomDateContainer');
      
      console.log('Edit modal elements found:');
      console.log('editModal:', !!editModal);
      console.log('editNoteText:', !!editNoteText);
      console.log('editTimeframe:', !!editTimeframe);
      console.log('editCustomDate:', !!editCustomDate);
      console.log('editCustomDateContainer:', !!editCustomDateContainer);
      
      // Set note data
      const editNoteTitle = document.getElementById('editNoteTitle');
      const editNoteDescription = document.getElementById('editNoteDescription');
      
      editNoteTitle.value = note.title || note.text || '';
      editNoteDescription.value = note.description || '';
      
      // Handle timeframe and custom date
      console.log('Note timeframe:', note.timeframe);
      console.log('Note customDate:', note.customDate);
      console.log('Note has customDate field:', 'customDate' in note);
      // Set custom date
      if (note.customDate) {
        console.log('Setting custom date:', note.customDate);
        editCustomDate.value = note.customDate;
      } else {
        console.log('No custom date found');
        editCustomDate.value = '';
      }
      
      // Set term tag with fallback (single selection)
      [...document.getElementById('editTermTagsRow').children].forEach(tag => tag.classList.remove('selected'));
      const termTag = note.termTag || (note.termTags && note.termTags[0]) || 'medium';
      const selectedTag = document.querySelector(`#editTermTagsRow .term-tag[data-term="${termTag}"]`);
      if (selectedTag) selectedTag.classList.add('selected');
      
      // Set importance with fallback (single selection)
      [...document.getElementById('editImportanceRow').children].forEach(dot => dot.classList.remove('selected'));
      const importance = note.importance || 'moderately';
      console.log('Setting importance to:', importance);
      console.log('Importance dots found:', document.getElementById('editImportanceRow').children.length);
      const selectedImportanceBtn = document.querySelector(`#editImportanceRow .importance-dot[data-level="${importance}"]`);
      console.log('Found importance button:', selectedImportanceBtn);
      if (selectedImportanceBtn) selectedImportanceBtn.classList.add('selected');
      
      // Set categories (multiple selection)
      [...document.getElementById('editCategoryRow').children].forEach(chip => chip.classList.remove('selected'));
      const categories = note.categories || [note.category || 'Other'];
      categories.forEach(cat => {
        const chip = document.querySelector(`#editCategoryRow .category-chip[data-category="${cat}"]`);
        if (chip) chip.classList.add('selected');
      });
      
      // Set duration
      const editDurationHours = document.getElementById('editDurationHours');
      const editDurationMinutes = document.getElementById('editDurationMinutes');
      if (editDurationHours && editDurationMinutes && note.duration) {
        const hours = Math.floor(note.duration / 60);
        const minutes = note.duration % 60;
        editDurationHours.value = hours > 0 ? hours : '';
        editDurationMinutes.value = minutes > 0 ? minutes : '';
      } else if (editDurationHours && editDurationMinutes) {
        editDurationHours.value = '';
        editDurationMinutes.value = '';
      }
      
      // Store note ID for form submission
      document.getElementById('editNoteModal').dataset.id = note.id;
      
      // Show/hide action buttons based on note state
      const markDoneBtn = document.getElementById('markDoneBtn');
      const deleteBtn = document.getElementById('deleteNoteBtn');
      
      markDoneBtn.style.display = 'inline-block';
      
      // Only show delete button if note is done
      if (note.done) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = 'Delete';
        deleteBtn.style.background = '#FF6B6B';
      } else {
        deleteBtn.style.display = 'none';
      }
      
      // Update button text based on current state
      markDoneBtn.textContent = note.done ? 'Undo' : 'Mark Done';
      
      // Ensure modal appears above calendar if in calendar view
      if (calendarWindow.classList.contains('active')) {
        editModal.style.zIndex = '2000';
      } else {
        editModal.style.zIndex = '201';
      }
      
      hideNavBar(); // Hide nav bar when edit modal opens
      editModal.classList.remove('hidden');
    }
    
    // Add note form submission
    addNoteModal.onsubmit = (e) => {
      e.preventDefault();
      console.log('Add note form submitted');
      
      const noteTitle = document.getElementById('noteTitle').value.trim();
      const description = document.getElementById('noteDescription').value.trim();
      const customDate = document.getElementById('customDate').value;
      
      // Get selected term tag (optional)
      const selectedTermTag = document.querySelector('#termTagsRow .term-tag.selected');
      const termTag = selectedTermTag ? selectedTermTag.getAttribute('data-term') : null;
      
      // Get selected importance (single selection)
      const selectedImportanceBtn = document.querySelector('#importanceRow .importance-dot.selected');
      const importance = selectedImportanceBtn ? selectedImportanceBtn.getAttribute('data-level') : 'moderately';
      
      // Get selected category (single selection)
      const selectedCategoryChip = document.querySelector('#categoryRow .category-chip.selected');
      const selectedCategory = selectedCategoryChip ? selectedCategoryChip.getAttribute('data-category') : 'Other';
      
      // Get duration (optional)
      const durationHours = document.getElementById('durationHours').value;
      const durationMinutes = document.getElementById('durationMinutes').value;
      const totalMinutes = (durationHours ? parseInt(durationHours) * 60 : 0) + (durationMinutes ? parseInt(durationMinutes) : 0);
      const durationValue = totalMinutes > 0 ? totalMinutes : null;
      
      if (!noteTitle) {
        alert('Please enter a title.');
        return;
      }
      
      // Calculate urgency based on custom date
      let calculatedUrgency = 3; // Default to medium urgency
      if (customDate) {
        const dueDate = new Date(customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      }
      
      const newNote = { 
        id: Date.now().toString(),
        text: description || noteTitle, // Use description if available, otherwise use title
        title: noteTitle,
        description: description,
        timeframe: 'custom', 
        customDate: customDate,
        urgency: calculatedUrgency, 
        importance: importance,
        category: selectedCategory,
        categories: [selectedCategory], 
        done: false,
        createdAt: new Date().toISOString(),
        termTag: termTag,
        duration: durationValue
      };
      
      notes.push(newNote);
      saveNotes();
      renderNotes();
      renderThisWeekCalendar();
      
      // Reset modal
      document.getElementById('noteTitle').value = '';
      document.getElementById('noteDescription').value = '';
      document.getElementById('customDate').value = '';
      document.getElementById('durationHours').value = '';
      document.getElementById('durationMinutes').value = '';
      [...categoryRow.children].forEach(chip => chip.classList.remove('selected'));
      [...document.getElementById('termTagsRow').children].forEach(tag => tag.classList.remove('selected'));
      [...document.getElementById('importanceRow').children].forEach(dot => dot.classList.remove('selected'));
      
      // Reset to defaults using the function
      setTimeout(setDefaultSelections, 50);
      
      console.log('Closing add modal...');
      modalOverlay.classList.add('hidden');
      showNavBar(); // Show nav bar when add modal closes
      console.log('Add modal closed successfully');
    };
    
    // Direct save button click handler as backup
    const saveBtn = addNoteModal.querySelector('button[type="submit"]');
    if (saveBtn) {
      saveBtn.onclick = (e) => {
        e.preventDefault();
        console.log('Save button clicked directly');
        addNoteModal.dispatchEvent(new Event('submit'));
      };
    }
    
    // Edit note form submission
    const editNoteModal = document.getElementById('editNoteModal');
    editNoteModal.onsubmit = (e) => {
      e.preventDefault();
      console.log('Edit note form submitted');
      
      const editTitle = document.getElementById('editNoteTitle').value.trim();
      const editDescription = document.getElementById('editNoteDescription').value.trim();
      const customDate = document.getElementById('editCustomDate').value;
      
      // Get selected term tag (optional)
      const selectedTermTag = document.querySelector('#editTermTagsRow .term-tag.selected');
      const termTag = selectedTermTag ? selectedTermTag.getAttribute('data-term') : null;
      
      // Get selected importance (single selection)
      const selectedImportanceBtn = document.querySelector('#editImportanceRow .importance-dot.selected');
      const importance = selectedImportanceBtn ? selectedImportanceBtn.getAttribute('data-level') : 'moderately';
      
      // Get selected category (single selection)
      const selectedCategoryChip = document.querySelector('#editCategoryRow .category-chip.selected');
      const selectedCategory = selectedCategoryChip ? selectedCategoryChip.getAttribute('data-category') : 'Other';
      
      // Get duration (optional)
      const durationHours = document.getElementById('editDurationHours').value;
      const durationMinutes = document.getElementById('editDurationMinutes').value;
      const totalMinutes = (durationHours ? parseInt(durationHours) * 60 : 0) + (durationMinutes ? parseInt(durationMinutes) : 0);
      const durationValue = totalMinutes > 0 ? totalMinutes : null;
      
      if (!editTitle) {
        alert('Please enter a title.');
        return;
      }
      
      // Calculate urgency based on custom date
      let calculatedUrgency = 3; // Default to medium urgency
      if (customDate) {
        const dueDate = new Date(customDate);
        const today = new Date();
        const days = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
        if (days <= 1) calculatedUrgency = 5;
        else if (days <= 5) calculatedUrgency = 4;
        else if (days <= 10) calculatedUrgency = 3;
        else if (days <= 30) calculatedUrgency = 2;
        else calculatedUrgency = 1;
      }
      
      // Update note
      const note = notes.find(n => n.id === document.getElementById('editNoteModal').dataset.id);
      if (note) {
        note.text = editDescription || editTitle; // Use description if available, otherwise use title
        note.title = editTitle;
        note.description = editDescription;
        note.timeframe = 'custom';
        note.customDate = customDate;
        note.urgency = calculatedUrgency;
        note.importance = importance;
        note.category = selectedCategory;
        note.categories = [selectedCategory];
        note.termTag = termTag; // Update single term tag
        note.termTags = [termTag]; // Update term tags array
        note.duration = durationValue;
      }
      
      saveNotes();
      renderNotes();
      renderThisWeekCalendar();
      
      // Always refresh the week notes dropdown if it's currently showing
      const weekNotes = document.getElementById('thisWeekNotes');
      if (weekNotes && weekNotes.classList.contains('show')) {
        // Find the currently selected day and refresh its details
        const selectedDay = document.querySelector('.week-day.selected');
        if (selectedDay) {
          // Simulate re-clicking the selected day to refresh the dropdown
          selectedDay.click();
        }
        // If no specific day is selected, don't refresh - let the user click a day to see tasks
      }
      
      console.log('Closing edit modal...');
      document.getElementById('editModalOverlay').classList.add('hidden');
      showNavBar(); // Show nav bar when edit modal closes
      console.log('Edit modal closed successfully');
    };
    
    // Direct edit save button click handler as backup
    const editSaveBtn = editNoteModal.querySelector('button[type="submit"]');
    if (editSaveBtn) {
      editSaveBtn.onclick = (e) => {
        e.preventDefault();
        console.log('Edit save button clicked directly');
        editNoteModal.dispatchEvent(new Event('submit'));
      };
    }

    // Edit importance selection (single selection only)
    document.getElementById('editImportanceRow').onclick = (e) => {
      console.log('Edit importance clicked:', e.target);
      if (e.target.classList.contains('importance-dot')) {
        console.log('Importance dot clicked, level:', e.target.getAttribute('data-level'));
        [...document.getElementById('editImportanceRow').children].forEach(dot => dot.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Edit term tag selection (single selection only)
    document.getElementById('editTermTagsRow').onclick = (e) => {
      if (e.target.classList.contains('term-tag')) {
        [...document.getElementById('editTermTagsRow').children].forEach(tag => tag.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };

    // Edit category selection (single selection only)
    document.getElementById('editCategoryRow').onclick = (e) => {
      if (e.target.classList.contains('category-chip')) {
        [...document.getElementById('editCategoryRow').children].forEach(chip => chip.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    };
    
    // Edit modal cancel button
    document.getElementById('cancelEditModalBtn').onclick = () => {
      document.getElementById('editModalOverlay').classList.add('hidden');
      // Restore z-index when closing
      document.getElementById('editModalOverlay').style.zIndex = '200';
      showNavBar(); // Show nav bar when edit modal closes
    };
    
    // Edit modal overlay click to close
    document.getElementById('editModalOverlay').onclick = (e) => {
      if (e.target === document.getElementById('editModalOverlay')) {
        document.getElementById('editModalOverlay').classList.add('hidden');
        // Restore z-index when closing
        document.getElementById('editModalOverlay').style.zIndex = '200';
        showNavBar(); // Show nav bar when edit modal closes
      }
    };
    
    // Calendar functionality
    const calendarBtn = document.querySelector('.nav-btn[title="Calendar"]');
    const calendarWindow = document.getElementById('calendarWindow');
    const mainContent = document.querySelector('.floating-island');
    let currentCalendarDate = new Date();
    
    console.log('Calendar initialization:');
    console.log('Calendar button found:', !!calendarBtn);
    console.log('Calendar window found:', !!calendarWindow);
    
    // Done notes functionality
    const doneTabBtn = document.getElementById('doneTabBtn');
    const multiSelectActions = document.getElementById('multiSelectActions');
    let selectedDoneNotes = new Set();
    let isDoneTabActive = false;
    
    console.log('Done notes initialization:');
    console.log('Done tab button found:', !!doneTabBtn);
    console.log('Multi-select actions found:', !!multiSelectActions);
    
    // Done tab click handler
    doneTabBtn.onclick = () => {
      if (isDoneTabActive) {
        // Switch back to main notes
        isDoneTabActive = false;
        doneTabBtn.classList.remove('active');
        selectedDoneNotes.clear();
        updateDoneActions();
        // Hide multi-select elements in main view
        hideMultiSelectElements();
        renderNotes(); // Re-render main notes
      } else {
        // Switch to done notes
        isDoneTabActive = true;
        doneTabBtn.classList.add('active');
        renderDoneNotes();
        // Show multi-select elements in done view
        showMultiSelectElements();
      }
    };
    
    // Render done notes
    function renderDoneNotes() {
      const doneNotes = notes.filter(note => note.done);
      
      if (doneNotes.length === 0) {
        // Show empty state in main notes grid
        notesGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No completed notes yet</p>';
        return;
      }
      
      // Use the existing renderNotes function but filter for done notes only
      const filteredNotes = notes.filter(note => note.done);
      renderNotesToGrid(notesGrid, filteredNotes, true); // true = isDoneView
      
      // Show multi-select elements after rendering
      showMultiSelectElements();
    }
    
    // Helper function to render notes to a specific grid with multi-select support
    function renderNotesToGrid(gridElement, notesToRender, isDoneView = false) {
      gridElement.innerHTML = '';
      
      notesToRender.forEach(note => {
        const noteCard = document.createElement('div');
        noteCard.className = `note-card ${note.done ? 'done' : ''}`;
        noteCard.dataset.id = note.id;
        
        // Add checkbox for done notes in done view
        const checkboxHtml = isDoneView ? '<div class="checkbox"></div>' : '';
        
        noteCard.innerHTML = `
          ${checkboxHtml}
          <div class="note-title">${note.title || 'Untitled'}</div>
          <div class="note-text">${note.text}</div>
          <div class="note-meta">
            <span class="note-category">${note.category || 'Other'}</span>
            <span class="note-timeframe">${formatTimeframe(note)}</span>
          </div>
        `;
        
        // Click handler
        noteCard.onclick = (e) => {
          if (isDoneView && e.target.classList.contains('checkbox')) {
            e.stopPropagation();
            toggleNoteSelection(note.id);
          } else {
            openEditModal(note);
          }
        };
        
        gridElement.appendChild(noteCard);
      });
    }
    
    // Show multi-select elements (checkboxes and action buttons)
    function showMultiSelectElements() {
      // Show action buttons container
      const multiSelectActions = document.getElementById('multiSelectActions');
      if (multiSelectActions) multiSelectActions.classList.remove('hidden');
      
      // Show checkboxes on done notes
      const doneNotes = document.querySelectorAll('#notesGrid .note-card.done');
      doneNotes.forEach(noteCard => {
        if (!noteCard.querySelector('.checkbox')) {
          const checkbox = document.createElement('div');
          checkbox.className = 'checkbox';
          noteCard.appendChild(checkbox);
        }
      });
    }
    
    // Hide multi-select elements (checkboxes and action buttons)
    function hideMultiSelectElements() {
      // Hide action buttons container
      const multiSelectActions = document.getElementById('multiSelectActions');
      if (multiSelectActions) multiSelectActions.classList.add('hidden');
      
      // Remove checkboxes from all notes
      const allNotes = document.querySelectorAll('.note-card .checkbox');
      allNotes.forEach(checkbox => checkbox.remove());
    }
    
    // Toggle note selection
    function toggleNoteSelection(noteId) {
      const noteCard = document.querySelector(`.note-card[data-id="${noteId}"]`);
      if (selectedDoneNotes.has(noteId)) {
        selectedDoneNotes.delete(noteId);
        noteCard.classList.remove('selected');
      } else {
        selectedDoneNotes.add(noteId);
        noteCard.classList.add('selected');
      }
      updateDoneActions();
    }
    
    // Update done actions visibility
    function updateDoneActions() {
      const deleteSelectedBtn = document.getElementById('deleteSelectedDoneBtn');
      const selectAllBtn = document.getElementById('selectAllDoneBtn');
      
      if (selectedDoneNotes.size > 0) {
        deleteSelectedBtn.classList.remove('hidden');
        selectAllBtn.textContent = 'Deselect All';
      } else {
        deleteSelectedBtn.classList.add('hidden');
        selectAllBtn.textContent = 'Select All';
      }
    }
    
    // Select all done notes
    document.getElementById('selectAllDoneBtn').onclick = () => {
      const doneNotes = notes.filter(note => note.done);
      const doneCards = document.querySelectorAll('#notesGrid .note-card');
      
      if (selectedDoneNotes.size === doneNotes.length) {
        // Deselect all
        selectedDoneNotes.clear();
        doneCards.forEach(card => card.classList.remove('selected'));
      } else {
        // Select all
        doneNotes.forEach(note => selectedDoneNotes.add(note.id));
        doneCards.forEach(card => card.classList.add('selected'));
      }
      updateDoneActions();
    };
    
    // Delete selected done notes
    document.getElementById('deleteSelectedDoneBtn').onclick = () => {
      if (selectedDoneNotes.size === 0) return;
      
      if (confirm(`Are you sure you want to delete ${selectedDoneNotes.size} completed note(s)?`)) {
        notes = notes.filter(note => !selectedDoneNotes.has(note.id));
        saveNotes();
        selectedDoneNotes.clear();
        renderDoneNotes();
        updateDoneActions();
      }
    };
    
    // Settings functionality
    const settingsBtn = document.querySelector('.nav-btn.settings');
    const settingsModalOverlay = document.getElementById('settingsModalOverlay');
    
    console.log('Settings initialization:');
    console.log('Settings button found:', !!settingsBtn);
    console.log('Settings modal overlay found:', !!settingsModalOverlay);
    
    // Settings button click handler
    settingsBtn.onclick = () => {
      console.log('Settings button clicked');
      console.log('Current view - Calendar active:', calendarWindow.classList.contains('active'));
      
      // Ensure settings modal is accessible in both views
      settingsModalOverlay.classList.remove('hidden');
      
      // Update z-index for calendar view
      if (calendarWindow.classList.contains('active')) {
        settingsModalOverlay.style.zIndex = '2000';
        console.log('Settings modal z-index set for calendar view');
      } else {
        settingsModalOverlay.style.zIndex = '200';
        console.log('Settings modal z-index set for main view');
      }
    };
    
    // Settings modal close handlers
    document.getElementById('cancelSettingsBtn').onclick = () => {
      console.log('Settings modal cancelled');
      settingsModalOverlay.classList.add('hidden');
    };
    
    document.getElementById('saveSettingsBtn').onclick = () => {
      console.log('Settings saved');
      // Save settings logic here
      settingsModalOverlay.classList.add('hidden');
    };
    
    // Settings modal overlay click to close
    settingsModalOverlay.onclick = (e) => {
      if (e.target === settingsModalOverlay) {
        console.log('Settings modal closed via overlay click');
        settingsModalOverlay.classList.add('hidden');
      }
    };
    
    // Category management functionality
    const categorySettingsBtn = document.getElementById('categorySettingsBtn');
    const editCategorySettingsBtn = document.getElementById('editCategorySettingsBtn');
    const categoryModalOverlay = document.getElementById('categoryModalOverlay');
    
    console.log('Category management initialization:');
    console.log('Category settings button found:', !!categorySettingsBtn);
    console.log('Edit category settings button found:', !!editCategorySettingsBtn);
    console.log('Category modal overlay found:', !!categoryModalOverlay);
    
    // Category settings button handlers
    categorySettingsBtn.onclick = () => {
      console.log('Category settings button clicked');
      categoryModalOverlay.classList.remove('hidden');
      renderExistingCategories();
    };
    
    editCategorySettingsBtn.onclick = () => {
      console.log('Edit category settings button clicked');
      categoryModalOverlay.classList.remove('hidden');
      renderExistingCategories();
    };
    
    // Category modal close handler
    document.getElementById('cancelCategoryBtn').onclick = () => {
      categoryModalOverlay.classList.add('hidden');
    };
    
    // Add category functionality
    document.getElementById('addCategoryBtn').onclick = () => {
      const newCategoryInput = document.getElementById('newCategoryInput');
      const newCategory = newCategoryInput.value.trim();
      
      if (newCategory && !categories.has(newCategory)) {
        categories.add(newCategory);
        saveNotes(); // This also saves categories
        renderChips();
        renderCategories(); // Re-render categories in add/edit modals
        renderExistingCategories();
        newCategoryInput.value = '';
        console.log('Category added:', newCategory);
      }
    };
    
    // Render existing categories for management modal
    function renderExistingCategories() {
      const existingCategoriesContainer = document.getElementById('existingCategories');
      const categoriesArray = Array.from(categories);
      
      existingCategoriesContainer.innerHTML = categoriesArray.map(cat => `
        <div class="category-item">
          <span>${cat}</span>
          <button type="button" class="delete-btn" data-category="${cat}">Delete</button>
        </div>
      `).join('');
      
      // Add delete handlers
      existingCategoriesContainer.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = (e) => {
          const categoryToDelete = e.target.getAttribute('data-category');
          if (categoryToDelete && categoryToDelete !== 'Other') {
            categories.delete(categoryToDelete);
            saveNotes();
            renderChips();
            renderCategories(); // Re-render categories in add/edit modals
            renderExistingCategories();
            console.log('Category deleted:', categoryToDelete);
          }
        };
      });
    }
    
    // Done functionality
    document.getElementById('markDoneBtn').onclick = () => {
      const noteId = document.getElementById('editNoteModal').dataset.id;
      const note = notes.find(n => n.id === noteId);
      
      if (note) {
        note.done = !note.done;
        saveNotes();
        renderNotes();
        renderThisWeekCalendar();
        
        // Always refresh the week notes dropdown if it's currently showing
        const weekNotes = document.getElementById('thisWeekNotes');
        if (weekNotes && weekNotes.classList.contains('show')) {
          // Find the currently selected day and refresh its details
          const selectedDay = document.querySelector('.week-day.selected');
          if (selectedDay) {
            // Simulate re-clicking the selected day to refresh the dropdown
            selectedDay.click();
          }
          // If no specific day is selected, don't refresh - let the user click a day to see tasks
        }
        
        document.getElementById('editModalOverlay').classList.add('hidden');
        showNavBar(); // Show nav bar when edit modal closes
        console.log('Note marked as done:', note.done);
      }
    };
    
    // Delete functionality
    document.getElementById('deleteNoteBtn').onclick = () => {
      const noteId = document.getElementById('editNoteModal').dataset.id;
      const note = notes.find(n => n.id === noteId);
      
      if (note) {
        if (note.done) {
          // Only allow deletion if note is done
          const confirmed = confirm(`Are you sure you want to delete "${note.title}"? This action cannot be undone.`);
          
          if (confirmed) {
            const noteIndex = notes.findIndex(n => n.id === noteId);
            if (noteIndex !== -1) {
              notes.splice(noteIndex, 1);
              saveNotes();
              renderNotes();
              renderThisWeekCalendar();
              
              // Always refresh the week notes dropdown if it's currently showing
              const weekNotes = document.getElementById('thisWeekNotes');
              if (weekNotes && weekNotes.classList.contains('show')) {
                // Find the currently selected day and refresh its details
                const selectedDay = document.querySelector('.week-day.selected');
                if (selectedDay) {
                  // Simulate re-clicking the selected day to refresh the dropdown
                  selectedDay.click();
                }
                // If no specific day is selected, don't refresh - let the user click a day to see tasks
              }
              
              document.getElementById('editModalOverlay').classList.add('hidden');
              showNavBar(); // Show nav bar when edit modal closes
              console.log('Note deleted (was marked as done)');
            }
          }
        } else {
          // Show warning if trying to delete non-done note
          alert('You can only delete notes that are marked as done. Please mark this note as done first.');
          console.log('Delete blocked - note not marked as done');
        }
      }
    };
    
    // AI functionality
    const aiBtn = document.getElementById('headerAiBtn');
    const aiWindow = document.getElementById('aiWindow');
    
    console.log('AI initialization:');
    console.log('AI button found:', !!aiBtn);
    console.log('AI window found:', !!aiWindow);
    
    // AI button click handler
    aiBtn.onclick = () => {
      console.log('AI button clicked');
      console.log('Current AI window state:', aiWindow.classList.contains('active'));
      
      // If we're in AI view, go home
      if (aiWindow.classList.contains('active')) {
        console.log('Going home from AI view');
        
        // Hide AI window and show main content
        aiWindow.classList.remove('active');
        mainContent.style.display = 'block';
        
        // Show nav bar when returning to main content
        showNavBar();
        
        console.log('AI window deactivated');
        console.log('Main content shown:', mainContent.style.display);
      } else {
        // If we're in dashboard view, go to AI
        console.log('Going to AI from dashboard view');
        
        // Hide main content and show AI window
        mainContent.style.display = 'none';
        aiWindow.classList.add('active');
        
        // Hide nav bar and FAB when AI window is active
        hideNavBar();
        
        console.log('AI window activated');
        console.log('Main content hidden:', mainContent.style.display);
      }
    };
    
    // AI chat functionality
    const aiInput = document.getElementById('aiInput');
    const aiSendBtn = document.getElementById('aiSendBtn');
    const aiMessages = document.getElementById('aiMessages');
    
    function addUserMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message ai-user';
      messageDiv.innerHTML = `
        <div class="ai-avatar"></div>
        <div class="ai-text">
          <p>${text}</p>
        </div>
      `;
      aiMessages.appendChild(messageDiv);
      aiMessages.scrollTop = aiMessages.scrollHeight;
    }
    
    function addAssistantMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message ai-assistant';
      messageDiv.innerHTML = `
        <div class="ai-avatar"></div>
        <div class="ai-text">
          <p>${text}</p>
        </div>
      `;
      aiMessages.appendChild(messageDiv);
      aiMessages.scrollTop = aiMessages.scrollHeight;
    }
    
    // AI Configuration
    const AI_CONFIG = {
      // Doubao AI API configuration
      aiApiKey: 'e8d5af80-6e79-4fcc-a258-7594389f3167', // Your Doubao API key
      useExternalAI: true, // Set to true to use Doubao AI
      model: 'doubao-seed-1-6-flash-250615',
      apiEndpoint: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions'
    };
    
    async function handleAIChat(userMessage) {
      console.log('=== AI CHAT DEBUG ===');
      console.log('useExternalAI:', AI_CONFIG.useExternalAI);
      console.log('aiApiKey exists:', !!AI_CONFIG.aiApiKey);
      console.log('API Endpoint:', AI_CONFIG.apiEndpoint);
      console.log('Model:', AI_CONFIG.model);
      
      if (AI_CONFIG.useExternalAI && AI_CONFIG.aiApiKey) {
        // Use Doubao AI API with user's notes data
        console.log(' Using DOUBAN AI');
        try {
          addAssistantMessage(" Analyzing your notes and thinking...");
          
          // Prepare user's notes data for AI analysis
          const notesData = prepareNotesDataForAI();
          console.log('Sending notes data to AI:', notesData);
          
          const response = await fetch(AI_CONFIG.apiEndpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${AI_CONFIG.aiApiKey}`
            },
            body: JSON.stringify({
              model: AI_CONFIG.model,
              messages: [
                {
                  role: 'system',
                  content: `AI assistant for productivity. Access to ALL user notes data: titles, descriptions, importance levels, due dates, categories, completion status, duration, creation dates, term tags.

CRITICAL REQUIREMENTS:
 SHORT responses only (max 100 words)
 Use bullet points () frequently
 Be concise and actionable
 No lengthy explanations
 Focus on key insights only`
                },
                {
                  role: 'user',
                  content: `Here is my notes data: ${JSON.stringify(notesData, null, 2)}\n\nUser question: ${userMessage}`
                }
              ],
              max_tokens: 800,
              temperature: 0.7
            })
          });
          
          const data = await response.json();
          
          if (data.choices && data.choices[0] && data.choices[0].message) {
            console.log(' DOUBAN AI Response received');
            // Remove the "thinking" message and add the real response
            const messages = aiMessages.querySelectorAll('.ai-message');
            if (messages.length > 0) {
              messages[messages.length - 1].remove();
            }
            
            // Handle the response format with content and reasoning_content
            const messageContent = data.choices[0].message.content;
            const reasoningContent = data.choices[0].message.reasoning_content;
            
            // Validate and display the main content
            const validatedContent = validateAndFormatResponse(messageContent);
            addAssistantMessage(validatedContent);
            
            // If there's reasoning content, add it as a follow-up (also validated)
            if (reasoningContent && reasoningContent !== messageContent) {
              setTimeout(() => {
                const validatedReasoning = validateAndFormatResponse(reasoningContent);
                addAssistantMessage(` **Additional Insights:**\n\n${validatedReasoning}`);
              }, 1000);
            }
          } else {
            throw new Error('No response from AI service');
          }
        } catch (error) {
          console.error(' AI API Error:', error);
          console.log(' Falling back to LOCAL AI');
          // Remove the "thinking" message
          const messages = aiMessages.querySelectorAll('.ai-message');
          if (messages.length > 0) {
            messages[messages.length - 1].remove();
          }
          addAssistantMessage("I'm having trouble connecting to my AI brain right now. Let me give you a helpful response based on your question.");
          handleLocalAIResponse(userMessage);
        }
      } else {
        // Use local AI responses
        console.log(' Using LOCAL AI (no external config)');
        handleLocalAIResponse(userMessage);
      }
    }
    
    // Function to prepare notes data for AI analysis
    function prepareNotesDataForAI() {
      const today = new Date();
      const currentDate = today.toISOString().split('T')[0];
      
      // Process notes for AI analysis
      const processedNotes = notes.map(note => {
        let dueDate = null;
        let daysUntilDue = null;
        
        // Calculate due date and days until due
        if (note.timeframe === 'custom' && note.customDate) {
          dueDate = note.customDate;
          const dueDateObj = new Date(note.customDate);
          daysUntilDue = Math.ceil((dueDateObj - today) / (1000 * 60 * 60 * 24));
        } else if (note.timeframe && !isNaN(note.timeframe)) {
          const days = parseInt(note.timeframe);
          const dueDateObj = new Date(today.getTime() + (days * 24 * 60 * 60 * 1000));
          dueDate = dueDateObj.toISOString().split('T')[0];
          daysUntilDue = days;
        }
        
        return {
          id: note.id,
          title: note.title,
          text: note.text,
          categories: note.categories || [note.category || 'Other'],
          importance: note.importance || 'moderately',
          urgency: parseInt(note.urgency) || 3,
          done: note.done || false,
          dueDate: dueDate,
          daysUntilDue: daysUntilDue,
          isOverdue: daysUntilDue !== null && daysUntilDue < 0 && !note.done,
          termTags: note.termTags || [note.termTag || 'medium'],
          duration: note.duration || null,
          durationFormatted: note.duration ? formatDuration(note.duration) : null,
          createdAt: note.createdAt,
          timeframe: note.timeframe,
          customDate: note.customDate
        };
      });
      
      // Calculate summary statistics
      const totalNotes = processedNotes.length;
      const completedNotes = processedNotes.filter(note => note.done).length;
      const overdueNotes = processedNotes.filter(note => note.isOverdue).length;
      const highPriorityNotes = processedNotes.filter(note => note.importance >= 4 && !note.done).length;
      const todayNotes = processedNotes.filter(note => note.daysUntilDue === 0).length;
      const thisWeekNotes = processedNotes.filter(note => note.daysUntilDue >= 0 && note.daysUntilDue <= 7).length;
      
      // Group by categories
      const categoryStats = {};
      processedNotes.forEach(note => {
        note.categories.forEach(cat => {
          if (!categoryStats[cat]) {
            categoryStats[cat] = { total: 0, completed: 0, overdue: 0 };
          }
          categoryStats[cat].total++;
          if (note.done) categoryStats[cat].completed++;
          if (note.isOverdue) categoryStats[cat].overdue++;
        });
      });
      
      return {
        summary: {
          totalTasks: totalNotes,
          completedTasks: completedNotes,
          completionRate: totalNotes > 0 ? Math.round((completedNotes / totalNotes) * 100) : 0,
          overdueTasks: overdueNotes,
          highPriorityTasks: highPriorityNotes,
          todayTasks: todayNotes,
          thisWeekTasks: thisWeekNotes
        },
        categoryStats: categoryStats,
        notes: processedNotes,
        currentDate: currentDate
      };
    }
    
    function handleLocalAIResponse(userMessage) {
      console.log(' LOCAL AI Response triggered');
      const message = userMessage.toLowerCase();
      
      let response = '';
      
      // Smart habit suggestions based on user's notes
      if (message.includes('habit') || message.includes('routine')) {
        const userHabits = analyzeUserHabits();
        if (userHabits.length > 0) {
          response = ` Focus areas: ${userHabits.join(', ')}\n\n What habit to develop?\n I'll create a plan.`;
        } else {
          response = " Build better habits!\n\n What habit to develop?\n I'll create a plan.";
        }
      } else if (message.includes('productivity') || message.includes('efficient')) {
        response = " Productivity:\n\n Work smarter\n What area to improve?\n I'll analyze patterns.";
      } else if (message.includes('goal') || message.includes('target')) {
        response = " Goals:\n\n What's your main goal?\n I'll break it down\n Make it specific.";
      } else if (message.includes('motivation') || message.includes('motivated')) {
        response = " Motivation:\n\n Progress creates motivation\n What's holding you back?\n I'll create action plan.";
      } else if (message.includes('time') || message.includes('schedule')) {
        response = " Time management:\n\n Organize priorities\n Analyze schedule\n Focus on what matters.";
      } else if (message.includes('analyze') || message.includes('progress')) {
        analyzeUserProgress();
        return; // This function handles its own response
      } else if (message.includes('suggest') || message.includes('recommend')) {
        suggestImprovements();
        return; // This function handles its own response
      } else {
        response = " I help with:\n\n Habits & routines\n Productivity\n Goal setting\n Time management\n\nWhat to focus on?";
      }
      
      // Validate and display the response
      const validatedResponse = validateAndFormatResponse(response);
      addAssistantMessage(validatedResponse);
    }
    
    // Smart AI functions
    function analyzeUserHabits() {
      const userCategories = new Set();
      notes.forEach(note => {
        if (note.categories) {
          note.categories.forEach(cat => userCategories.add(cat));
        }
      });
      return Array.from(userCategories);
    }
    
    function analyzeUserProgress() {
      const totalNotes = notes.length;
      const completedNotes = notes.filter(note => note.done).length;
      const completionRate = totalNotes > 0 ? Math.round((completedNotes / totalNotes) * 100) : 0;
      
      let analysis = ` Progress Analysis:\n\n`;
      analysis += ` Total tasks: ${totalNotes}\n`;
      analysis += ` Completed: ${completedNotes}\n`;
      analysis += ` Completion rate: ${completionRate}%\n\n`;
      
      if (completionRate >= 80) {
        analysis += " Excellent progress!";
      } else if (completionRate >= 60) {
        analysis += " Good momentum!";
      } else if (completionRate >= 40) {
        analysis += " Making progress!";
      } else {
        analysis += " Start with small steps!";
      }
      
      const validatedAnalysis = validateAndFormatResponse(analysis);
      addAssistantMessage(validatedAnalysis);
    }
    
    function suggestImprovements() {
      const overdueNotes = notes.filter(note => {
        if (note.timeframe === 'custom' && note.customDate) {
          const dueDate = new Date(note.customDate);
          const today = new Date();
          return dueDate < today && !note.done;
        }
        return false;
      });
      
      const highPriorityNotes = notes.filter(note => 
        note.importance === 'very' && !note.done
      );
      
      let suggestions = " Smart Suggestions:\n\n";
      
      if (overdueNotes.length > 0) {
        suggestions += ` ${overdueNotes.length} overdue tasks\n`;
      }
      
      if (highPriorityNotes.length > 0) {
        suggestions += ` ${highPriorityNotes.length} very important tasks\n`;
      }
      
      if (notes.filter(n => !n.done).length > 10) {
        suggestions += ` ${notes.filter(n => !n.done).length} active tasks\n`;
      }
      
      suggestions += "\n Focus on progress!";
      
      const validatedSuggestions = validateAndFormatResponse(suggestions);
      addAssistantMessage(validatedSuggestions);
    }
    
    // Quick action handler
    function handleQuickAction(action) {
      switch(action) {
        case 'analyze':
          // Use AI to analyze progress with notes data
          handleAIChat("Analyze my progress and provide insights based on my notes data. Give me a detailed breakdown of my completion rates, overdue tasks, and areas for improvement.");
          break;
        case 'suggest':
          // Use AI to get personalized suggestions
          handleAIChat("Based on my notes data, provide personalized suggestions for improving my productivity and task management. Focus on actionable advice.");
          break;
        case 'habits':
          // Use AI to analyze habits from notes data
          handleAIChat("Analyze my notes data to identify patterns in my habits and routines. Provide suggestions for building better habits based on my current activities.");
          break;
        case 'planning':
          // Use AI for smart planning with notes data
          handleAIChat("Based on my notes data, give me a summary of what I need to do for: today, this week and long-term activities. Prioritize based on my actual tasks and deadlines.");
          break;
      }
    }
    
    // Demo function to show the AI response format
    function showPlanningResponse() {
      const demoResponse = {
        choices: [{
          message: {
            content: `### **Today's Activities**  
- **Identify Urgent Tasks**: List immediate tasks with deadlines (e.g., work assignments, errands, meetings).  
- **Prioritize**: Use a framework like Eisenhower Matrix to sort tasks by urgency and importance.  
- **Allocate Time**: Block specific time slots in your day to tackle each task, ensuring focus and efficiency.  

### **This Week's Activities**  
- **Weekly Planning**: Create a weekly schedule or to-do list.  
- **Set Priorities**: Group tasks by category (work, personal, health) and order them by importance.  
- **Daily Goal Alignment**: Break down weekly goals into daily actions to stay on track.  
- **Review and Adjust**: Check progress daily, adjusting the plan as needed to accommodate changes.  

### **Long-Term Activities**  
- **Define Goals**: Identify long-term objectives (e.g., career advancement, personal growth, financial milestones).  
- **Break into Steps**: Split each goal into smaller, actionable tasks with clear timelines.  
- **Regular Review**: Periodically assess progress, update timelines, and refine steps to stay aligned with your long-term vision.`,
            reasoning_content: "Got it, let's break down what you need to do for today, this week, and long-term. First, let's start with today's activities. Today, you should focus on immediate tasks. Identify the most pressing things you need to do, like completing urgent assignments, responding to important emails, or taking care of any time-sensitive chores. Then, for this week, you should outline your weekly goals. That could include planning out tasks, setting priorities, maybe scheduling time for different projects or responsibilities. For long-term activities, you need to think about bigger picture goals. This might involve setting career aspirations, personal development plans, saving for something, or working towards a larger life objective."
          }
        }]
      };
      
      // Simulate the AI response
      handleAIResponse(demoResponse);
    }
    
    // Function to handle AI responses in the new format
    function handleAIResponse(data) {
      if (data.choices && data.choices[0] && data.choices[0].message) {
        const messageContent = data.choices[0].message.content;
        const reasoningContent = data.choices[0].message.reasoning_content;
        
        // Display the main content
        addAssistantMessage(messageContent);
        
        // If there's reasoning content, add it as a follow-up
        if (reasoningContent && reasoningContent !== messageContent) {
          setTimeout(() => {
            addAssistantMessage(` **Additional Insights:**\n\n${reasoningContent}`);
          }, 1000);
        }
      }
    }
    
    // AI send button click handler
    aiSendBtn.onclick = () => {
      const message = aiInput.value.trim();
      if (message) {
        addUserMessage(message);
        aiInput.value = '';
        
        // Simulate AI thinking
        setTimeout(() => {
          handleAIChat(message);
        }, 1000);
      }
    };
    
    // Response validation and formatting function
    function validateAndFormatResponse(content) {
      console.log(' Validating AI response...');
      
      // Count words
      const wordCount = content.split(/\s+/).length;
      console.log('Word count:', wordCount);
      
      // Check for bullet points
      const hasBulletPoints = content.includes('') || content.includes('-') || content.includes('*');
      console.log('Has bullet points:', hasBulletPoints);
      
      // Check response length
      const isShort = wordCount <= 100;
      console.log('Is short (100 words):', isShort);
      
      // If response is too long, truncate it
      if (!isShort) {
        console.log(' Response too long, truncating...');
        const sentences = content.split(/[.!?]+/);
        let truncated = '';
        let currentWordCount = 0;
        
        for (let sentence of sentences) {
          const sentenceWords = sentence.split(/\s+/).length;
          if (currentWordCount + sentenceWords <= 100) {
            truncated += sentence + '. ';
            currentWordCount += sentenceWords;
          } else {
            break;
          }
        }
        content = truncated.trim();
        console.log(' Truncated to', content.split(/\s+/).length, 'words');
      }
      
      // Ensure bullet points are used and each on new line
      if (!hasBulletPoints) {
        console.log(' No bullet points found, adding formatting...');
        // Convert paragraphs to bullet points
        const lines = content.split('\n').filter(line => line.trim());
        if (lines.length > 1) {
          content = lines.map(line => ` ${line.trim()}`).join('\n');
        } else {
          content = ` ${content}`;
        }
      } else {
        // Ensure existing bullet points are on separate lines
        console.log(' Formatting existing bullet points...');
        // First, split by bullet points and ensure each is on its own line
        content = content
          .replace(/\s*/g, '\n ') // Ensure  starts new line
          .replace(/\n\s*\n/g, '\n') // Remove extra blank lines
          .replace(/^\s*\n/, '') // Remove leading blank line
          .trim();
        
        // If bullet points are still inline, force them to new lines
        if (content.includes('') && !content.includes('\n')) {
          content = content.replace(//g, '\n').replace(/^\s*\n/, '').trim();
        }
      }
      
      console.log(' Response validated and formatted');
      return content;
    }
    

    
    // AI input enter key handler
    aiInput.onkeypress = (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        aiSendBtn.click();
      }
    };
    
    // AI home button functionality
    const aiHomeBtn = document.getElementById('aiHomeBtn');
    aiHomeBtn.onclick = () => {
      console.log('AI home button clicked');
      
      // Hide AI window and show main content
      aiWindow.classList.remove('active');
      mainContent.style.display = 'block';
      
      // Restore nav island to normal state
      showNavBar();
      
      console.log('AI window deactivated');
      console.log('Main content shown:', mainContent.style.display);
    };
    
    // Calendar/Home button functionality
    calendarBtn.onclick = () => {
      console.log('Calendar/Home button clicked');
      console.log('Calendar button found:', !!calendarBtn);
      console.log('Calendar window found:', !!calendarWindow);
      console.log('Current calendar state:', calendarWindow.classList.contains('active'));
      
      // If we're in calendar view, go home
      if (calendarWindow.classList.contains('active')) {
        console.log('Going home from calendar view');
        
        // Hide calendar and show main content
        calendarWindow.classList.remove('active');
        mainContent.style.display = 'block';
        
        // Restore nav island to normal state using the proper function
        showNavBar();
        
        // Change back to calendar button
        calendarBtn.innerHTML = '<span style="color:#e7a7c7;"></span>';
        calendarBtn.title = 'Calendar';
        
        console.log('Calendar window deactivated');
        console.log('Main content shown:', mainContent.style.display);
        console.log('Calendar window active:', calendarWindow.classList.contains('active'));
        
        // Force show navbar when returning to home
        showNavBar();
      } else {
        // If we're in dashboard view, go to calendar
        console.log('Going to calendar from dashboard view');
        
        // Hide main content and show calendar (but keep nav island visible)
        mainContent.style.display = 'none';
        calendarWindow.classList.add('active');
        
        // Ensure nav island stays visible
        const navIsland = document.getElementById('navIsland');
        const fab = document.querySelector('.fab');
        
        if (navIsland) {
          navIsland.classList.remove('hidden');
          navIsland.style.zIndex = '1001';
        }
        
        if (fab) {
          fab.classList.remove('hidden');
          fab.style.zIndex = '1001';
        }
        

        
        // Change calendar button to home button
        calendarBtn.innerHTML = '<span style="color:#e7a7c7;"></span>';
        calendarBtn.title = 'Home';
        
        console.log('Calendar window activated');
        console.log('Main content hidden:', mainContent.style.display);
        console.log('Calendar window active:', calendarWindow.classList.contains('active'));
        
        renderCalendar();
        console.log('Calendar rendered');
      }
    };
    
    // Calendar navigation
    document.getElementById('prevMonthBtn').onclick = () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
    };
    
    document.getElementById('nextMonthBtn').onclick = () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
    };
    
    // Month/Year selector functionality
    const calendarTitle = document.getElementById('calendarTitle');
    const monthYearSelector = document.getElementById('monthYearSelector');
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const applyDateBtn = document.getElementById('applyDateBtn');
    const cancelDateBtn = document.getElementById('cancelDateBtn');
    const closeSelectorBtn = document.getElementById('closeSelectorBtn');
    
    // Make calendar title clickable
    calendarTitle.style.cursor = 'pointer';
    calendarTitle.onclick = () => {
      openMonthYearSelector();
    };
    
    // Open month/year selector
    function openMonthYearSelector() {
      // Populate year dropdown (current year  10 years)
      const currentYear = new Date().getFullYear();
      yearSelect.innerHTML = '';
      for (let year = currentYear - 10; year <= currentYear + 10; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentCalendarDate.getFullYear()) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      }
      
      // Populate month dropdown
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      monthSelect.innerHTML = '';
      monthNames.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        if (index === currentCalendarDate.getMonth()) {
          option.selected = true;
        }
        monthSelect.appendChild(option);
      });
      
      monthYearSelector.classList.remove('hidden');
    }
    
    // Apply selected month/year
    applyDateBtn.onclick = () => {
      const selectedYear = parseInt(yearSelect.value);
      const selectedMonth = parseInt(monthSelect.value);
      
      currentCalendarDate.setFullYear(selectedYear);
      currentCalendarDate.setMonth(selectedMonth);
      
      renderCalendar();
      monthYearSelector.classList.add('hidden');
    };
    
    // Cancel month/year selection
    cancelDateBtn.onclick = () => {
      monthYearSelector.classList.add('hidden');
    };
    
    // Close selector
    closeSelectorBtn.onclick = () => {
      monthYearSelector.classList.add('hidden');
    };
    
    // Close selector when clicking outside
    monthYearSelector.onclick = (e) => {
      if (e.target === monthYearSelector) {
        monthYearSelector.classList.add('hidden');
      }
    };
    
    // Calendar close button removed - now using home button
    
    // Render calendar
    function renderCalendar() {
      console.log('Rendering calendar...');
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      console.log('Calendar date:', year, month);
      
      // Update title
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                         'July', 'August', 'September', 'October', 'November', 'December'];
      const calendarTitle = document.getElementById('calendarTitle');
      console.log('Calendar title element found:', !!calendarTitle);
      if (calendarTitle) {
        calendarTitle.textContent = `${monthNames[month]} ${year}`;
        console.log('Calendar title set to:', calendarTitle.textContent);
      }
      
      const calendarGrid = document.getElementById('calendarGrid');
      console.log('Calendar grid element found:', !!calendarGrid);
      if (!calendarGrid) {
        console.error('Calendar grid not found!');
        return;
      }
      
      calendarGrid.innerHTML = '';
      console.log('Calendar grid cleared');
      
      // Add day headers
      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
      });
      console.log('Day headers added');
      
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());
      console.log('Calendar start date:', startDate);
      
      // Generate calendar days
      for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        // Set to midnight to avoid timezone issues
        currentDate.setHours(0, 0, 0, 0);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        
        // Add day number
        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = currentDate.getDate();
        dayElement.appendChild(dayNumber);
        
        // Add day content container
        const dayContent = document.createElement('div');
        dayContent.className = 'calendar-day-content';
        dayElement.appendChild(dayContent);
        
        // Check if this day has tasks (exclude done notes)
        const tasksForDay = getDueDatesForDate(currentDate).filter(task => !task.done);
        if (tasksForDay.length > 0) {
          console.log(`Day ${currentDate.getDate()} has ${tasksForDay.length} tasks`);
          tasksForDay.forEach(task => {
            const taskElement = document.createElement('div');
            taskElement.className = `calendar-task ${task.categories[0]?.toLowerCase() || 'other'}`;
            taskElement.textContent = task.title || task.text;
            
            // Add importance color
            const importance = task.importance || 'moderately';
            taskElement.setAttribute('data-importance', importance);
            
            // Apply importance-based styling
            const importanceColors = {
              'slightly': '#4caf50',
              'moderately': '#ff9800',
              'very': '#f44336'
            };
            taskElement.style.borderLeftColor = importanceColors[importance] || '#6C63FF';
            
            // Apply background color based on importance and dark mode
            const isDarkMode = document.body.classList.contains('dark-mode');
            const importanceBackgrounds = {
              'slightly': isDarkMode ? '#1b5e20' : '#e8f5e8',
              'moderately': isDarkMode ? '#e65100' : '#fff3e0',
              'very': isDarkMode ? '#b71c1c' : '#ffebee'
            };
            taskElement.style.backgroundColor = importanceBackgrounds[importance] || (isDarkMode ? '#424242' : '#f5f5f5');
            
            // Make task clickable to open edit modal
            taskElement.style.cursor = 'pointer';
            taskElement.onclick = (e) => {
              e.stopPropagation(); // Prevent day click when clicking task
              console.log('Calendar task clicked:', task);
              console.log('Task ID:', task.id);
              console.log('Task text:', task.text);
              console.log('Task importance:', task.importance);
              openEditModal(task);
            };
            
            dayContent.appendChild(taskElement);
          });
        }
        
        // Make entire day clickable to show details
        dayElement.style.cursor = 'pointer';
        
        // Single click to show details
        dayElement.onclick = () => {
          showDateDetails(currentDate, tasksForDay);
        };
        
        // Double click to add note with this date
        dayElement.ondblclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Add visual feedback
          dayElement.style.transform = 'scale(0.95)';
          setTimeout(() => {
            dayElement.style.transform = '';
          }, 150);
          
          addNoteWithDate(currentDate);
        };
        
        // Style based on whether it's current month
        if (currentDate.getMonth() !== month) {
          dayElement.style.opacity = '0.5';
        }
        
        // Add double-tap hint for current month days
        if (currentDate.getMonth() === month) {
          dayElement.title = 'Single tap to view details  Double tap to add note';
        }
        
        calendarGrid.appendChild(dayElement);
      }
      console.log('Calendar days generated');
    }
    
    // Show date details in bottom section with smooth animations
    function showDateDetails(date, tasks) {
      const bottomSection = document.getElementById('calendarBottomSection');
      const topSection = document.querySelector('.calendar-top-section');
      const selectedDateTitle = document.getElementById('selectedDateTitle');
      const selectedDateTasks = document.getElementById('selectedDateTasks');
      
      // Format date
      const dateStr = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      selectedDateTitle.textContent = dateStr;
      
      // Clear previous tasks
      selectedDateTasks.innerHTML = '';
      
      // Filter out done tasks for display
      const activeTasks = tasks.filter(task => !task.done);
      
      if (activeTasks.length === 0) {
        selectedDateTasks.innerHTML = '<p style="color: #666; text-align: center; margin: 1rem 0;">No active tasks for this date</p>';
      } else {
        activeTasks.forEach((task, index) => {
          const taskElement = document.createElement('div');
          taskElement.className = 'detail-task-item';
          taskElement.style.cssText = `
            background: #fff;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            border-left: 4px solid #6C63FF;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            transform: translateY(20px);
            opacity: 0;
            animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) ${0.1 * (index + 1)}s forwards;
          `;
          
          // Add importance color
          const importance = task.importance || 'moderately';
          const importanceColors = {
            'slightly': '#4caf50',
            'moderately': '#ff9800', 
            'very': '#f44336'
          };
          taskElement.style.borderLeftColor = importanceColors[importance] || '#6C63FF';
          
          taskElement.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #333;">${task.title || task.text}</div>
            <div style="font-size: 0.9rem; color: #666;">
              <span style="color: ${importanceColors[importance] || '#6C63FF'}; font-weight: 500;">${getImportanceText(importance)}</span>
              ${task.categories && task.categories.length > 0 ? `  ${task.categories[0]}` : ''}
            </div>
          `;
          
          taskElement.onclick = () => {
            openEditModal(task);
          };
          
          selectedDateTasks.appendChild(taskElement);
        });
      }
      
      // Always show bottom section and animate calendar (works on all screen sizes)
      bottomSection.classList.remove('hidden');
      
      // Animate calendar sections with smooth transitions
      topSection.classList.add('compact');
      bottomSection.classList.add('expanded');
      
      console.log('Calendar date selected:', date.toDateString());
      console.log('Tasks found:', tasks.length);
      console.log('Bottom section expanded, scrolling in 400ms...');
      
      // Smooth scroll to bottom section after animation starts
      setTimeout(() => {
        const calendarWindow = document.querySelector('.calendar-window');
        const bottomSection = document.getElementById('calendarBottomSection');
        if (calendarWindow && bottomSection) {
          // Calculate the position to scroll to
          const bottomSectionTop = bottomSection.offsetTop;
          
          // Try smooth scrolling first
          try {
            calendarWindow.scrollTo({
              top: bottomSectionTop - 50, // Offset by 50px for better visibility
              behavior: 'smooth'
            });
          } catch (e) {
            // Fallback to instant scroll if smooth scrolling fails
            calendarWindow.scrollTop = bottomSectionTop - 50;
          }
        }
      }, 400);
      

    }
    
    // Add note with specific date
    function addNoteWithDate(date) {
      console.log('Adding note for date:', date.toDateString());
      
      // Use the exact date selected (no adjustment needed)
      const selectedDate = new Date(date);
      
      // Format date for input field (YYYY-MM-DD)
      const dateStr = selectedDate.toISOString().split('T')[0];
      
      // Update modal z-index for calendar view
      updateModalZIndex();
      
      // Open the add note modal
      modalOverlay.classList.remove('hidden');
      
      // Set the custom date
      const customDateInput = document.getElementById('customDate');
      if (customDateInput) {
        customDateInput.value = dateStr;
      }
      
      // Focus on the note text area
      const noteTextArea = document.getElementById('noteText');
      if (noteTextArea) {
        noteTextArea.focus();
      }
      
      console.log('Modal opened with date:', dateStr);
      console.log('Modal z-index set for calendar view');
    }
    
    // Get due dates for a specific date
    function getDueDatesForDate(date) {
      // Ensure date is at midnight to avoid timezone issues
      const normalizedDate = new Date(date);
      normalizedDate.setHours(0, 0, 0, 0);
      const dateStr = normalizedDate.toISOString().split('T')[0];
      console.log('Checking tasks for date:', dateStr);
      console.log('Total notes:', notes.length);
      
      const tasksForDate = notes.filter(note => {
        if (note.timeframe === 'custom' && note.customDate) {
          // Subtract 1 day from custom dates for calendar display
          const customDate = new Date(note.customDate);
          customDate.setDate(customDate.getDate() - 1);
          const adjustedCustomDateStr = customDate.toISOString().split('T')[0];
          const matches = adjustedCustomDateStr === dateStr;
          if (matches) console.log('Found custom date task:', note.title || note.text);
          return matches;
        }
        // For other timeframes, calculate due date and add 1 day for calendar display
        const days = parseInt(note.timeframe);
        // Use the note's creation date as the base
        const createdAt = new Date(note.createdAt);
        // Normalize creation date to midnight
        createdAt.setHours(0, 0, 0, 0);
        const createdDateStr = createdAt.toISOString().split('T')[0];
        const createdDate = new Date(createdDateStr + 'T00:00:00');
        const dueDate = new Date(createdDate);
        dueDate.setDate(dueDate.getDate() + days + 1); // Add 1 day for calendar display
        const calculatedDateStr = dueDate.toISOString().split('T')[0];
        
        const matches = calculatedDateStr === dateStr;
        if (matches) console.log('Found regular timeframe task:', note.title || note.text);
        return matches;
      });
      
      console.log(`Found ${tasksForDate.length} tasks for ${dateStr}`);
      return tasksForDate;
    }


    
    // Scroll-based nav bar animations
    let lastScrollTop = 0;
    let scrollThreshold = 1; // Minimum scroll distance to trigger animation
    let isNavVisible = true;
    
    window.addEventListener('scroll', () => {
      const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollDifference = Math.abs(currentScrollTop - lastScrollTop);
      
      // Only trigger animation if scroll distance is significant
      if (scrollDifference > scrollThreshold) {
        if (currentScrollTop > lastScrollTop) {
          // Scrolling down - hide nav bar
          if (isNavVisible) {
            hideNavBar();
          }
        } else if (currentScrollTop < lastScrollTop) {
          // Scrolling up - show nav bar
          if (!isNavVisible) {
            showNavBar();
          }
        }
        lastScrollTop = currentScrollTop;
      }
    });
    
    function hideNavBar() {
      const navIsland = document.getElementById('navIsland');
      const fab = document.querySelector('.fab');
      
      if (navIsland) {
        navIsland.classList.add('hidden');
      }
      if (fab) {
        fab.classList.add('hidden');
      }
      
      isNavVisible = false;
    }
    
    function showNavBar() {
      const navIsland = document.getElementById('navIsland');
      const fab = document.querySelector('.fab');
      
      if (navIsland) {
        navIsland.classList.remove('hidden');
      }
      if (fab) {
        fab.classList.remove('hidden');
      }
      
      isNavVisible = true;
    }
    
    // Show reorder hint tooltip on first visit
    if (!localStorage.getItem('reorderHintShown')) {
      setTimeout(() => {
        const tooltip = document.createElement('div');
        tooltip.style.position = 'fixed';
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        tooltip.style.background = '#6C63FF';
        tooltip.style.color = 'white';
        tooltip.style.padding = '1rem';
        tooltip.style.borderRadius = '0.5rem';
        tooltip.style.zIndex = '10000';
        tooltip.style.boxShadow = '0 4px 16px rgba(108,99,255,0.3)';
        tooltip.style.fontSize = '0.9rem';
        tooltip.style.textAlign = 'center';
        tooltip.style.maxWidth = '300px';
        tooltip.innerHTML = `
          <div style="margin-bottom: 0.5rem;"> <strong>Pro Tip:</strong></div>
          <div>Long-press any filter chip to reorder them!</div>
          <button onclick="this.parentElement.remove()" style="margin-top: 0.5rem; padding: 0.3rem 0.8rem; background: white; color: #6C63FF; border: none; border-radius: 0.3rem; cursor: pointer;">Got it!</button>
        `;
        document.body.appendChild(tooltip);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          if (tooltip.parentElement) {
            tooltip.remove();
          }
        }, 5000);
        
        localStorage.setItem('reorderHintShown', 'true');
      }, 1000);
    }
    
    // Dark mode functionality

    
    // Load saved dark mode preference

    
    // Save settings functionality
    document.getElementById('saveSettingsBtn').onclick = () => {
      console.log('Settings saved');
      settingsModalOverlay.classList.add('hidden');
    };
    
    // Load saved settings
    function loadSettings() {
      // Settings loading logic can be added here if needed
    }
    
    // Load settings on startup
    loadSettings();
    

    
    // Mobile touch improvements
    function addMobileTouchSupport() {
      // Prevent double-tap zoom on buttons
      const buttons = document.querySelectorAll('button, [role="button"], .chip, .note-card');
      buttons.forEach(button => {
        button.addEventListener('touchstart', function(e) {
          // Prevent zoom on double tap
          e.preventDefault();
          this.style.transform = 'scale(0.98)';
        }, { passive: false });
        
        button.addEventListener('touchend', function(e) {
          this.style.transform = '';
        });
        
        // Add touch feedback
        button.addEventListener('touchstart', function() {
          this.style.opacity = '0.8';
        });
        
        button.addEventListener('touchend', function() {
          this.style.opacity = '';
        });
      });
      
      // Improve modal touch scrolling
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.addEventListener('touchstart', function(e) {
          // Allow scrolling within modal
          e.stopPropagation();
        });
      });
      
      // Prevent body scroll when modal is open
      const modalOverlays = document.querySelectorAll('.modal-overlay');
      modalOverlays.forEach(overlay => {
        overlay.addEventListener('touchmove', function(e) {
          if (this.classList.contains('hidden')) return;
          e.preventDefault();
        }, { passive: false });
      });
      
      // Fix touch scrolling for all scrollable elements
      const scrollableElements = document.querySelectorAll('.modal, .ai-content, .calendar-bottom-section, .notes-grid, .filter-chips');
      scrollableElements.forEach(element => {
        element.addEventListener('touchstart', function(e) {
          // Allow touch scrolling
          e.stopPropagation();
        });
        
        element.addEventListener('touchmove', function(e) {
          // Allow touch scrolling
          e.stopPropagation();
        });
      });
      
      // Prevent horizontal scrolling on body
      document.body.addEventListener('touchmove', function(e) {
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const startX = touch.clientX;
          const startY = touch.clientY;
          
          // If horizontal movement is greater than vertical, prevent default
          if (Math.abs(touch.clientX - startX) > Math.abs(touch.clientY - startY)) {
            e.preventDefault();
          }
        }
      }, { passive: false });
      
      // Fix for iOS Safari viewport issues
      function fixIOSViewport() {
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
          viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
        }
        
        // Fix for iOS Safari 100vh issue
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      
      // Run on load and resize
      fixIOSViewport();
      window.addEventListener('resize', fixIOSViewport);
      window.addEventListener('orientationchange', fixIOSViewport);
      
      // Fix for Android Chrome touch issues
      if (navigator.userAgent.includes('Android')) {
        document.body.style.touchAction = 'manipulation';
        
        // Prevent pull-to-refresh
        document.body.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1) {
            const touch = e.touches[0];
            if (touch.clientY <= 0) {
              e.preventDefault();
            }
          }
        }, { passive: false });
      }
      
      // Fix for iOS Safari momentum scrolling
      if (navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) {
        const scrollableElements = document.querySelectorAll('.modal, .ai-content, .calendar-bottom-section');
        scrollableElements.forEach(element => {
          element.style.webkitOverflowScrolling = 'touch';
        });
      }
    }
    
    // Initialize mobile touch support
    addMobileTouchSupport();
    
    // Optimize for tall displays (like 1264x2780)
    function optimizeForTallDisplay() {
      const isTallDisplay = window.innerHeight > 2000 && window.innerWidth <= 1400;
      
      if (isTallDisplay) {
        // Adjust viewport meta tag for better scaling
        const viewport = document.querySelector('meta[name="viewport"]');
        if (viewport) {
          viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        }
        
        // Optimize scrolling for tall displays
        document.body.style.minHeight = '100vh';
        document.body.style.display = 'flex';
        document.body.style.flexDirection = 'column';
        
        // Ensure floating island is properly centered
        const floatingIsland = document.querySelector('.floating-island');
        if (floatingIsland) {
          floatingIsland.style.marginTop = '3rem';
          floatingIsland.style.marginBottom = '2rem';
        }
        
        // Optimize modal positioning for tall displays
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
          modal.style.maxHeight = '80vh';
          modal.style.overflowY = 'auto';
        });
        
        console.log('Optimized for tall display:', window.innerWidth, 'x', window.innerHeight);
      }
    }
    
    // Run optimization on load and resize
    optimizeForTallDisplay();
    window.addEventListener('resize', optimizeForTallDisplay);
    

    
    // This Week Calendar Functions
    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day; // Start week on Sunday
      return new Date(d.setDate(diff));
    }
    
    function renderThisWeekCalendar() {
      const weekGrid = document.getElementById('thisWeekGrid');
      const weekTitle = document.getElementById('thisWeekTitle');
      
      if (!weekGrid) return;
      
      // Update title with week range
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      weekTitle.textContent = `This Week (${currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })})`;
      
      weekGrid.innerHTML = '';
      
      const dayNames = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(currentWeekStart);
        currentDate.setDate(currentWeekStart.getDate() + i);
        
        const dayElement = document.createElement('div');
        dayElement.className = 'week-day';
        dayElement.dataset.date = currentDate.toISOString().split('T')[0];
        
        // Check if it's today
        const today = new Date();
        const isToday = currentDate.toDateString() === today.toDateString();
        if (isToday) {
          dayElement.classList.add('today');
          // Auto-select today's date on page load
          dayElement.classList.add('selected');
        }
        
        dayElement.innerHTML = `
          <div class="week-day-number">${currentDate.getDate()}</div>
          <div class="week-day-name">${dayNames[i]}</div>
          <div class="week-day-content"></div>
        `;
        
        // Add tasks for this day as colored dots with counts
        const tasksForDay = getDueDatesForDate(currentDate).filter(task => !task.done);
        const dayContent = dayElement.querySelector('.week-day-content');
        
        // Group tasks by importance level
        const tasksByImportance = {
          'slightly': [],
          'moderately': [],
          'very': []
        };
        
        tasksForDay.forEach(task => {
          const importance = task.importance || 'moderately';
          if (tasksByImportance[importance]) {
            tasksByImportance[importance].push(task);
          }
        });
        
        // Create importance dots with counts
        const importanceColors = {
          'slightly': '#4caf50',
          'moderately': '#ff9800',
          'very': '#f44336'
        };
        
        Object.entries(tasksByImportance).forEach(([importance, tasks]) => {
          if (tasks.length > 0) {
            const dotElement = document.createElement('div');
            dotElement.className = 'importance-dot';
            dotElement.style.cssText = `
              width: 10px;
              height: 10px;
              border-radius: 50%;
              background-color: ${importanceColors[importance]};
              display: inline-flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 7px;
              font-weight: bold;
              margin: 0;
              padding: 0;
              cursor: pointer;
              transition: transform 0.2s ease;
              line-height: 1;
              text-align: center;
              overflow: visible;
              flex-shrink: 0;
              flex-grow: 0;
              min-width: 10px;
              min-height: 10px;
            `;
            dotElement.textContent = tasks.length;
            dotElement.title = `${tasks.length} ${importance} importance task${tasks.length > 1 ? 's' : ''}`;
            
            // Make dot clickable to show tasks
            dotElement.onclick = (e) => {
              e.stopPropagation();
              showWeekDayDetails(currentDate, tasks);
            };
            
            dayContent.appendChild(dotElement);
          }
        });
        
        // Make day clickable
        dayElement.onclick = () => {
          // Remove previous selection
          document.querySelectorAll('.week-day.selected').forEach(day => day.classList.remove('selected'));
          dayElement.classList.add('selected');
          
          // Show day details
          showWeekDayDetails(currentDate, tasksForDay);
        };
        
        // Double click to add note
        dayElement.ondblclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Add visual feedback
          dayElement.style.transform = 'scale(0.95)';
          setTimeout(() => {
            dayElement.style.transform = '';
          }, 150);
          
          addNoteWithDate(currentDate);
        };
        
        weekGrid.appendChild(dayElement);
      }
      
      // Auto-show today's notes on page load
      const today = new Date();
      const todayElement = document.querySelector('.week-day.today');
      if (todayElement) {
        const todayDate = new Date(todayElement.dataset.date);
        const todayTasks = getDueDatesForDate(todayDate);
        showWeekDayDetails(todayDate, todayTasks);
      }
    }
    
    function showWeekDayDetails(date, tasks) {
      const weekNotes = document.getElementById('thisWeekNotes');
      const activeTasks = tasks.filter(task => !task.done);
          
      if (activeTasks.length === 0) {
        weekNotes.innerHTML = '<p style="color: #666; text-align: center; margin: 1rem 0;">No active tasks for this date</p>';
          } else {
        // Define importance colors for task list
        const importanceColors = {
          'slightly': '#4caf50',
          'moderately': '#ff9800',
          'very': '#f44336'
        };
        
        weekNotes.innerHTML = activeTasks.map(task => {
          const importance = task.importance || 'moderately';
          const borderColor = importanceColors[importance];
          const backgroundColor = importance === 'slightly' ? '#e8f5e8' : 
                                importance === 'moderately' ? '#fff3e0' : '#ffebee';
          
          // Handle multiple categories display
          const taskCategories = task.categories || [task.category || 'Other'];
          const categoriesDisplay = taskCategories.length > 0 ? 
            taskCategories.map(cat => `<span class="week-category-tag">${cat}</span>`).join('') : 
            '<span class="week-category-tag">Other</span>';
          
          return `
            <div class="week-note-item" onclick="openEditModal(${JSON.stringify(task).replace(/"/g, '&quot;')})" 
                 style="border-left-color: ${borderColor}; background-color: ${backgroundColor};">
              <div style="font-weight: 600; margin-bottom: 0.3rem; color: #333;">${task.title || task.text}</div>
              <div style="font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                <span style="color: ${borderColor}; font-weight: 500;">${getImportanceText(importance)}</span>
                <div class="week-categories-container">
                  ${categoriesDisplay}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      weekNotes.classList.add('show');
    }
    
    // Week navigation
    document.getElementById('prevWeekBtn').onclick = () => {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
      renderThisWeekCalendar();
    };
    
    document.getElementById('nextWeekBtn').onclick = () => {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
      renderThisWeekCalendar();
    };
    
    // This Week title click handler
    document.getElementById('thisWeekTitle').onclick = () => {
      const weekNotes = document.getElementById('thisWeekNotes');
      const weekStart = new Date(currentWeekStart);
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      // Get all notes for the week
      const weekNotesList = [];
      for (let i = 0; i < 7; i++) {
        const currentDate = new Date(weekStart);
        currentDate.setDate(weekStart.getDate() + i);
        const tasksForDay = getDueDatesForDate(currentDate).filter(task => !task.done);
        weekNotesList.push(...tasksForDay);
      }
      
      // Remove duplicates
      const uniqueNotes = weekNotesList.filter((note, index, self) => 
        index === self.findIndex(n => n.id === note.id)
      );
      
      if (uniqueNotes.length === 0) {
        weekNotes.innerHTML = '<p style="color: #666; text-align: center; margin: 1rem 0;">No active tasks for this week</p>';
      } else {
        // Define importance colors for task list
        const importanceColors = {
          'slightly': '#4caf50',
          'moderately': '#ff9800',
          'very': '#f44336'
        };
        
        weekNotes.innerHTML = uniqueNotes.map(task => {
          const importance = task.importance || 'moderately';
          const borderColor = importanceColors[importance];
          const backgroundColor = importance === 'slightly' ? '#e8f5e8' : 
                                importance === 'moderately' ? '#fff3e0' : '#ffebee';
          
          // Handle multiple categories display
          const taskCategories = task.categories || [task.category || 'Other'];
          const categoriesDisplay = taskCategories.length > 0 ? 
            taskCategories.map(cat => `<span class="week-category-tag">${cat}</span>`).join('') : 
            '<span class="week-category-tag">Other</span>';
          
          return `
            <div class="week-note-item" onclick="openEditModal(${JSON.stringify(task).replace(/"/g, '&quot;')})" 
                 style="border-left-color: ${borderColor}; background-color: ${backgroundColor};">
              <div style="font-weight: 600; margin-bottom: 0.3rem; color: #333;">${task.title || task.text}</div>
              <div style="font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                <span style="color: ${borderColor}; font-weight: 500;">${getImportanceText(importance)}</span>
                <div class="week-categories-container">
                  ${categoriesDisplay}
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      weekNotes.classList.add('show');
    };
    
    // Search Icon Functions
    function initializeSearchIcon() {
      const searchIconBtn = document.getElementById('searchIconBtn');
      const searchExpanded = document.getElementById('searchExpanded');
      const searchInput = document.getElementById('searchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      
      searchIconBtn.onclick = () => {
        searchExpanded.classList.toggle('hidden');
        if (!searchExpanded.classList.contains('hidden')) {
          searchInput.focus();
          }
      };
      
      // Handle search input
      searchInput.addEventListener('input', () => {
        renderNotes();
        
        // Add visual indicator for search
        if (searchInput.value.trim()) {
          searchExpanded.classList.add('has-content');
          clearSearchBtn.style.display = 'block';
        } else {
          searchExpanded.classList.remove('has-content');
          clearSearchBtn.style.display = 'none';
        }
      });
      
      // Clear search functionality
      clearSearchBtn.addEventListener('click', () => {
        searchInput.value = '';
        searchInput.focus();
        renderNotes();
        searchExpanded.classList.remove('has-content');
        clearSearchBtn.style.display = 'none';
      });
      
      // Close search when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchIconBtn.contains(e.target) && !searchExpanded.contains(e.target)) {
          searchExpanded.classList.add('hidden');
        }
      });
    }
    
    // Category Functions
    function renderCategories() {
      const categoryRow = document.getElementById('categoryRow');
      const editCategoryRow = document.getElementById('editCategoryRow');
      
      if (!categoryRow || !editCategoryRow) return;
      
      // Get all categories from notes AND manually added categories
      const allCategories = new Set();
      
      // Add categories from existing notes
      notes.forEach(note => {
        if (note.categories) {
          note.categories.forEach(cat => allCategories.add(cat));
        } else if (note.category) {
          allCategories.add(note.category);
        }
      });
      
      // Add manually added categories from the categories Set
      categories.forEach(cat => allCategories.add(cat));
      
      // Add "Other" as default if no categories exist
      if (allCategories.size === 0) {
        allCategories.add('Other');
      }
      
      const categoriesArray = Array.from(allCategories);
      
      // Render for add modal
      categoryRow.innerHTML = categoriesArray.map(cat => 
        `<button type="button" class="category-chip" data-category="${cat}">${cat}</button>`
      ).join('');
      
      // Render for edit modal
      editCategoryRow.innerHTML = categoriesArray.map(cat => 
        `<button type="button" class="category-chip" data-category="${cat}">${cat}</button>`
      ).join('');
      
      // Add click handlers
      categoryRow.onclick = (e) => {
        if (e.target.classList.contains('category-chip')) {
          [...categoryRow.children].forEach(chip => chip.classList.remove('selected'));
          e.target.classList.add('selected');
    }
      };
      
      editCategoryRow.onclick = (e) => {
        if (e.target.classList.contains('category-chip')) {
          [...editCategoryRow.children].forEach(chip => chip.classList.remove('selected'));
          e.target.classList.add('selected');
        }
      };
    }
    

    
    // Keyboard navigation support
    function addKeyboardNavigation() {
      // Add keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + N to add new note
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          document.getElementById('openModalBtn').click();
        }
        
        // Ctrl/Cmd + F to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          document.getElementById('searchInput').focus();
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
          const openModals = document.querySelectorAll('.modal-overlay:not(.hidden)');
          if (openModals.length > 0) {
            openModals[0].classList.add('hidden');
          }
        }
        
        // Enter to submit forms
        if (e.key === 'Enter' && e.target.tagName === 'TEXTAREA') {
          const form = e.target.closest('form');
          if (form) {
            e.preventDefault();
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.click();
          }
        }
      });
      
      // Add focus management for modals
      const modals = document.querySelectorAll('.modal-overlay');
      modals.forEach(modal => {
        const focusableElements = modal.querySelectorAll('button, input, textarea, select, [tabindex]:not([tabindex="-1"])');
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];
        
        if (firstElement && lastElement) {
          // Trap focus within modal
          lastElement.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && !e.shiftKey) {
              e.preventDefault();
              firstElement.focus();
            }
          });
          
          firstElement.addEventListener('keydown', (e) => {
            if (e.key === 'Tab' && e.shiftKey) {
              e.preventDefault();
              lastElement.focus();
            }
          });
        }
      });
      
      console.log(' Keyboard navigation enabled');
    }
    
    // Initialize keyboard navigation
    addKeyboardNavigation();
    
    // Tutorial System
    class Tutorial {
      constructor() {
        this.currentStep = 0;
        this.steps = [
          {
            target: '#openModalBtn',
            title: 'Add Your First Task',
            description: 'Click the + button to create your first task or habit',
            position: 'top',
            highlight: true
          },
          {
            target: '.notes-grid',
            title: 'Your Tasks Will Appear Here',
            description: 'All your tasks and habits will be displayed in this grid',
            position: 'bottom',
            highlight: true
          },
          {
            target: '#searchIconBtn',
            title: 'Search Your Tasks',
            description: 'Quickly find any task using the search feature',
            position: 'left',
            highlight: true
          },
          {
            target: '#thisWeekCalendar',
            title: 'This Week View',
            description: 'See your tasks organized by day of the week',
            position: 'bottom',
            highlight: true
          },
          {
            target: '#navIsland',
            title: 'Navigation',
            description: 'Switch between different views: Calendar, Done tasks, and Settings',
            position: 'top',
            highlight: true
          },
          {
            target: '.filter-chips',
            title: 'Filter & Sort',
            description: 'Organize your tasks by categories and sort them as needed',
            position: 'bottom',
            highlight: true
          },
          {
            target: '#headerAiBtn',
            title: 'AI Assistant',
            description: 'Get help with task management and productivity tips',
            position: 'bottom',
            highlight: true
          },
          {
            target: '.floating-island',
            title: 'You\'re All Set!',
            description: 'Start creating tasks and building better habits. Good luck!',
            position: 'center',
            highlight: false
          }
        ];
        
        this.overlay = document.getElementById('tutorialOverlay');
        this.highlight = document.getElementById('tutorialHighlight');
        this.tooltip = document.getElementById('tutorialTooltip');
        

        this.title = document.getElementById('tutorialTitle');
        this.description = document.getElementById('tutorialDescription');
        this.progress = document.getElementById('tutorialProgress');
        this.nextBtn = document.getElementById('tutorialNext');
        this.skipBtn = document.getElementById('tutorialSkip');
        this.closeBtn = document.getElementById('tutorialClose');
        this.dontShowAgain = document.getElementById('dontShowAgain');
        
        this.bindEvents();
        this.checkFirstTime();
      }
      
      bindEvents() {
        this.nextBtn.addEventListener('click', () => this.nextStep());
        this.skipBtn.addEventListener('click', () => this.endTutorial());
        this.closeBtn.addEventListener('click', () => this.endTutorial());
        
        // Close on overlay click (but not on tooltip)
        this.overlay.addEventListener('click', (e) => {
          if (e.target === this.overlay) {
            this.endTutorial();
          }
        });
        
        // Handle scroll events to reposition tooltip
        window.addEventListener('scroll', () => {
          if (this.overlay.classList.contains('active')) {
            this.updatePosition();
          }
        });
        
        // Handle resize events
        window.addEventListener('resize', () => {
          if (this.overlay.classList.contains('active')) {
            this.updatePosition();
          }
        });
      }
      
      checkFirstTime() {
        const hasSeenTutorial = localStorage.getItem('ezHabitsTutorialSeen');
        if (!hasSeenTutorial) {
          setTimeout(() => this.startTutorial(), 1000);
        }
      }
      
      startTutorial() {
        this.currentStep = 0;
        this.showStep();
      }
      
      showStep() {
        const step = this.steps[this.currentStep];
        if (!step) return;
        
        this.title.textContent = step.title;
        this.description.textContent = step.description;
        this.progress.textContent = `${this.currentStep + 1}/${this.steps.length}`;
        
        // Update button text for last step
        if (this.currentStep === this.steps.length - 1) {
          this.nextBtn.textContent = 'Finish';
        } else {
          this.nextBtn.textContent = 'Next Step';
        }
        
        if (step.highlight && step.target !== '.floating-island') {
          const target = document.querySelector(step.target);
          if (target) {
            // Ensure target is visible by scrolling to it if needed
            this.ensureElementVisible(target);
            
            const rect = target.getBoundingClientRect();
            
            // Update highlight
            this.highlight.style.display = 'block';
            this.highlight.style.left = rect.left + 'px';
            this.highlight.style.top = rect.top + 'px';
            this.highlight.style.width = rect.width + 'px';
            this.highlight.style.height = rect.height + 'px';
            

            
            // Show overlay first, then position tooltip
            this.overlay.classList.add('active');
            
            // Small delay to ensure overlay is visible before positioning
            setTimeout(() => {
              this.positionTooltip(rect, step.position);
            }, 10);
          }
        } else {
          this.highlight.style.display = 'none';
          this.overlay.classList.add('active');
          
          // Center tooltip for final step
          setTimeout(() => {
            this.tooltip.style.left = '50%';
            this.tooltip.style.top = '50%';
            this.tooltip.style.transform = 'translate(-50%, -50%)';
            this.tooltip.classList.remove('top', 'bottom', 'left', 'right');
          }, 10);
        }
      }
      
      positionTooltip(rect, position) {
        const padding = 20;
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        const scrollY = window.pageYOffset || document.documentElement.scrollTop;
        
        // Reset classes and styles
        this.tooltip.classList.remove('top', 'bottom', 'left', 'right');
        this.tooltip.style.transform = '';
        
        // Get tooltip dimensions after it's visible
        this.tooltip.style.visibility = 'hidden';
        this.tooltip.style.display = 'block';
        const tooltipRect = this.tooltip.getBoundingClientRect();
        this.tooltip.style.visibility = 'visible';
        
        let left, top, arrowClass;
        
        switch (position) {
          case 'top':
            left = rect.left + (rect.width / 2);
            top = rect.top - tooltipRect.height - padding;
            arrowClass = 'top';
            break;
          case 'bottom':
            left = rect.left + (rect.width / 2);
            top = rect.bottom + padding;
            arrowClass = 'bottom';
            break;
          case 'left':
            left = rect.left - tooltipRect.width - padding;
            top = rect.top + (rect.height / 2);
            arrowClass = 'left';
            break;
          case 'right':
            left = rect.right + padding;
            top = rect.top + (rect.height / 2);
            arrowClass = 'right';
            break;
          default:
            left = rect.left + (rect.width / 2);
            top = rect.bottom + padding;
            arrowClass = 'bottom';
        }
        
        // Ensure tooltip stays within viewport (accounting for scroll)
        if (left < padding) left = padding;
        if (left + tooltipRect.width > viewportWidth - padding) {
          left = viewportWidth - tooltipRect.width - padding;
        }
        if (top < padding) top = padding;
        if (top + tooltipRect.height > viewportHeight - padding) {
          top = viewportHeight - tooltipRect.height - padding;
        }
        
        // Apply positioning
        this.tooltip.style.left = left + 'px';
        this.tooltip.style.top = top + 'px';
        this.tooltip.classList.add(arrowClass);
        
        // Calculate arrow position to point at the center of the highlighted element
        if (arrowClass === 'top' || arrowClass === 'bottom') {
          // For top/bottom arrows, position horizontally to point at element center
          const elementCenterX = rect.left + rect.width / 2;
          const tooltipLeft = left; // This is the final position after viewport adjustments
          
          // The arrow should point directly at the element center
          const arrowOffset = elementCenterX - tooltipLeft;
          
          // Ensure arrow stays within tooltip bounds with some padding
          const minOffset = 16;
          const maxOffset = tooltipRect.width - 16;
          const clampedOffset = Math.max(minOffset, Math.min(maxOffset, arrowOffset));
          this.tooltip.style.setProperty('--arrow-offset', clampedOffset + 'px');
        } else if (arrowClass === 'left' || arrowClass === 'right') {
          // For left/right arrows, position vertically to point at element center
          const elementCenterY = rect.top + rect.height / 2;
          const tooltipTop = top;
          // Calculate the distance from tooltip top edge to element center
          const arrowOffset = elementCenterY - tooltipTop;
          // Ensure arrow stays within tooltip bounds with some padding
          const minOffset = 16;
          const maxOffset = tooltipRect.height - 16;
          const clampedOffset = Math.max(minOffset, Math.min(maxOffset, arrowOffset));
          this.tooltip.style.setProperty('--arrow-offset', clampedOffset + 'px');
          

        }
      }
      
      updatePosition() {
        const step = this.steps[this.currentStep];
        if (!step || !step.highlight || step.target === '.floating-island') return;
        
        const target = document.querySelector(step.target);
        if (target) {
          const rect = target.getBoundingClientRect();
          
          // Update highlight position
          this.highlight.style.left = rect.left + 'px';
          this.highlight.style.top = rect.top + 'px';
          this.highlight.style.width = rect.width + 'px';
          this.highlight.style.height = rect.height + 'px';
          

          
          // Reposition tooltip
          this.positionTooltip(rect, step.position);
        }
      }
      
      ensureElementVisible(element) {
        const rect = element.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        const viewportWidth = window.innerWidth;
        
        // Check if element is fully visible
        const isFullyVisible = 
          rect.top >= 0 && 
          rect.bottom <= viewportHeight && 
          rect.left >= 0 && 
          rect.right <= viewportWidth;
        
        if (!isFullyVisible) {
          // Calculate scroll position to center the element
          const elementCenter = rect.top + rect.height / 2;
          const viewportCenter = viewportHeight / 2;
          const scrollOffset = elementCenter - viewportCenter;
          
          // Smooth scroll to element
          window.scrollTo({
            top: window.pageYOffset + scrollOffset,
            behavior: 'smooth'
          });
        }
      }
      
      nextStep() {
        this.currentStep++;
        if (this.currentStep >= this.steps.length) {
          this.endTutorial();
        } else {
          this.showStep();
        }
      }
      
      endTutorial() {
        this.overlay.classList.remove('active');
        if (this.dontShowAgain.checked) {
          localStorage.setItem('ezHabitsTutorialSeen', 'true');
        }
      }
      
      // Method to reset tutorial (for testing)
      resetTutorial() {
        localStorage.removeItem('ezHabitsTutorialSeen');
        this.startTutorial();
      }
    }
    
    // Initialize tutorial
    const tutorial = new Tutorial();
    
    // Make tutorial accessible for testing
    window.tutorial = tutorial;
    console.log(' Tutorial system loaded. Use tutorial.resetTutorial() to restart the tutorial.');
  </script>
</body>
</html>